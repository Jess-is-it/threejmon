{% extends "base.html" %}
{% block title %}Offline{% endblock %}
{% block header_title %}Offline{% endblock %}
{% block header_badge %}
  <span class="badge bg-secondary-lt text-secondary header-icon-badge"><i class="ti ti-cloud-off"></i></span>
{% endblock %}
{% block content %}

<div class="card">
  <div class="card-body">
    <ul class="nav nav-tabs" data-bs-toggle="tabs">
      <li class="nav-item">
        <a href="#offline-status" class="nav-link {% if active_tab == 'status' %}active{% endif %}" data-bs-toggle="tab">Offline Status</a>
      </li>
      <li class="nav-item">
        <a href="#offline-settings" class="nav-link {% if active_tab != 'status' %}active{% endif %}" data-bs-toggle="tab">Settings</a>
      </li>
    </ul>

    <div class="tab-content pt-4">
      <div class="tab-pane {% if active_tab == 'status' %}active{% endif %}" id="offline-status">
        <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-2">
          <div>
            <h4 class="mb-1">Offline Accounts</h4>
            <div class="text-muted small">
              Last poll: <span id="offline-last-check">{{ offline_state.last_check or 'n/a' }}</span> ·
              Mode: <span id="offline-mode">{{ settings.mode }}</span>
            </div>
            <div class="text-muted small">Minimum offline duration: <span id="offline-min">{{ settings.general.min_offline_value }} {{ settings.general.min_offline_unit }}(s)</span></div>
            <div class="text-muted small">
              Job last run: {{ offline_job.last_run_at_ph or 'n/a' }} · Last success: {{ offline_job.last_success_at_ph or 'n/a' }}
            </div>
            {% if offline_job.last_error %}
              <div class="text-danger small mt-1">Job error: {{ offline_job.last_error }}</div>
            {% endif %}
            {% if offline_state.radius_error %}
              <div class="text-danger small mt-1">Radius error: {{ offline_state.radius_error }}</div>
            {% endif %}
            {% if offline_state.router_errors and offline_state.router_errors|length %}
              <div class="text-danger small mt-1">Router errors: {{ offline_state.router_errors|join(" · ") }}</div>
            {% endif %}
          </div>
          <div class="d-flex gap-2 align-items-center">
            <span class="badge bg-secondary-lt" id="offline-count">Offline: 0</span>
            <span class="badge bg-azure-lt" id="offline-history-count">History: 0</span>
            <div class="dropdown">
              <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" id="offline-limit-button">Show: 100</button>
              <div class="dropdown-menu dropdown-menu-end" id="offline-limit-menu">
                <div class="dropdown-item offline-limit-row" data-limit="25">25</div>
                <div class="dropdown-item offline-limit-row" data-limit="50">50</div>
                <div class="dropdown-item offline-limit-row" data-limit="100">100</div>
                <div class="dropdown-item offline-limit-row" data-limit="200">200</div>
              </div>
            </div>
            <div class="dropdown">
              <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" id="offline-filter-button">Filter</button>
              <div class="dropdown-menu dropdown-menu-end p-2" style="min-width: 260px;" id="offline-filter-menu">
                <div class="small text-muted mb-2">Routers</div>
                <div id="offline-filter-routers" class="d-grid gap-1"></div>
                <div class="dropdown-divider my-2"></div>
                <button type="button" class="btn btn-sm btn-outline-secondary w-100" id="offline-filter-clear">Clear filters</button>
              </div>
            </div>
          </div>
        </div>

        <ul class="nav nav-tabs" data-bs-toggle="tabs">
          <li class="nav-item">
            <a href="#offline-current" class="nav-link active" data-bs-toggle="tab">Offline</a>
          </li>
          <li class="nav-item">
            <a href="#offline-history" class="nav-link" data-bs-toggle="tab">History</a>
          </li>
          <li class="nav-item ms-auto">
            <div class="px-2 py-2">
              <div class="input-icon">
                <input class="form-control form-control-sm" id="offline-status-search" type="text" placeholder="Search" autocomplete="off" />
                <span class="input-icon-addon">
                  <i class="ti ti-search"></i>
                </span>
              </div>
            </div>
          </li>
        </ul>

        <div class="tab-content pt-3">
          <div class="tab-pane active" id="offline-current">
            <div class="rto-table-shell">
              <div class="rto-table-wrap" id="offline-current-table">
                <table class="table table-vcenter rto-table">
                  <thead>
                    <tr>
                      <th class="rto-sort" data-table="current" data-sort-key="pppoe" aria-sort="none">PPPoE <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                      <th class="rto-sort" data-table="current" data-sort-key="router_name" aria-sort="none">Router <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                      <th class="rto-sort" data-table="current" data-sort-key="radius_status" aria-sort="none">Status <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                      <th class="rto-sort" data-table="current" data-sort-key="disabled" aria-sort="none">Disabled <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                      <th class="rto-sort" data-table="current" data-sort-key="profile" aria-sort="none">Profile <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                      <th class="rto-sort" data-table="current" data-sort-key="last_logged_out" aria-sort="none">Last Logged Out <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                      <th class="rto-sort" data-table="current" data-sort-key="offline_since" aria-sort="none">Offline Since <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    </tr>
                  </thead>
                  <tbody id="offline-current-body">
                    <tr><td colspan="7" class="text-muted">Loading…</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="rto-resize-handle" data-target="offline-current-table"></div>
            </div>
          </div>

          <div class="tab-pane" id="offline-history">
            <div class="rto-table-shell">
              <div class="rto-table-wrap" id="offline-history-table">
                <table class="table table-vcenter rto-table">
                  <thead>
                    <tr>
                      <th class="rto-sort" data-table="history" data-sort-key="pppoe" aria-sort="none">PPPoE <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                      <th class="rto-sort" data-table="history" data-sort-key="router_name" aria-sort="none">Router <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                      <th class="rto-sort" data-table="history" data-sort-key="mode" aria-sort="none">Mode <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                      <th class="rto-sort" data-table="history" data-sort-key="offline_started_at" aria-sort="none">Offline Since <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                      <th class="rto-sort" data-table="history" data-sort-key="offline_ended_at" aria-sort="none">Back Online <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                      <th class="rto-sort" data-table="history" data-sort-key="duration_seconds" aria-sort="none">Duration <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    </tr>
                  </thead>
                  <tbody id="offline-history-body">
                    <tr><td colspan="6" class="text-muted">Loading…</td></tr>
                  </tbody>
                </table>
              </div>
              <div class="rto-resize-handle" data-target="offline-history-table"></div>
              <div class="text-muted small mt-2">History shows accounts that were offline (past threshold) and later became active again.</div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane {% if active_tab != 'status' %}active{% endif %}" id="offline-settings">
        <div class="d-flex flex-wrap align-items-center justify-content-between mb-2 gap-2">
          <h4 class="mb-0">Offline Settings</h4>
          <span class="text-muted small">Uses routers configured in Settings → Usage.</span>
        </div>

        {% if message %}
          <div class="alert alert-info">{{ message }}</div>
        {% endif %}

        <ul class="nav nav-tabs" data-bs-toggle="tabs">
          <li class="nav-item">
            <a href="#offline-general" class="nav-link {% if settings_tab == 'general' %}active{% endif %}" data-bs-toggle="tab">General</a>
          </li>
          <li class="nav-item">
            <a href="#offline-routers" class="nav-link {% if settings_tab == 'routers' %}active{% endif %}" data-bs-toggle="tab">Routers</a>
          </li>
          <li class="nav-item">
            <a href="#offline-radius" class="nav-link {% if settings_tab == 'radius' %}active{% endif %}" data-bs-toggle="tab">Radius</a>
          </li>
        </ul>

        <div class="tab-content pt-4">
          <div class="tab-pane {% if settings_tab == 'general' %}active{% endif %}" id="offline-general">
            <form method="post" action="/settings/offline">
              <input type="hidden" name="active_tab" value="settings" />
              <input type="hidden" name="settings_tab" value="general" />
              <div class="card mb-3">
                <div class="card-body">
                  <h4 class="mb-3">General</h4>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="enabled" {% if settings.enabled %}checked{% endif %} />
                        <span class="form-check-label">Enable Offline Collector</span>
                      </label>
                      <div class="text-muted small mt-1">Builds an offline list based on the selected Mode and routers from Usage settings.</div>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Poll Interval (seconds)</label>
                      <input class="form-control" type="number" name="poll_interval_seconds" value="{{ settings.general.poll_interval_seconds }}" />
                      <div class="text-muted small mt-1">How often to refresh the offline accounts list.</div>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Minimum Offline Duration</label>
                      <div class="input-group">
                        <input class="form-control" type="number" name="min_offline_value" value="{{ settings.general.min_offline_value }}" min="0" />
                        <select class="form-select" name="min_offline_unit">
                          <option value="hour" {% if settings.general.min_offline_unit == 'hour' %}selected{% endif %}>Hour(s)</option>
                          <option value="day" {% if settings.general.min_offline_unit != 'hour' %}selected{% endif %}>Day(s)</option>
                        </select>
                      </div>
                      <div class="text-muted small mt-1">Accounts will appear in the Offline table only after being continuously offline for at least this long.</div>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">History Retention (days)</label>
                      <input class="form-control" type="number" name="history_retention_days" value="{{ settings.general.history_retention_days }}" min="1" />
                      <div class="text-muted small mt-1">How long to keep Offline History entries.</div>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Mode</label>
                      <select class="form-select" name="mode">
                        <option value="secrets" {% if settings.mode == 'secrets' %}selected{% endif %}>Mode 1: MikroTik PPPoE secrets vs active sessions</option>
                        <option value="radius" {% if settings.mode == 'radius' %}selected{% endif %}>Mode 2: MikroTik active sessions vs Radius server</option>
                      </select>
                      <div class="text-muted small mt-1">Mode 2 requires Radius settings (SSH) to be configured.</div>
                    </div>
                  </div>
                </div>
              </div>
              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Save General Settings</button>
                <a class="btn btn-outline-secondary" href="/settings/offline">Back to Status</a>
              </div>
            </form>
          </div>

          <div class="tab-pane {% if settings_tab == 'routers' %}active{% endif %}" id="offline-routers">
            <div class="alert alert-warning">
              <div class="d-flex align-items-start gap-2">
                <i class="ti ti-alert-triangle mt-1"></i>
                <div>
                  <div class="fw-semibold">Routers are managed in Settings → Usage</div>
                  <div class="small text-muted">This page reads the router list from Usage. To add/edit routers, use the Usage Routers tab.</div>
                  <a class="btn btn-sm btn-outline-danger mt-2" href="/settings/usage?tab=settings&settings_tab=routers#usage-routers">
                    Open Usage Routers
                  </a>
                </div>
              </div>
            </div>

            <div class="card">
              <div class="card-body">
                <h4 class="mb-3">Routers (from Usage)</h4>
                {% set routers = (usage_settings.mikrotik.routers or []) %}
                {% if routers and routers|length %}
                  <div class="table-responsive">
                    <table class="table table-vcenter">
                      <thead>
                        <tr>
                          <th>Name</th>
                          <th>Host</th>
                          <th>Port</th>
                          <th>User</th>
                          <th>Enabled</th>
                        </tr>
                      </thead>
                      <tbody>
                        {% for r in routers %}
                          <tr>
                            <td class="fw-semibold">{{ r.name or r.id }}</td>
                            <td class="text-muted">{{ r.host }}</td>
                            <td class="text-muted">{{ r.port or 8728 }}</td>
                            <td class="text-muted">{{ r.username }}</td>
                            <td>
                              {% if r.enabled is not defined or r.enabled %}
                                <span class="badge bg-green-lt">Yes</span>
                              {% else %}
                                <span class="badge bg-secondary-lt">No</span>
                              {% endif %}
                            </td>
                          </tr>
                        {% endfor %}
                      </tbody>
                    </table>
                  </div>
                {% else %}
                  <div class="text-muted">No routers configured yet. Add routers in Settings → Usage → Routers.</div>
                {% endif %}
              </div>
            </div>
          </div>

          <div class="tab-pane {% if settings_tab == 'radius' %}active{% endif %}" id="offline-radius">
            <ul class="nav nav-tabs" data-bs-toggle="tabs">
              <li class="nav-item">
                <a href="#offline-radius-accounts" class="nav-link {% if radius_tab == 'accounts' %}active{% endif %}" data-bs-toggle="tab">Accounts</a>
              </li>
              <li class="nav-item">
                <a href="#offline-radius-settings" class="nav-link {% if radius_tab != 'accounts' %}active{% endif %}" data-bs-toggle="tab">Settings</a>
              </li>
            </ul>

            <div class="tab-content pt-4">
              <div class="tab-pane {% if radius_tab == 'accounts' %}active{% endif %}" id="offline-radius-accounts">
                <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-2">
                  <div>
                    <h4 class="mb-1">Radius Accounts</h4>
                    <div class="text-muted small">
                      Read-only view. Uses the SSH connection and the mysql options from “List Accounts Command” to query account details.
                    </div>
                  </div>
                  <div class="d-flex gap-2 align-items-center">
                    <span class="badge bg-secondary-lt text-secondary" id="offline-radius-accounts-count">Accounts: 0</span>
                    <div class="dropdown">
                      <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" id="offline-radius-accounts-filter-button">Filter</button>
                      <div class="dropdown-menu dropdown-menu-end p-2" style="min-width: 260px;">
                        <div class="small text-muted mb-2">Status</div>
                        <select class="form-select form-select-sm" id="offline-radius-accounts-status">
                          <option value="all">All</option>
                          <option value="online">Online only</option>
                          <option value="offline">Offline only</option>
                          <option value="reject">Reject/Disabled</option>
                          <option value="active">Active (not Reject)</option>
                        </select>
                        <div class="dropdown-divider my-2"></div>
                        <button type="button" class="btn btn-sm btn-outline-secondary w-100" id="offline-radius-accounts-clear">Clear filters</button>
                      </div>
                    </div>
                    <div class="dropdown">
                      <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" id="offline-radius-accounts-limit-button">Show: 500</button>
                      <div class="dropdown-menu dropdown-menu-end" id="offline-radius-accounts-limit-menu">
                        <div class="dropdown-item offline-radius-accounts-limit-row" data-limit="200">200</div>
                        <div class="dropdown-item offline-radius-accounts-limit-row" data-limit="500">500</div>
                        <div class="dropdown-item offline-radius-accounts-limit-row" data-limit="1000">1000</div>
                        <div class="dropdown-item offline-radius-accounts-limit-row" data-limit="5000">5000</div>
                      </div>
                    </div>
                    <div class="input-icon">
                      <input class="form-control form-control-sm" id="offline-radius-accounts-search" type="text" placeholder="Search" autocomplete="off" />
                      <span class="input-icon-addon"><i class="ti ti-search"></i></span>
                    </div>
                  </div>
                </div>

                <div class="rto-table-shell">
                  <div class="rto-table-wrap" id="offline-radius-accounts-table">
                    <table class="table table-vcenter rto-table">
                      <thead>
                        <tr>
                          <th class="rto-sort" data-table="radius_accounts" data-sort-key="username" aria-sort="none">Username <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                          <th class="rto-sort" data-table="radius_accounts" data-sort-key="status" aria-sort="none">Status <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                          <th class="rto-sort" data-table="radius_accounts" data-sort-key="online" aria-sort="none">Online <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                          <th class="rto-sort" data-table="radius_accounts" data-sort-key="ip" aria-sort="none">IP <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                          <th class="rto-sort" data-table="radius_accounts" data-sort-key="nas_ip" aria-sort="none">NAS <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                          <th class="rto-sort" data-table="radius_accounts" data-sort-key="groups" aria-sort="none">Groups <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                          <th class="rto-sort" data-table="radius_accounts" data-sort-key="uptime_sec" aria-sort="none">Uptime <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                          <th class="rto-sort" data-table="radius_accounts" data-sort-key="online_since" aria-sort="none">Online Since <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                          <th class="rto-sort" data-table="radius_accounts" data-sort-key="last_start" aria-sort="none">Last Start <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                          <th class="rto-sort" data-table="radius_accounts" data-sort-key="last_stop" aria-sort="none">Last Stop <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                        </tr>
                      </thead>
                      <tbody id="offline-radius-accounts-body">
                        <tr><td colspan="10" class="text-muted">Click the Accounts tab to load data.</td></tr>
                      </tbody>
                    </table>
                  </div>
                  <div class="rto-resize-handle" data-target="#offline-radius-accounts-table" title="Drag to resize"></div>
                </div>

                <div class="alert alert-info mt-3">
                  <div class="d-flex gap-2 align-items-start">
                    <i class="ti ti-info-circle mt-1"></i>
                    <div>
                      <div class="fw-semibold">Managing Radius accounts</div>
                      <div class="small text-muted">
                        This is a read-only viewer. Adding/editing/disabling accounts from this portal is possible, but would require write access to Radius DB and an audited change workflow (roles, confirmations, and logs). Not implemented yet.
                      </div>
                    </div>
                  </div>
                </div>
              </div>

              <div class="tab-pane {% if radius_tab != 'accounts' %}active{% endif %}" id="offline-radius-settings">
                <form method="post" action="/settings/offline">
                  <input type="hidden" name="active_tab" value="settings" />
                  <input type="hidden" name="settings_tab" value="radius" />
                  <input type="hidden" name="radius_tab" value="settings" />
                  <div class="card mb-3">
                    <div class="card-body">
                      <h4 class="mb-3">Radius Server (SSH)</h4>
                      <div class="row g-3">
                        <div class="col-md-4">
                          <label class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="radius_enabled" {% if settings.radius.enabled %}checked{% endif %} />
                            <span class="form-check-label">Enable Radius Mode Source</span>
                          </label>
                          <div class="text-muted small mt-1">Used only when Mode 2 is selected.</div>
                        </div>
                        <div class="col-md-4">
                          <label class="form-label">Host</label>
                          <input class="form-control" type="text" name="radius_host" value="{{ settings.radius.ssh.host }}" placeholder="radius.example.local" />
                        </div>
                        <div class="col-md-4">
                          <label class="form-label">Port</label>
                          <input class="form-control" type="number" name="radius_port" value="{{ settings.radius.ssh.port }}" />
                        </div>
                        <div class="col-md-4">
                          <label class="form-label">User</label>
                          <input class="form-control" type="text" name="radius_user" value="{{ settings.radius.ssh.user }}" />
                        </div>
                        <div class="col-md-4">
                          <label class="form-label">Password</label>
                          <input class="form-control" type="password" name="radius_password" value="{{ settings.radius.ssh.password }}" />
                          <div class="text-muted small mt-1">Leave blank if using SSH key.</div>
                        </div>
                        <div class="col-md-4">
                          <label class="form-label">Use SSH Key</label>
                          <label class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" name="radius_use_key" {% if settings.radius.ssh.use_key %}checked{% endif %} />
                            <span class="form-check-label">Enable key authentication</span>
                          </label>
                        </div>
                        <div class="col-md-6">
                          <label class="form-label">Key Path</label>
                          <input class="form-control" type="text" name="radius_key_path" value="{{ settings.radius.ssh.key_path }}" placeholder="/data/id_rsa" />
                        </div>
                        <div class="col-12">
                          <label class="form-label">List Accounts Command</label>
                          <textarea class="form-control" name="radius_list_command" rows="3" placeholder="Example: mysql -N -e &quot;SELECT username,status FROM radcheck&quot;">{{ settings.radius.list_command }}</textarea>
                          <div class="text-muted small mt-1">
                            Output format: one account per line. Supported: <code>username,status</code> or <code>username|status</code> or <code>username status</code>.
                            <div class="mt-1">For the Accounts view, use a <code>mysql ... -e &quot;SQL&quot;</code> command so the portal can reuse the same mysql options for details queries.</div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                  <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-primary">Save Radius Settings</button>
                    <button type="submit" class="btn btn-outline-secondary" formaction="/settings/offline/test-radius">Test Radius</button>
                  </div>
                </form>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const escMap = { "&": "&amp;", "<": "&lt;", ">": "&gt;", "\"": "&quot;", "'": "&#39;" };
    const esc = (value) => String(value ?? "").replace(/[&<>"']/g, (c) => escMap[c] || c);

    const currentBody = document.getElementById("offline-current-body");
    const historyBody = document.getElementById("offline-history-body");
    const countEl = document.getElementById("offline-count");
    const historyCountEl = document.getElementById("offline-history-count");
    const lastCheckEl = document.getElementById("offline-last-check");
    const modeEl = document.getElementById("offline-mode");
    const minEl = document.getElementById("offline-min");

    const searchInput = document.getElementById("offline-status-search");
    const limitButton = document.getElementById("offline-limit-button");
    const limitRows = document.querySelectorAll(".offline-limit-row");
    const filterButton = document.getElementById("offline-filter-button");
    const filterRouters = document.getElementById("offline-filter-routers");
    const filterClear = document.getElementById("offline-filter-clear");

    const radiusAccountsBody = document.getElementById("offline-radius-accounts-body");
    const radiusAccountsCountEl = document.getElementById("offline-radius-accounts-count");
    const radiusAccountsSearchInput = document.getElementById("offline-radius-accounts-search");
    const radiusAccountsStatusSelect = document.getElementById("offline-radius-accounts-status");
    const radiusAccountsClearBtn = document.getElementById("offline-radius-accounts-clear");
    const radiusAccountsLimitButton = document.getElementById("offline-radius-accounts-limit-button");
    const radiusAccountsLimitRows = document.querySelectorAll(".offline-radius-accounts-limit-row");

    const sortStateKey = "offline_sort_state_v1";
    const searchStateKey = "offline_status_search_v1";
    const limitStateKey = "offline_status_limit_v1";
    const routerFilterKey = "offline_status_router_filters_v1";

    const numericKeys = new Set(["duration_seconds", "uptime_sec"]);
    const booleanKeys = new Set(["disabled", "online"]);

    let currentData = [];
    let historyData = [];
    let radiusAccountsData = [];
    let searchQuery = "";
    let showLimit = 100;
    let selectedRouters = [];
    let radiusAccountsSearch = "";
    let radiusAccountsStatus = "all";
    let radiusAccountsShowLimit = 500;
    let radiusAccountsLastFetchAt = 0;
    let radiusAccountsFetching = false;

    const radiusAccountsSearchKey = "offline_radius_accounts_search_v1";
    const radiusAccountsStatusKey = "offline_radius_accounts_status_v1";
    const radiusAccountsLimitKey = "offline_radius_accounts_limit_v1";

    function loadJson(key, fallback) {
      try {
        const raw = localStorage.getItem(key);
        if (!raw) return fallback;
        const parsed = JSON.parse(raw);
        return parsed ?? fallback;
      } catch {
        return fallback;
      }
    }

    function saveJson(key, value) {
      try { localStorage.setItem(key, JSON.stringify(value)); } catch {}
    }

    function loadSortState() {
      const parsed = loadJson(sortStateKey, {});
      return (parsed && typeof parsed === "object") ? parsed : {};
    }

    function saveSortState(state) { saveJson(sortStateKey, state); }
    let sortState = loadSortState();

    function getSort(table) {
      const s = sortState[table];
      if (!s || typeof s !== "object") return { key: "", dir: "" };
      return { key: String(s.key || ""), dir: String(s.dir || "") };
    }

    function setSort(table, key) {
      const current = getSort(table);
      let dir = "asc";
      if (current.key === key) dir = current.dir === "asc" ? "desc" : "asc";
      sortState = { ...sortState, [table]: { key, dir } };
      saveSortState(sortState);
      updateSortIndicators();
      renderAllTables();
    }

    function updateSortIndicators() {
      document.querySelectorAll("th.rto-sort[data-table]").forEach((th) => {
        const table = (th.dataset.table || "").trim();
        const key = (th.dataset.sortKey || "").trim();
        const indicator = th.querySelector(".rto-sort-indicator");
        const s = getSort(table);
        th.classList.remove("rto-sorted-asc", "rto-sorted-desc");
        th.setAttribute("aria-sort", "none");
        if (!table || !key || s.key !== key || !s.dir) {
          if (indicator) indicator.textContent = "";
          return;
        }
        th.classList.add(s.dir === "asc" ? "rto-sorted-asc" : "rto-sorted-desc");
        th.setAttribute("aria-sort", s.dir === "asc" ? "ascending" : "descending");
        if (indicator) indicator.textContent = s.dir === "asc" ? "▲" : "▼";
      });
    }

    function asString(value) { return String(value ?? "").toLowerCase(); }

    function sortRows(rows, tableKey) {
      const s = getSort(tableKey);
      if (!s.key || !s.dir) return rows;
      const dir = s.dir === "desc" ? -1 : 1;
      const key = s.key;
      const withIndex = rows.map((row, idx) => ({ row, idx }));
      withIndex.sort((a, b) => {
        const av = a.row?.[key];
        const bv = b.row?.[key];
        const aNull = av === null || av === undefined || av === "";
        const bNull = bv === null || bv === undefined || bv === "";
        if (aNull && bNull) return a.idx - b.idx;
        if (aNull) return 1;
        if (bNull) return -1;
        if (booleanKeys.has(key)) {
          const aa = av ? 1 : 0;
          const bb = bv ? 1 : 0;
          if (aa !== bb) return dir * (aa - bb);
          return a.idx - b.idx;
        }
        if (numericKeys.has(key)) {
          const aa = Number(av);
          const bb = Number(bv);
          const aNum = Number.isFinite(aa);
          const bNum = Number.isFinite(bb);
          if (aNum && bNum && aa !== bb) return dir * (aa - bb);
          if (aNum && !bNum) return -1;
          if (!aNum && bNum) return 1;
        }
        const aa = asString(av);
        const bb = asString(bv);
        const cmp = aa.localeCompare(bb);
        if (cmp !== 0) return dir * cmp;
        return a.idx - b.idx;
      });
      return withIndex.map((x) => x.row);
    }

    function updateLimitButton() {
      if (limitButton) limitButton.textContent = `Show: ${showLimit}`;
    }

    function updateFilterButton() {
      if (!filterButton) return;
      const count = selectedRouters.length;
      filterButton.textContent = count ? `Filter: ${count}` : "Filter";
    }

    function getRowRouterName(row) {
      return String(row?.router_name || row?.router_id || "").trim();
    }

    function rowMatchesRouters(row) {
      if (!selectedRouters.length) return true;
      const r = getRowRouterName(row);
      return selectedRouters.includes(r);
    }

    function rowMatchesSearch(row) {
      const q = (searchQuery || "").trim().toLowerCase();
      if (!q) return true;
      const hay = [row?.pppoe, row?.router_name, row?.router_id, row?.profile, row?.last_logged_out, row?.radius_status];
      return hay
        .filter((x) => x !== null && x !== undefined)
        .map((x) => String(x).toLowerCase())
        .some((x) => x.includes(q));
    }

    function filterRows(rows) {
      return (rows || []).filter((row) => rowMatchesRouters(row) && rowMatchesSearch(row));
    }

    function applyLimit(rows) {
      if (!showLimit || showLimit <= 0) return rows;
      return rows.slice(0, showLimit);
    }

    function uniqueRouters(rows) {
      const set = new Set();
      (rows || []).forEach((row) => {
        const name = getRowRouterName(row);
        if (name) set.add(name);
      });
      return Array.from(set).sort((a, b) => a.localeCompare(b));
    }

    function renderRouterFilterMenu() {
      if (!filterRouters) return;
      const routers = uniqueRouters([...currentData, ...historyData]);
      if (!routers.length) {
        filterRouters.innerHTML = '<div class="text-muted small">No routers yet.</div>';
        return;
      }
      filterRouters.innerHTML = routers
        .map((r) => {
          const checked = selectedRouters.includes(r) ? "checked" : "";
          return `
            <label class="form-check m-0">
              <input class="form-check-input offline-router-filter" type="checkbox" value="${esc(r)}" ${checked} />
              <span class="form-check-label">${esc(r)}</span>
            </label>
          `;
        })
        .join("");
    }

    function renderCurrentRow(row) {
      const disabled = row.disabled ? '<span class="badge bg-secondary-lt">Yes</span>' : '<span class="badge bg-green-lt">No</span>';
      const status = String(row.radius_status || "").trim();
      const statusCell = status ? `<span class="badge bg-secondary-lt">${esc(status)}</span>` : '<span class="text-muted small">—</span>';
      const since = row.offline_since ? esc(row.offline_since) : "—";
      return `
        <tr>
          <td class="fw-semibold">${esc(row.pppoe || "")}</td>
          <td class="text-muted">${esc(row.router_name || row.router_id || "")}</td>
          <td>${statusCell}</td>
          <td>${row.disabled === undefined ? '<span class="text-muted small">—</span>' : disabled}</td>
          <td class="text-muted">${esc(row.profile || "—")}</td>
          <td class="text-muted">${esc(row.last_logged_out || "—")}</td>
          <td class="text-muted">${since}</td>
        </tr>
      `;
    }

    function renderHistoryRow(row) {
      const mode = String(row.mode || "").trim() || "—";
      const duration = String(row.duration || "").trim() || "—";
      return `
        <tr>
          <td class="fw-semibold">${esc(row.pppoe || "")}</td>
          <td class="text-muted">${esc(row.router_name || row.router_id || "")}</td>
          <td><span class="badge bg-secondary-lt">${esc(mode)}</span></td>
          <td class="text-muted">${esc(row.offline_started || "—")}</td>
          <td class="text-muted">${esc(row.offline_ended || "—")}</td>
          <td class="text-muted">${esc(duration)}</td>
        </tr>
      `;
    }

    function renderAllTables() {
      if (currentBody) {
        const filtered = applyLimit(sortRows(filterRows(currentData), "current"));
        currentBody.innerHTML = filtered.length ? filtered.map(renderCurrentRow).join("") : '<tr><td colspan="7" class="text-muted">No offline accounts found.</td></tr>';
      }
      if (historyBody) {
        const filtered = applyLimit(sortRows(filterRows(historyData), "history"));
        historyBody.innerHTML = filtered.length ? filtered.map(renderHistoryRow).join("") : '<tr><td colspan="6" class="text-muted">No history yet.</td></tr>';
      }
      renderRadiusAccountsTable();
      updateSortIndicators();
    }

    function formatDurationShort(seconds) {
      const sec = Number(seconds);
      if (!Number.isFinite(sec) || sec <= 0) return "—";
      const s = Math.floor(sec);
      const d = Math.floor(s / 86400);
      const h = Math.floor((s % 86400) / 3600);
      const m = Math.floor((s % 3600) / 60);
      if (d > 0) return `${d}d ${h}h`;
      if (h > 0) return `${h}h ${m}m`;
      return `${m}m`;
    }

    function radiusRowMatchesSearch(row) {
      const q = (radiusAccountsSearch || "").trim().toLowerCase();
      if (!q) return true;
      return [
        row?.username,
        row?.status,
        row?.ip,
        row?.nas_ip,
        row?.groups,
        row?.online_since,
        row?.last_start,
        row?.last_stop,
      ]
        .filter((x) => x !== null && x !== undefined)
        .map((x) => String(x).toLowerCase())
        .some((x) => x.includes(q));
    }

    function radiusRowMatchesFilter(row) {
      const status = String(radiusAccountsStatus || "all").toLowerCase();
      if (status === "all") return true;
      if (status === "online") return !!row?.online;
      if (status === "offline") return !row?.online;
      if (status === "reject") return String(row?.status || "").toLowerCase() === "reject";
      if (status === "active") return String(row?.status || "").toLowerCase() !== "reject";
      return true;
    }

    function renderRadiusRow(row) {
      const status = String(row?.status || "").trim().toLowerCase();
      const statusBadge =
        status === "reject"
          ? '<span class="badge bg-red-lt">Reject</span>'
          : '<span class="badge bg-green-lt">Active</span>';
      const onlineBadge = row?.online ? '<span class="badge bg-green-lt">Online</span>' : '<span class="badge bg-secondary-lt">Offline</span>';
      const uptime = row?.online ? formatDurationShort(row?.uptime_sec) : "—";
      return `
        <tr>
          <td class="fw-semibold">${esc(row?.username || "")}</td>
          <td>${statusBadge}</td>
          <td>${onlineBadge}</td>
          <td class="text-muted">${esc(row?.ip || "—")}</td>
          <td class="text-muted">${esc(row?.nas_ip || "—")}</td>
          <td class="text-muted">${esc(row?.groups || "—")}</td>
          <td class="text-muted">${esc(uptime)}</td>
          <td class="text-muted">${esc(row?.online_since || "—")}</td>
          <td class="text-muted">${esc(row?.last_start || "—")}</td>
          <td class="text-muted">${esc(row?.last_stop || "—")}</td>
        </tr>
      `;
    }

    function renderRadiusAccountsTable() {
      if (!radiusAccountsBody) return;
      const filtered = radiusAccountsData
        .filter((row) => radiusRowMatchesFilter(row) && radiusRowMatchesSearch(row));
      const sorted = sortRows(filtered, "radius_accounts");
      const limited = radiusAccountsShowLimit > 0 ? sorted.slice(0, radiusAccountsShowLimit) : sorted;
      radiusAccountsBody.innerHTML = limited.length
        ? limited.map(renderRadiusRow).join("")
        : '<tr><td colspan="10" class="text-muted">No accounts found.</td></tr>';
      if (radiusAccountsCountEl) radiusAccountsCountEl.textContent = `Accounts: ${filtered.length}`;
      if (radiusAccountsLimitButton) radiusAccountsLimitButton.textContent = `Show: ${radiusAccountsShowLimit}`;
    }

    function initFromStorage() {
      searchQuery = String(loadJson(searchStateKey, "") || "");
      showLimit = Number(loadJson(limitStateKey, 100));
      if (!Number.isFinite(showLimit) || showLimit <= 0) showLimit = 100;
      selectedRouters = loadJson(routerFilterKey, []);
      if (!Array.isArray(selectedRouters)) selectedRouters = [];
      if (searchInput) searchInput.value = searchQuery;
      updateLimitButton();
      updateFilterButton();

      radiusAccountsSearch = String(loadJson(radiusAccountsSearchKey, "") || "");
      radiusAccountsStatus = String(loadJson(radiusAccountsStatusKey, "all") || "all");
      radiusAccountsShowLimit = Number(loadJson(radiusAccountsLimitKey, 500));
      if (!Number.isFinite(radiusAccountsShowLimit) || radiusAccountsShowLimit <= 0) radiusAccountsShowLimit = 500;
      if (radiusAccountsSearchInput) radiusAccountsSearchInput.value = radiusAccountsSearch;
      if (radiusAccountsStatusSelect) radiusAccountsStatusSelect.value = radiusAccountsStatus;
      if (radiusAccountsLimitButton) radiusAccountsLimitButton.textContent = `Show: ${radiusAccountsShowLimit}`;
    }

    async function refresh() {
      try {
        const res = await fetch("/offline/summary", { headers: { "Accept": "application/json" } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        const counts = data.counts || {};
        if (countEl) countEl.textContent = `Offline: ${counts.offline || 0}`;
        if (lastCheckEl) lastCheckEl.textContent = data.last_check || "n/a";
        if (modeEl) modeEl.textContent = data.mode || "secrets";
        const minMinutes = Number(data.min_offline_minutes || 0) || 0;
        if (minEl && minMinutes) {
          const days = minMinutes >= 1440 ? (minMinutes / 1440) : null;
          const hours = minMinutes >= 60 ? (minMinutes / 60) : null;
          minEl.textContent = days && Number.isFinite(days) && days >= 1 ? `${days} day(s)` : (hours && Number.isFinite(hours) ? `${hours} hour(s)` : `${minMinutes} min`);
        }
        currentData = Array.isArray(data.rows) ? data.rows : [];
        renderRouterFilterMenu();
        renderAllTables();
      } catch (err) {
        if (currentBody) currentBody.innerHTML = '<tr><td colspan="7" class="text-danger">Failed to load offline summary.</td></tr>';
      }
    }

    async function refreshHistory() {
      try {
        const res = await fetch("/offline/history?days=30&limit=500", { headers: { "Accept": "application/json" } });
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const data = await res.json();
        if (historyCountEl) historyCountEl.textContent = `History: ${data.count || 0}`;
        historyData = Array.isArray(data.rows) ? data.rows : [];
        renderRouterFilterMenu();
        renderAllTables();
      } catch (err) {
        if (historyBody) historyBody.innerHTML = '<tr><td colspan="6" class="text-danger">Failed to load offline history.</td></tr>';
      }
    }

    function isRadiusAccountsTabActive() {
      const pane = document.getElementById("offline-radius-accounts");
      if (!pane) return false;
      return pane.classList.contains("active") || pane.classList.contains("show");
    }

    async function refreshRadiusAccounts(force = false) {
      if (!radiusAccountsBody) return;
      if (!isRadiusAccountsTabActive()) return;
      const now = Date.now();
      if (!force && radiusAccountsLastFetchAt && now - radiusAccountsLastFetchAt < 60_000) return;
      if (radiusAccountsFetching) return;
      radiusAccountsFetching = true;
      try {
        radiusAccountsBody.innerHTML = '<tr><td colspan="10" class="text-muted">Loading…</td></tr>';
        const res = await fetch("/offline/radius/accounts?limit=50000", { headers: { "Accept": "application/json" } });
        if (!res.ok) {
          const data = await res.json().catch(() => ({}));
          const msg = data?.error ? String(data.error) : `HTTP ${res.status}`;
          throw new Error(msg);
        }
        const data = await res.json();
        radiusAccountsData = Array.isArray(data.rows) ? data.rows : [];
        radiusAccountsLastFetchAt = now;
        renderRadiusAccountsTable();
      } catch (err) {
        radiusAccountsData = [];
        if (radiusAccountsBody) radiusAccountsBody.innerHTML = `<tr><td colspan="10" class="text-danger">Failed to load radius accounts: ${esc(err?.message || err || 'unknown error')}</td></tr>`;
        if (radiusAccountsCountEl) radiusAccountsCountEl.textContent = "Accounts: 0";
      } finally {
        radiusAccountsFetching = false;
      }
    }

    document.addEventListener("click", (event) => {
      const th = event.target.closest("th.rto-sort");
      if (!th) return;
      const table = (th.dataset.table || "").trim();
      const key = (th.dataset.sortKey || "").trim();
      if (!table || !key) return;
      setSort(table, key);
    });

    if (searchInput) {
      let timer = null;
      const apply = () => {
        saveJson(searchStateKey, searchQuery);
        renderAllTables();
      };
      searchInput.addEventListener("input", () => {
        searchQuery = searchInput.value || "";
        if (timer) window.clearTimeout(timer);
        timer = window.setTimeout(apply, 150);
      });
    }

    limitRows.forEach((row) => {
      row.addEventListener("click", () => {
        const n = Number(row.dataset.limit || "100");
        if (!Number.isFinite(n) || n <= 0) return;
        showLimit = n;
        saveJson(limitStateKey, showLimit);
        updateLimitButton();
        renderAllTables();
      });
    });

    if (filterRouters) {
      filterRouters.addEventListener("change", (event) => {
        const box = event.target.closest(".offline-router-filter");
        if (!box) return;
        const v = String(box.value || "").trim();
        if (!v) return;
        const next = new Set(selectedRouters);
        if (box.checked) next.add(v);
        else next.delete(v);
        selectedRouters = Array.from(next);
        saveJson(routerFilterKey, selectedRouters);
        updateFilterButton();
        renderAllTables();
      });
    }
    if (filterClear) {
      filterClear.addEventListener("click", (event) => {
        event.preventDefault();
        selectedRouters = [];
        saveJson(routerFilterKey, selectedRouters);
        updateFilterButton();
        renderRouterFilterMenu();
        renderAllTables();
      });
    }

    if (radiusAccountsSearchInput) {
      let timer = null;
      const apply = () => {
        saveJson(radiusAccountsSearchKey, radiusAccountsSearch);
        renderRadiusAccountsTable();
      };
      radiusAccountsSearchInput.addEventListener("input", () => {
        radiusAccountsSearch = radiusAccountsSearchInput.value || "";
        if (timer) window.clearTimeout(timer);
        timer = window.setTimeout(apply, 150);
      });
    }
    if (radiusAccountsStatusSelect) {
      radiusAccountsStatusSelect.addEventListener("change", () => {
        radiusAccountsStatus = radiusAccountsStatusSelect.value || "all";
        saveJson(radiusAccountsStatusKey, radiusAccountsStatus);
        renderRadiusAccountsTable();
      });
    }
    if (radiusAccountsClearBtn) {
      radiusAccountsClearBtn.addEventListener("click", (event) => {
        event.preventDefault();
        radiusAccountsSearch = "";
        radiusAccountsStatus = "all";
        saveJson(radiusAccountsSearchKey, radiusAccountsSearch);
        saveJson(radiusAccountsStatusKey, radiusAccountsStatus);
        if (radiusAccountsSearchInput) radiusAccountsSearchInput.value = "";
        if (radiusAccountsStatusSelect) radiusAccountsStatusSelect.value = "all";
        renderRadiusAccountsTable();
      });
    }
    radiusAccountsLimitRows.forEach((row) => {
      row.addEventListener("click", () => {
        const n = Number(row.dataset.limit || "500");
        if (!Number.isFinite(n) || n <= 0) return;
        radiusAccountsShowLimit = n;
        saveJson(radiusAccountsLimitKey, radiusAccountsShowLimit);
        if (radiusAccountsLimitButton) radiusAccountsLimitButton.textContent = `Show: ${radiusAccountsShowLimit}`;
        renderRadiusAccountsTable();
      });
    });

    document.querySelectorAll('a[data-bs-toggle="tab"][href="#offline-radius-accounts"]').forEach((tab) => {
      tab.addEventListener("shown.bs.tab", () => refreshRadiusAccounts(true));
    });

    // Resize table (vertical) like Optical/Usage.
    document.querySelectorAll(".rto-table-wrap").forEach((wrap) => {
      const stored = localStorage.getItem(`offline_${wrap.id}_height`);
      if (stored) wrap.style.height = `${stored}px`;
    });
    document.querySelectorAll(".rto-resize-handle").forEach((handle) => {
      let startY = 0;
      let startHeight = 0;
      const targetSel = String(handle.dataset.target || "");
      const targetId = targetSel.replace(/^#/, "").trim();
      const target = targetId ? document.getElementById(targetId) : null;
      if (!target) return;
      const onMouseMove = (event) => {
        const delta = event.clientY - startY;
        const height = Math.max(startHeight + delta, 260);
        target.style.height = `${height}px`;
      };
      const onMouseUp = () => {
        document.removeEventListener("mousemove", onMouseMove);
        document.removeEventListener("mouseup", onMouseUp);
        localStorage.setItem(`offline_${target.id}_height`, parseInt(target.style.height || "0", 10));
      };
      handle.addEventListener("mousedown", (event) => {
        startY = event.clientY;
        startHeight = target.getBoundingClientRect().height;
        document.addEventListener("mousemove", onMouseMove);
        document.addEventListener("mouseup", onMouseUp);
      });
    });

    initFromStorage();
    refresh();
    refreshHistory();
    refreshRadiusAccounts();
    setInterval(refresh, 5000);
    setInterval(refreshHistory, 15000);
    setInterval(() => refreshRadiusAccounts(false), 60000);
  });
</script>

{% endblock %}
