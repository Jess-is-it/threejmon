{% extends "base.html" %}
{% block title %}Accounts Ping{% endblock %}
{% block header_title %}Accounts Ping{% endblock %}
{% block header_badge %}
  <span class="badge bg-indigo-lt text-indigo header-icon-badge"><i class="ti ti-wifi"></i></span>
{% endblock %}
{% block content %}
{% if message %}
  <div class="alert alert-info">{{ message }}</div>
{% endif %}

<div class="card">
  <div class="card-body">
    <ul class="nav nav-tabs" data-bs-toggle="tabs">
      <li class="nav-item">
        <a href="#accounts-ping-status" class="nav-link {% if active_tab == 'status' %}active{% endif %}" data-bs-toggle="tab">Status</a>
      </li>
      <li class="nav-item">
        <a href="#accounts-ping-settings" class="nav-link {% if active_tab != 'status' %}active{% endif %}" data-bs-toggle="tab">Settings</a>
      </li>
    </ul>

    <div class="tab-content pt-4">
      <div class="tab-pane {% if active_tab == 'status' %}active{% endif %}" id="accounts-ping-status">
        <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-2">
          <div>
            <h4 class="mb-1">Accounts Ping <span class="badge bg-azure-lt" id="accounts-ping-status-window">{{ accounts_ping_status.window_label }}</span></h4>
            <div class="text-muted small">
              Last run: {{ accounts_ping_job.last_run_at_ph or 'n/a' }} · Last success: {{ accounts_ping_job.last_success_at_ph or 'n/a' }}
            </div>
          </div>
          <div class="d-flex gap-2 align-items-center flex-wrap">
            <span class="badge bg-blue-lt">Total: {{ accounts_ping_status.total }}</span>
            <span class="badge bg-red-lt">Issues: {{ accounts_ping_status.issue_total }}</span>
            <span class="badge bg-green-lt">Stable: {{ accounts_ping_status.stable_total }}</span>
            <div class="dropdown">
              <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" id="accounts-ping-window-button">Filter</button>
              <div class="dropdown-menu dropdown-menu-end" id="accounts-ping-window-menu">
                {% for label, hours in accounts_ping_window_options %}
                  <div class="dropdown-item accounts-ping-window-row" data-hours="{{ hours }}" data-label="{{ label }}">{{ label }}</div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <div class="alert alert-info">
          <div class="d-flex align-items-start">
            <span class="me-2"><i class="ti ti-info-circle"></i></span>
            <div>
              Connection issues are shown when a customer is down, loss is at least {{ accounts_ping_status.rules.issue_loss_pct }}%, or latency is at least {{ accounts_ping_status.rules.issue_latency_ms }}ms.
              Bursts (1s checks) run only while an account is under investigation or failing briefly; long-down accounts automatically back off to avoid spam.
            </div>
          </div>
        </div>

        <ul class="nav nav-tabs" data-bs-toggle="tabs">
          <li class="nav-item">
            <a href="#accounts-ping-issues" class="nav-link active" data-bs-toggle="tab">Connection Issues</a>
          </li>
          <li class="nav-item">
            <a href="#accounts-ping-stable" class="nav-link" data-bs-toggle="tab">Stable Connections</a>
          </li>
          <li class="nav-item ms-auto">
            <div class="px-2 py-2">
              <div class="input-icon">
                <input class="form-control form-control-sm" id="accounts-ping-search" type="text" placeholder="Search" autocomplete="off" />
                <span class="input-icon-addon">
                  <i class="ti ti-search"></i>
                </span>
              </div>
            </div>
          </li>
        </ul>

        <div class="tab-content pt-3">
          <div class="tab-pane active" id="accounts-ping-issues">
            <div class="table-responsive">
              <table class="table table-vcenter">
                <thead>
                  <tr>
                    <th>Customer</th>
                    <th>IPv4</th>
                    <th>Status</th>
                    <th>Loss</th>
                    <th>Latency</th>
                    <th>Fail %</th>
                    <th>Uptime %</th>
                    <th>Streak</th>
                    <th>Down For</th>
                    <th>Last Check</th>
                    <th>24H Trend</th>
                    <th>Reason</th>
                    <th class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in accounts_ping_status.issue_rows %}
                    <tr class="accounts-ping-row" data-search="{{ (row.name ~ ' ' ~ row.ip)|lower }}">
                      <td>{{ row.name }}</td>
                      <td>{{ row.ip }}</td>
                      <td>
                        {% if row.status == 'down' %}
                          <span class="badge bg-red-lt">Down</span>
                        {% else %}
                          <span class="badge bg-yellow-lt">Monitor</span>
                        {% endif %}
                      </td>
                      <td>{{ row.loss is not none and ("%.1f"|format(row.loss) ~ "%") or "n/a" }}</td>
                      <td>{{ row.avg_ms is not none and ("%.1f"|format(row.avg_ms) ~ "ms") or "n/a" }}</td>
                      <td>{{ "%.1f"|format(row.rto_pct) }}</td>
                      <td>{{ "%.1f"|format(row.uptime_pct) }}</td>
                      <td>{{ row.streak }}</td>
                      <td>{{ row.down_for or "—" }}</td>
                      <td>{{ row.last_check }}</td>
                      <td>
                        <button type="button" class="btn btn-sm btn-outline-secondary accounts-ping-spark-btn"
                                data-account-id="{{ row.id }}" data-name="{{ row.name }}">
                          <svg width="140" height="28" viewBox="0 0 140 28" aria-hidden="true">
                            <polyline fill="none" stroke="#206bc4" stroke-width="2" points="{{ row.spark_points_24h }}" />
                          </svg>
                        </button>
                      </td>
                      <td>
                        {% for r in row.reasons %}
                          <div class="text-muted small">{{ r }}</div>
                        {% endfor %}
                      </td>
                      <td class="text-end">
                        <form method="post" action="/accounts-ping/investigate" class="d-inline">
                          <input type="hidden" name="account_id" value="{{ row.id }}" />
                          <input type="hidden" name="minutes" value="{{ settings.burst.investigate_minutes }}" />
                          <button type="submit" class="btn btn-sm btn-outline-primary">
                            <i class="ti ti-search me-1"></i>Investigate
                          </button>
                        </form>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="tab-pane" id="accounts-ping-stable">
            <div class="table-responsive">
              <table class="table table-vcenter">
                <thead>
                  <tr>
                    <th>Customer</th>
                    <th>IPv4</th>
                    <th>Status</th>
                    <th>Loss</th>
                    <th>Latency</th>
                    <th>Fail %</th>
                    <th>Uptime %</th>
                    <th>Last Check</th>
                    <th>24H Trend</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in accounts_ping_status.stable_rows %}
                    <tr class="accounts-ping-row" data-search="{{ (row.name ~ ' ' ~ row.ip)|lower }}">
                      <td>{{ row.name }}</td>
                      <td>{{ row.ip }}</td>
                      <td><span class="badge bg-green-lt">Up</span></td>
                      <td>{{ row.loss is not none and ("%.1f"|format(row.loss) ~ "%") or "n/a" }}</td>
                      <td>{{ row.avg_ms is not none and ("%.1f"|format(row.avg_ms) ~ "ms") or "n/a" }}</td>
                      <td>{{ "%.1f"|format(row.rto_pct) }}</td>
                      <td>{{ "%.1f"|format(row.uptime_pct) }}</td>
                      <td>{{ row.last_check }}</td>
                      <td>
                        <button type="button" class="btn btn-sm btn-outline-secondary accounts-ping-spark-btn"
                                data-account-id="{{ row.id }}" data-name="{{ row.name }}">
                          <svg width="140" height="28" viewBox="0 0 140 28" aria-hidden="true">
                            <polyline fill="none" stroke="#2fb344" stroke-width="2" points="{{ row.spark_points_24h }}" />
                          </svg>
                        </button>
                      </td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <div class="modal fade" id="accountsPingChartModal" tabindex="-1" aria-hidden="true">
          <div class="modal-dialog modal-lg modal-dialog-centered modal-dialog-scrollable">
            <div class="modal-content">
              <div class="modal-header">
                <h5 class="modal-title" id="accountsPingChartTitle">Account</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
              </div>
              <div class="modal-body">
                <div class="d-flex gap-2 mb-2 flex-wrap">
                  {% for label, hours in accounts_ping_window_options %}
                    <button type="button" class="btn btn-sm btn-outline-secondary accounts-ping-modal-window" data-hours="{{ hours }}">{{ label }}</button>
                  {% endfor %}
                </div>
                <div id="accountsPingChart" style="height: 260px;"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane {% if active_tab != 'status' %}active{% endif %}" id="accounts-ping-settings">
        <form method="post" action="/settings/accounts-ping">
          <div class="row g-3">
            <div class="col-12">
              <label class="form-label">Enable Accounts Ping</label>
              <label class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="enabled" {% if settings.enabled %}checked{% endif %} />
                <span class="form-check-label">Enabled</span>
              </label>
            </div>

            <div class="col-12">
              <div class="alert alert-info">
                <div class="d-flex align-items-start">
                  <span class="me-2"><i class="ti ti-info-circle"></i></span>
                  <div>Accounts Ping uses SSH to pull the ShapedDevices CSV and pings each IPv4 entry.</div>
                </div>
              </div>
              <h5 class="mb-3">SSH Source</h5>
              <div class="row g-3 mb-2">
                <div class="col-md-6">
                  <label class="form-label">Host</label>
                  <input class="form-control" type="text" name="ssh_host" value="{{ settings.ssh.host }}" />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Port</label>
                  <input class="form-control" type="number" name="ssh_port" value="{{ settings.ssh.port }}" />
                </div>
                <div class="col-md-3">
                  <label class="form-label">User</label>
                  <input class="form-control" type="text" name="ssh_user" value="{{ settings.ssh.user }}" />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Password</label>
                  <input class="form-control" type="password" name="ssh_password" value="{{ settings.ssh.password }}" />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Use SSH Key</label>
                  <label class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" name="ssh_use_key" {% if settings.ssh.use_key %}checked{% endif %} />
                    <span class="form-check-label">Enabled</span>
                  </label>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Key Path</label>
                  <input class="form-control" type="text" name="ssh_key_path" value="{{ settings.ssh.key_path }}" placeholder="/data/id_rsa" />
                </div>
                <div class="col-md-9">
                  <label class="form-label">CSV Path</label>
                  <input class="form-control" type="text" name="ssh_remote_csv_path" value="{{ settings.ssh.remote_csv_path }}" />
                </div>
                <div class="col-md-3">
                  <label class="form-label">Refresh (minutes)</label>
                  <input class="form-control" type="number" name="source_refresh_minutes" value="{{ settings.source.refresh_minutes }}" min="1" />
                </div>
              </div>
              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary">Save Accounts Ping</button>
                <button type="submit" class="btn btn-outline-secondary" formaction="/settings/accounts-ping/test" formmethod="post">
                  <i class="ti ti-plug-connected me-1"></i>Test SSH & Load CSV
                </button>
              </div>
              <div class="text-muted small mt-2">Tip: Save first, then Test to load accounts immediately.</div>
            </div>

            <div class="col-12"><hr class="my-2" /></div>

            <div class="col-md-4">
              <label class="form-label">Base Interval (seconds)</label>
              <input class="form-control" type="number" name="base_interval_seconds" value="{{ settings.general.base_interval_seconds }}" min="1" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Max Parallel</label>
              <input class="form-control" type="number" name="max_parallel" value="{{ settings.general.max_parallel }}" min="1" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Ping Count</label>
              <input class="form-control" type="number" name="ping_count" value="{{ settings.ping.count }}" min="1" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Ping Timeout (seconds)</label>
              <input class="form-control" type="number" name="ping_timeout_seconds" value="{{ settings.ping.timeout_seconds }}" min="1" />
            </div>

            <div class="col-12"><hr class="my-2" /></div>

            <div class="col-md-4">
              <label class="form-label">Issue Loss % (min)</label>
              <input class="form-control" type="number" step="0.1" name="issue_loss_pct" value="{{ settings.classification.issue_loss_pct }}" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Issue Latency ms (min)</label>
              <input class="form-control" type="number" step="0.1" name="issue_latency_ms" value="{{ settings.classification.issue_latency_ms }}" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Down Loss %</label>
              <input class="form-control" type="number" step="0.1" name="down_loss_pct" value="{{ settings.classification.down_loss_pct }}" />
            </div>

            <div class="col-12"><hr class="my-2" /></div>

            <div class="col-md-3">
              <label class="form-label">Burst Enabled</label>
              <label class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="burst_enabled" {% if settings.burst.enabled %}checked{% endif %} />
                <span class="form-check-label">Enabled</span>
              </label>
            </div>
            <div class="col-md-3">
              <label class="form-label">Burst Interval (seconds)</label>
              <input class="form-control" type="number" name="burst_interval_seconds" value="{{ settings.burst.burst_interval_seconds }}" min="1" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Burst Duration (seconds)</label>
              <input class="form-control" type="number" name="burst_duration_seconds" value="{{ settings.burst.burst_duration_seconds }}" min="5" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Investigate Minutes</label>
              <input class="form-control" type="number" name="investigate_minutes" value="{{ settings.burst.investigate_minutes }}" min="1" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Burst Count</label>
              <input class="form-control" type="number" name="burst_count" value="{{ settings.ping.burst_count }}" min="1" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Burst Timeout (seconds)</label>
              <input class="form-control" type="number" name="burst_timeout_seconds" value="{{ settings.ping.burst_timeout_seconds }}" min="1" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Trigger bursts on issues</label>
              <label class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="trigger_on_issue" {% if settings.burst.trigger_on_issue %}checked{% endif %} />
                <span class="form-check-label">Enabled</span>
              </label>
            </div>

            <div class="col-12"><hr class="my-2" /></div>

            <div class="col-md-4">
              <label class="form-label">Long-down seconds</label>
              <input class="form-control" type="number" name="long_down_seconds" value="{{ settings.backoff.long_down_seconds }}" min="60" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Long-down interval (seconds)</label>
              <input class="form-control" type="number" name="long_down_interval_seconds" value="{{ settings.backoff.long_down_interval_seconds }}" min="5" />
            </div>

            <div class="col-12"><hr class="my-2" /></div>

            <div class="col-md-4">
              <label class="form-label">Raw retention (days)</label>
              <input class="form-control" type="number" name="raw_retention_days" value="{{ settings.storage.raw_retention_days }}" min="1" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Rollup retention (days)</label>
              <input class="form-control" type="number" name="rollup_retention_days" value="{{ settings.storage.rollup_retention_days }}" min="1" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Rollup bucket (seconds)</label>
              <input class="form-control" type="number" name="bucket_seconds" value="{{ settings.storage.bucket_seconds }}" min="30" />
            </div>

            <div class="col-12 d-flex gap-2 mt-2">
              <a class="btn btn-outline-secondary" href="/settings/accounts-ping">Refresh</a>
            </div>
          </div>
        </form>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const searchEl = document.getElementById("accounts-ping-search");
    if (searchEl) {
      searchEl.addEventListener("input", () => {
        const q = (searchEl.value || "").trim().toLowerCase();
        document.querySelectorAll(".accounts-ping-row").forEach((tr) => {
          const hay = (tr.getAttribute("data-search") || "").toLowerCase();
          tr.style.display = !q || hay.includes(q) ? "" : "none";
        });
      });
    }

    document.querySelectorAll(".accounts-ping-window-row").forEach((row) => {
      row.addEventListener("click", () => {
        const hours = row.dataset.hours || "24";
        const url = new URL(window.location.href);
        url.searchParams.set("window", hours);
        window.location.href = url.toString();
      });
    });

    const modalEl = document.getElementById("accountsPingChartModal");
    const modalTitle = document.getElementById("accountsPingChartTitle");
    const modalChart = document.getElementById("accountsPingChart");
    const modalButtons = document.querySelectorAll(".accounts-ping-modal-window");
    let modalAccountId = "";
    let chart = null;

    const renderChart = async (name, accountId, hours) => {
      if (!modalChart) return;
      modalChart.innerHTML = "<div class='text-muted'>Loading…</div>";
      if (chart) {
        try { chart.destroy(); } catch (e) {}
        chart = null;
      }
      try {
        const params = new URLSearchParams({ account_id: accountId, window: String(hours) });
        const res = await fetch(`/accounts-ping/series?${params.toString()}`, { headers: { "Accept": "application/json" } });
        if (!res.ok) throw new Error("fetch failed");
        const payload = await res.json();
        const points = (payload.series || []).map((row) => {
          const ts = row.ts ? Date.parse(String(row.ts)) : NaN;
          if (!Number.isFinite(ts)) return null;
          return { x: ts, loss: row.loss === null || row.loss === undefined ? null : Number(row.loss), avg_ms: row.avg_ms === null || row.avg_ms === undefined ? null : Number(row.avg_ms) };
        }).filter(Boolean);
        if (!points.length) throw new Error("no data");
        const latency = points.map((p) => ({ x: p.x, y: p.avg_ms }));
        const loss = points.map((p) => ({ x: p.x, y: p.loss }));
        modalChart.innerHTML = "";
        chart = new window.ApexCharts(modalChart, {
          chart: { type: "line", height: 260, toolbar: { show: false }, zoom: { enabled: false } },
          stroke: { width: 2 },
          markers: { size: 0 },
          series: [
            { name: "Latency (ms)", data: latency },
            { name: "Loss (%)", data: loss },
          ],
          colors: ["#206bc4", "#d63939"],
          xaxis: { type: "datetime" },
          yaxis: [
            { title: { text: "ms" } },
            { opposite: true, min: 0, max: 100, tickAmount: 5, title: { text: "%" } },
          ],
          tooltip: { shared: true, intersect: false },
          grid: { strokeDashArray: 4 },
          legend: { position: "top" },
        });
        chart.render();
        if (modalTitle) modalTitle.textContent = `${name} (${hours}h)`;
      } catch (err) {
        modalChart.innerHTML = "<div class='text-muted'>No data available.</div>";
      }
    };

    document.querySelectorAll(".accounts-ping-spark-btn").forEach((btn) => {
      btn.addEventListener("click", async () => {
        modalAccountId = btn.getAttribute("data-account-id") || "";
        const name = btn.getAttribute("data-name") || "Account";
        const windowBadge = document.getElementById("accounts-ping-status-window");
        const windowText = windowBadge ? windowBadge.textContent.trim() : "1D";
        const hours = windowText.endsWith("H")
          ? parseInt(windowText.replace("H", ""), 10)
          : windowText.endsWith("D")
            ? parseInt(windowText.replace("D", ""), 10) * 24
            : 24;
        await renderChart(name, modalAccountId, hours);
        if (modalEl) new window.bootstrap.Modal(modalEl).show();
      });
    });

    modalButtons.forEach((btn) => {
      btn.addEventListener("click", async () => {
        const hours = parseInt(btn.dataset.hours || "24", 10);
        const name = (modalTitle && modalTitle.textContent.split(" (")[0]) || "Account";
        if (!modalAccountId) return;
        await renderChart(name, modalAccountId, hours);
      });
    });

    if (modalEl) {
      modalEl.addEventListener("hidden.bs.modal", () => {
        if (chart) {
          try { chart.destroy(); } catch (e) {}
          chart = null;
        }
        if (modalChart) modalChart.innerHTML = "";
      });
    }
  });
</script>
{% endblock %}
