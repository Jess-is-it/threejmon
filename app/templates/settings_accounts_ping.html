{% extends "base.html" %}
{% block title %}Accounts Ping{% endblock %}
{% block header_title %}Accounts Ping{% endblock %}
{% block header_badge %}
  <span class="badge bg-indigo-lt text-indigo header-icon-badge"><i class="ti ti-wifi"></i></span>
{% endblock %}
{% block content %}
{% if message %}
  <div class="alert alert-info">{{ message }}</div>
{% endif %}

<div class="card">
  <div class="card-body">
    <ul class="nav nav-tabs" data-bs-toggle="tabs">
      <li class="nav-item">
        <a href="#accounts-ping-status" class="nav-link {% if active_tab == 'status' %}active{% endif %}" data-bs-toggle="tab">Status</a>
      </li>
      <li class="nav-item">
        <a href="#accounts-ping-settings" class="nav-link {% if active_tab != 'status' %}active{% endif %}" data-bs-toggle="tab">Settings</a>
      </li>
    </ul>

    <div class="tab-content pt-4">
      <div class="tab-pane {% if active_tab == 'status' %}active{% endif %}" id="accounts-ping-status">
        <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-2">
          <div>
            <h4 class="mb-1">Accounts Ping <span class="badge bg-azure-lt" id="accounts-ping-status-window">{{ accounts_ping_status.window_label }}</span></h4>
            <div class="text-muted small">
              Last run: {{ accounts_ping_job.last_run_at_ph or 'n/a' }} · Last success: {{ accounts_ping_job.last_success_at_ph or 'n/a' }}
            </div>
          </div>
          <div class="d-flex gap-2 align-items-center flex-wrap">
            <span class="badge bg-blue-lt">Total: {{ accounts_ping_status.total }}</span>
            <span class="badge bg-red-lt">Issues: {{ accounts_ping_status.issue_total }}</span>
            <span class="badge bg-green-lt">Stable: {{ accounts_ping_status.stable_total }}</span>
            <div class="dropdown">
              <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" id="accounts-ping-window-button">Filter</button>
              <div class="dropdown-menu dropdown-menu-end" id="accounts-ping-window-menu">
                {% for label, hours in accounts_ping_window_options %}
                  <div class="dropdown-item accounts-ping-window-row" data-hours="{{ hours }}" data-label="{{ label }}">{{ label }}</div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <div class="alert alert-info">
          <div class="d-flex align-items-start">
            <span class="me-2"><i class="ti ti-info-circle"></i></span>
            <div>
              Accounts Ping uses SSH to pull the ShapedDevices CSV and pings each IPv4 entry.
              Issues are shown when a customer is down, loss is at least {{ accounts_ping_status.rules.issue_loss_pct }}%, or latency is at least {{ accounts_ping_status.rules.issue_latency_ms }}ms.
              Bursts (1s checks) run only while an account is under investigation or failing briefly; long-down accounts automatically back off.
            </div>
          </div>
        </div>

        <ul class="nav nav-tabs" data-bs-toggle="tabs">
          <li class="nav-item">
            <a href="#accounts-ping-issues" class="nav-link active" data-bs-toggle="tab">Connection Issues</a>
          </li>
          <li class="nav-item">
            <a href="#accounts-ping-stable" class="nav-link" data-bs-toggle="tab">Stable Connections</a>
          </li>
          <li class="nav-item ms-auto">
            <div class="px-2 py-2">
              <div class="input-icon">
                <input class="form-control form-control-sm" id="accounts-ping-search" type="text" placeholder="Search" autocomplete="off" />
                <span class="input-icon-addon">
                  <i class="ti ti-search"></i>
                </span>
              </div>
            </div>
          </li>
        </ul>

        <div class="tab-content pt-3">
          <div class="tab-pane active" id="accounts-ping-issues">
            <div class="table-responsive">
              <table class="table table-vcenter">
                <thead>
                  <tr>
                    <th>Customer</th>
                    <th>IPv4</th>
                    <th>Status</th>
                    <th>Loss</th>
                    <th>Latency</th>
                    <th>Fail %</th>
                    <th>Uptime %</th>
                    <th>Streak</th>
                    <th>Down For</th>
                    <th>Last Check</th>
                    <th>24H Trend</th>
                    <th>Reason</th>
                    <th class="text-end">Actions</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in accounts_ping_status.issue_rows %}
		                    {% set surv_key = (row.name or '') %}
                        {% set surv_status = surveillance_index.get(surv_key) %}
			                    <tr class="accounts-ping-row{% if surv_status == 'under' %} table-warning{% elif surv_status == 'level2' %} table-danger{% endif %}" data-search="{{ (row.name ~ ' ' ~ row.ip)|lower }}">
                      <td>{{ row.name }}</td>
                      <td>{{ row.ip }}</td>
                      <td>
                        {% if row.status == 'down' %}
                          <span class="badge bg-red-lt">Down</span>
                        {% else %}
                          <span class="badge bg-yellow-lt">Monitor</span>
                        {% endif %}
                      </td>
                      <td>{{ row.loss is not none and ("%.1f"|format(row.loss) ~ "%") or "n/a" }}</td>
                      <td>{{ row.avg_ms is not none and ("%.1f"|format(row.avg_ms) ~ "ms") or "n/a" }}</td>
                      <td>{{ "%.1f"|format(row.rto_pct) }}</td>
                      <td>{{ "%.1f"|format(row.uptime_pct) }}</td>
                      <td>{{ row.streak }}</td>
                      <td>{{ row.down_for or "—" }}</td>
                      <td>{{ row.last_check }}</td>
	                      <td>
	                        <button type="button"
	                                class="btn btn-link p-0 accounts-ping-spark-btn"
	                                style="line-height:0"
	                                data-account-id="{{ row.id }}"
	                                data-name="{{ row.name }}"
	                                data-ip="{{ row.ip }}"
	                                data-bs-toggle="modal"
	                                data-bs-target="#accounts-ping-spark-modal">
	                          <svg class="accounts-ping-sparkline" width="120" height="30" viewBox="0 0 140 28" preserveAspectRatio="none" aria-hidden="true">
	                            <polyline fill="none" stroke="#206bc4" stroke-width="2" points="{{ row.spark_points_24h }}" />
	                          </svg>
	                        </button>
	                      </td>
                      <td>
                        {% for r in row.reasons %}
                          <div class="text-muted small">{{ r }}</div>
                        {% endfor %}
                      </td>
		                      <td class="text-end">
			                        <span data-surveillance-slot>
			                          {% if surv_status == 'under' %}
			                            <a class="badge bg-yellow-lt text-yellow header-icon-badge" href="/surveillance?tab=under&focus={{ row.name|urlencode }}" title="Under Surveillance" aria-label="Under Surveillance">
			                              <i class="ti ti-eye"></i>
			                            </a>
			                          {% elif surv_status == 'level2' %}
			                            <a class="badge bg-red-lt text-red header-icon-badge" href="/surveillance?tab=level2&focus={{ row.name|urlencode }}" title="LEVEL II SUSPECT" aria-label="LEVEL II SUSPECT">
			                              <i class="ti ti-eye"></i>
			                            </a>
			                          {% else %}
			                            <button type="button"
			                                    class="badge bg-blue-lt text-blue header-icon-badge border-0 surveillance-add-btn"
		                                    title="For Surveillance"
		                                    data-pppoe="{{ row.name }}"
		                                    data-name="{{ row.name }}"
		                                    data-ip="{{ row.ip }}"
		                                    data-source="accounts_ping">
		                              <i class="ti ti-eye"></i>
		                            </button>
		                          {% endif %}
		                        </span>
		                      </td>
	                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>

          <div class="tab-pane" id="accounts-ping-stable">
            <div class="table-responsive">
              <table class="table table-vcenter">
                <thead>
	                  <tr>
	                    <th>Customer</th>
	                    <th>IPv4</th>
	                    <th>Status</th>
	                    <th>Loss</th>
	                    <th>Latency</th>
	                    <th>Fail %</th>
	                    <th>Uptime %</th>
	                    <th>Last Check</th>
	                    <th>24H Trend</th>
	                    <th class="text-end">Actions</th>
	                  </tr>
                </thead>
                <tbody>
                  {% for row in accounts_ping_status.stable_rows %}
		                    {% set surv_key = (row.name or '') %}
                        {% set surv_status = surveillance_index.get(surv_key) %}
			                    <tr class="accounts-ping-row{% if surv_status == 'under' %} table-warning{% elif surv_status == 'level2' %} table-danger{% endif %}" data-search="{{ (row.name ~ ' ' ~ row.ip)|lower }}">
                      <td>{{ row.name }}</td>
                      <td>{{ row.ip }}</td>
                      <td><span class="badge bg-green-lt">Up</span></td>
                      <td>{{ row.loss is not none and ("%.1f"|format(row.loss) ~ "%") or "n/a" }}</td>
                      <td>{{ row.avg_ms is not none and ("%.1f"|format(row.avg_ms) ~ "ms") or "n/a" }}</td>
                      <td>{{ "%.1f"|format(row.rto_pct) }}</td>
                      <td>{{ "%.1f"|format(row.uptime_pct) }}</td>
                      <td>{{ row.last_check }}</td>
		                      <td>
		                        <button type="button"
		                                class="btn btn-link p-0 accounts-ping-spark-btn"
	                                style="line-height:0"
	                                data-account-id="{{ row.id }}"
	                                data-name="{{ row.name }}"
	                                data-ip="{{ row.ip }}"
	                                data-bs-toggle="modal"
	                                data-bs-target="#accounts-ping-spark-modal">
	                          <svg class="accounts-ping-sparkline" width="120" height="30" viewBox="0 0 140 28" preserveAspectRatio="none" aria-hidden="true">
	                            <polyline fill="none" stroke="#2fb344" stroke-width="2" points="{{ row.spark_points_24h }}" />
	                          </svg>
		                        </button>
		                      </td>
			                      <td class="text-end">
				                        <span data-surveillance-slot>
				                          {% if surv_status == 'under' %}
				                            <a class="badge bg-yellow-lt text-yellow header-icon-badge" href="/surveillance?tab=under&focus={{ row.name|urlencode }}" title="Under Surveillance" aria-label="Under Surveillance">
				                              <i class="ti ti-eye"></i>
				                            </a>
				                          {% elif surv_status == 'level2' %}
				                            <a class="badge bg-red-lt text-red header-icon-badge" href="/surveillance?tab=level2&focus={{ row.name|urlencode }}" title="LEVEL II SUSPECT" aria-label="LEVEL II SUSPECT">
				                              <i class="ti ti-eye"></i>
				                            </a>
				                          {% else %}
				                            <button type="button"
				                                    class="badge bg-blue-lt text-blue header-icon-badge border-0 surveillance-add-btn"
			                                    title="For Surveillance"
			                                    data-pppoe="{{ row.name }}"
			                                    data-name="{{ row.name }}"
			                                    data-ip="{{ row.ip }}"
			                                    data-source="accounts_ping">
			                              <i class="ti ti-eye"></i>
			                            </button>
			                          {% endif %}
			                        </span>
			                      </td>
	                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
          </div>
        </div>

	        <div class="modal modal-blur fade" id="accounts-ping-spark-modal" tabindex="-1" role="dialog" aria-hidden="true">
	          <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
	            <div class="modal-content">
	              <div class="modal-header">
	                <h5 class="modal-title" id="accounts-ping-spark-title">Accounts Ping Trend</h5>
	                <div class="dropdown ms-auto">
	                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" id="accounts-ping-modal-window-button">Filter</button>
	                  <div class="dropdown-menu dropdown-menu-end" id="accounts-ping-modal-window-menu">
	                    {% for label, hours in accounts_ping_window_options %}
	                      <button class="dropdown-item accounts-ping-modal-window-option" data-hours="{{ hours }}" data-label="{{ label }}">{{ label }}</button>
	                    {% endfor %}
	                  </div>
	                </div>
	                <button type="button" class="btn-close ms-2" data-bs-dismiss="modal" aria-label="Close"></button>
	              </div>
	              <div class="modal-body">
	                <div id="accounts-ping-spark-modal-chart" style="height: 260px;"></div>
	                <div class="text-muted small mt-2">Latency and loss history based on raw ping results for the selected window.</div>
	              </div>
	            </div>
	          </div>
	        </div>
	      </div>

      <div class="tab-pane {% if active_tab != 'status' %}active{% endif %}" id="accounts-ping-settings">
        <form method="post" action="/settings/accounts-ping" id="accounts-ping-form">
          <input type="hidden" name="active_tab" value="settings" />
          <input type="hidden" name="settings_tab" id="accounts-ping-settings-tab" value="{{ settings_tab or 'general' }}" />

          <ul class="nav nav-tabs" data-bs-toggle="tabs">
            <li class="nav-item"><a href="#accounts-ping-general" class="nav-link {% if settings_tab == 'general' %}active{% endif %}" data-bs-toggle="tab">General</a></li>
            <li class="nav-item"><a href="#accounts-ping-source" class="nav-link {% if settings_tab == 'source' %}active{% endif %}" data-bs-toggle="tab">Source</a></li>
            <li class="nav-item"><a href="#accounts-ping-classification" class="nav-link {% if settings_tab == 'classification' %}active{% endif %}" data-bs-toggle="tab">Classification</a></li>
            <li class="nav-item"><a href="#accounts-ping-storage" class="nav-link {% if settings_tab == 'storage' %}active{% endif %}" data-bs-toggle="tab">Storage</a></li>
            <li class="nav-item"><a href="#accounts-ping-danger" class="nav-link {% if settings_tab == 'danger' %}active{% endif %}" data-bs-toggle="tab">Danger</a></li>
          </ul>

          <div class="tab-content pt-3">
            <div class="tab-pane {% if settings_tab == 'general' %}active{% endif %}" id="accounts-ping-general">
              <div class="card mb-3">
                <div class="card-body">
                  <h5 class="mb-3">General</h5>
                  <div class="row g-3">
                    <div class="col-12">
                      <label class="form-label">Enable Accounts Ping <span class="info" data-tip="Turns Accounts Ping monitoring on/off. When disabled, no pings are sent.">i</span></label>
                      <label class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="enabled" {% if settings.enabled %}checked{% endif %} />
                        <span class="form-check-label">Enabled</span>
                      </label>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Base Interval (seconds) <span class="info" data-tip="Normal check interval per account (seconds). Under Surveillance can override this interval.">i</span></label>
                      <input class="form-control" type="number" name="base_interval_seconds" value="{{ settings.general.base_interval_seconds }}" min="1" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Max Parallel <span class="info" data-tip="Maximum number of concurrent pings per loop. Higher values increase load.">i</span></label>
                      <input class="form-control" type="number" name="max_parallel" value="{{ settings.general.max_parallel }}" min="1" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Ping Count <span class="info" data-tip="Number of ICMP echo requests per normal check. Higher count improves accuracy but increases load.">i</span></label>
                      <input class="form-control" type="number" name="ping_count" value="{{ settings.ping.count }}" min="1" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Ping Timeout (seconds) <span class="info" data-tip="Timeout per ICMP echo request in normal mode (seconds).">i</span></label>
                      <input class="form-control" type="number" name="ping_timeout_seconds" value="{{ settings.ping.timeout_seconds }}" min="1" />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane {% if settings_tab == 'source' %}active{% endif %}" id="accounts-ping-source">
              <div class="card mb-3">
                <div class="card-body">
                  <div class="alert alert-info">
                    <div class="d-flex align-items-start">
                      <span class="me-2"><i class="ti ti-info-circle"></i></span>
                      <div>Accounts Ping uses SSH to pull the ShapedDevices CSV and pings each IPv4 entry.</div>
                    </div>
                  </div>
                  <h5 class="mb-3">SSH Source</h5>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Host <span class="info" data-tip="SSH host that contains the ShapedDevices CSV file.">i</span></label>
                      <input class="form-control" type="text" name="ssh_host" value="{{ settings.ssh.host }}" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Port <span class="info" data-tip="SSH port (usually 22).">i</span></label>
                      <input class="form-control" type="number" name="ssh_port" value="{{ settings.ssh.port }}" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">User <span class="info" data-tip="SSH username for the remote host.">i</span></label>
                      <input class="form-control" type="text" name="ssh_user" value="{{ settings.ssh.user }}" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Password <span class="info" data-tip="SSH password (leave blank if using a private key).">i</span></label>
                      <input class="form-control" type="password" name="ssh_password" value="{{ settings.ssh.password }}" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Use SSH Key <span class="info" data-tip="Enable when authenticating with a private key file.">i</span></label>
                      <label class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="ssh_use_key" {% if settings.ssh.use_key %}checked{% endif %} />
                        <span class="form-check-label">Enabled</span>
                      </label>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Key Path <span class="info" data-tip="Path to the private key inside the container (leave blank if using password).">i</span></label>
                      <input class="form-control" type="text" name="ssh_key_path" value="{{ settings.ssh.key_path }}" placeholder="/data/id_rsa" />
                    </div>
                    <div class="col-md-9">
                      <label class="form-label">CSV Path <span class="info" data-tip="Remote path to the ShapedDevices CSV file to import accounts from.">i</span></label>
                      <input class="form-control" type="text" name="ssh_remote_csv_path" value="{{ settings.ssh.remote_csv_path }}" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Refresh (minutes) <span class="info" data-tip="How often to reload the CSV source into the Accounts Ping cache (minutes).">i</span></label>
                      <input class="form-control" type="number" name="source_refresh_minutes" value="{{ settings.source.refresh_minutes }}" min="1" />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane {% if settings_tab == 'classification' %}active{% endif %}" id="accounts-ping-classification">
              <div class="card mb-3">
                <div class="card-body">
                  <h5 class="mb-3">Classification</h5>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">Issue Loss % (min) <span class="info" data-tip="Minimum packet loss percentage to classify a connection as an issue/monitor.">i</span></label>
                      <input class="form-control" type="number" step="0.1" name="issue_loss_pct" value="{{ settings.classification.issue_loss_pct }}" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Issue Latency ms (min) <span class="info" data-tip="Minimum average latency (ms) to classify a connection as an issue/monitor.">i</span></label>
                      <input class="form-control" type="number" step="0.1" name="issue_latency_ms" value="{{ settings.classification.issue_latency_ms }}" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Down Loss % <span class="info" data-tip="Loss threshold to treat a connection as down (usually 100%).">i</span></label>
                      <input class="form-control" type="number" step="0.1" name="down_loss_pct" value="{{ settings.classification.down_loss_pct }}" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="alert alert-info">
              <div class="d-flex align-items-start">
                <span class="me-2"><i class="ti ti-info-circle"></i></span>
                <div>Burst/backoff behavior is managed under <a href="/surveillance">Under Surveillance</a>.</div>
              </div>
            </div>

            <div class="tab-pane {% if settings_tab == 'storage' %}active{% endif %}" id="accounts-ping-storage">
              <div class="card mb-3">
                <div class="card-body">
                  <h5 class="mb-3">Storage</h5>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">Raw retention (days) <span class="info" data-tip="Days to keep per-check raw results for Accounts Ping.">i</span></label>
                      <input class="form-control" type="number" name="raw_retention_days" value="{{ settings.storage.raw_retention_days }}" min="1" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Rollup retention (days) <span class="info" data-tip="Days to keep rollups (bucketed summaries) for Accounts Ping.">i</span></label>
                      <input class="form-control" type="number" name="rollup_retention_days" value="{{ settings.storage.rollup_retention_days }}" min="1" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Rollup bucket (seconds) <span class="info" data-tip="Bucket size for rollups (seconds). Smaller buckets store more data.">i</span></label>
                      <input class="form-control" type="number" name="bucket_seconds" value="{{ settings.storage.bucket_seconds }}" min="30" />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane {% if settings_tab == 'danger' %}active{% endif %}" id="accounts-ping-danger">
              <div class="card mb-3">
                <div class="card-body">
                  <h4 class="mb-2">Format Accounts Ping Database</h4>
                  <div class="alert alert-warning">
                    <div class="d-flex align-items-center">
                      <span class="me-2"><i class="ti ti-alert-triangle"></i></span>
                      <div>Formatting removes stored Accounts Ping history so the next run starts fresh.</div>
                    </div>
                  </div>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="confirm_format" form="accounts-ping-format-form" />
                    <span class="form-check-label">I understand this will erase Accounts Ping history data. <span class="info" data-tip="Required to enable the Format button.">i</span></span>
                  </label>
                  <div class="mt-3">
                    <button type="submit" class="btn btn-danger" form="accounts-ping-format-form">Format Accounts Ping Database</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-end gap-2">
            <button type="submit" class="btn btn-primary">Save Accounts Ping Settings</button>
            <button type="submit" class="btn btn-outline-secondary" formaction="/settings/accounts-ping/test" formmethod="post">
              Test SSH & Load CSV
            </button>
          </div>
        </form>
        <form id="accounts-ping-format-form" method="post" action="/settings/accounts-ping/format"></form>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const searchEl = document.getElementById("accounts-ping-search");
    if (searchEl) {
      searchEl.addEventListener("input", () => {
        const q = (searchEl.value || "").trim().toLowerCase();
        document.querySelectorAll(".accounts-ping-row").forEach((tr) => {
          const hay = (tr.getAttribute("data-search") || "").toLowerCase();
          tr.style.display = !q || hay.includes(q) ? "" : "none";
        });
      });
    }

    document.querySelectorAll(".accounts-ping-window-row").forEach((row) => {
      row.addEventListener("click", () => {
        const hours = row.dataset.hours || "24";
        const url = new URL(window.location.href);
        url.searchParams.set("window", hours);
        window.location.href = url.toString();
      });
    });

    const settingsInput = document.getElementById("accounts-ping-settings-tab");
    if (settingsInput) {
      const settingsTabs = document.querySelectorAll('#accounts-ping-settings [data-bs-toggle="tabs"] .nav-link');
      settingsTabs.forEach((tab) => {
        tab.addEventListener("shown.bs.tab", (event) => {
          const target = event.target.getAttribute("href") || "";
          if (target.startsWith("#accounts-ping-")) {
            settingsInput.value = target.replace("#accounts-ping-", "");
          }
        });
      });
    }

	    const modalEl = document.getElementById("accounts-ping-spark-modal");
	    const modalTitle = document.getElementById("accounts-ping-spark-title");
	    const modalChart = document.getElementById("accounts-ping-spark-modal-chart");
	    const modalWindowButton = document.getElementById("accounts-ping-modal-window-button");
	    const modalWindowOptions = document.querySelectorAll(".accounts-ping-modal-window-option");
	    let modalAccountId = "";
	    let modalAccountName = "Account";
	    let modalAccountIp = "";
	    let chart = null;

	    const renderChart = async (name, accountId, hours) => {
	      if (!modalChart) return;
	      modalChart.innerHTML = "<div class='text-muted'>Loading…</div>";
      if (chart) {
        try { chart.destroy(); } catch (e) {}
        chart = null;
      }
	      try {
	        if (!window.ApexCharts) {
	          throw new Error("ApexCharts not loaded");
	        }
	        const params = new URLSearchParams({ account_id: accountId, window: String(hours) });
	        const res = await fetch(`/accounts-ping/series?${params.toString()}`, { headers: { "Accept": "application/json" }, cache: "no-store" });
	        if (!res.ok) throw new Error("fetch failed");
        const payload = await res.json();
        const points = (payload.series || []).map((row) => {
          const ts = row.ts ? Date.parse(String(row.ts)) : NaN;
          if (!Number.isFinite(ts)) return null;
          return { x: ts, loss: row.loss === null || row.loss === undefined ? null : Number(row.loss), avg_ms: row.avg_ms === null || row.avg_ms === undefined ? null : Number(row.avg_ms) };
        }).filter(Boolean);
        if (!points.length) throw new Error("no data");
        const latency = points.map((p) => ({ x: p.x, y: p.avg_ms }));
        const loss = points.map((p) => ({ x: p.x, y: p.loss }));
        modalChart.innerHTML = "";
	        chart = new window.ApexCharts(modalChart, {
	          chart: { type: "line", height: 260, toolbar: { show: false }, zoom: { enabled: false } },
	          stroke: { width: 2 },
	          markers: { size: 0 },
          series: [
            { name: "Latency (ms)", data: latency },
            { name: "Loss (%)", data: loss },
          ],
	          colors: ["#206bc4", "#d63939"],
	          xaxis: { type: "datetime" },
	          yaxis: [
	            { title: { text: "ms" } },
	            { opposite: true, min: 0, max: 100, tickAmount: 5, title: { text: "%" } },
	          ],
	          tooltip: {
	            shared: true,
	            intersect: false,
	            x: {
	              formatter: (value) => {
	                const dt = new Date(value);
	                if (Number.isNaN(dt.getTime())) return "";
	                return dt.toLocaleString("en-PH", {
	                  month: "short",
	                  day: "2-digit",
	                  hour: "2-digit",
	                  minute: "2-digit",
	                  hour12: true,
	                });
	              },
	            },
	          },
	          grid: { strokeDashArray: 4 },
	          legend: { position: "top" },
	        });
	        chart.render();
	        if (modalTitle) modalTitle.textContent = `${name}${modalAccountIp ? ` (${modalAccountIp})` : ""}`;
	      } catch (err) {
	        modalChart.innerHTML = "<div class='text-muted'>No data available.</div>";
	      }
	    };

	    const getDefaultHours = () => {
	      const urlParam = new URLSearchParams(window.location.search).get("window");
	      const stored = localStorage.getItem("accounts_ping_modal_window_hours");
	      const candidate = stored || urlParam || "24";
	      const parsed = parseInt(candidate, 10);
	      return Number.isNaN(parsed) ? 24 : parsed;
	    };

	    const setModalWindowLabel = (hours) => {
	      const match = Array.from(modalWindowOptions).find((btn) => parseInt(btn.dataset.hours || "", 10) === hours);
	      if (modalWindowButton) {
	        modalWindowButton.textContent = match ? (match.dataset.label || `${hours}h`) : `${hours}h`;
	      }
	    };

	    // Ensure modal isn't clipped by tab containers.
	    if (modalEl && modalEl.parentElement && modalEl.parentElement !== document.body) {
	      document.body.appendChild(modalEl);
	    }

	    document.querySelectorAll(".accounts-ping-spark-btn").forEach((btn) => {
	      btn.addEventListener("click", () => {
	        modalAccountId = btn.getAttribute("data-account-id") || "";
	        modalAccountName = btn.getAttribute("data-name") || "Account";
	        modalAccountIp = btn.getAttribute("data-ip") || "";
	        setModalWindowLabel(getDefaultHours());
	      });
	    });

	    modalWindowOptions.forEach((btn) => {
	      btn.addEventListener("click", async (event) => {
	        event.preventDefault();
	        if (!modalAccountId) return;
	        const hours = parseInt(btn.dataset.hours || "24", 10);
	        localStorage.setItem("accounts_ping_modal_window_hours", String(hours));
	        setModalWindowLabel(hours);
	        await renderChart(modalAccountName, modalAccountId, hours);
	      });
	    });

	    if (modalEl) {
	      modalEl.addEventListener("shown.bs.modal", async () => {
	        if (!modalAccountId) return;
	        const hours = getDefaultHours();
	        setModalWindowLabel(hours);
	        await renderChart(modalAccountName, modalAccountId, hours);
	      });

	      modalEl.addEventListener("hidden.bs.modal", () => {
	        if (chart) {
	          try { chart.destroy(); } catch (e) {}
	          chart = null;
	        }
	        if (modalChart) modalChart.innerHTML = "";
	        modalAccountId = "";
	        modalAccountName = "Account";
	        modalAccountIp = "";
	      });
	    }
	  });
	</script>
{% endblock %}
