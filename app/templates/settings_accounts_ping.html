{% extends "base.html" %}
{% block title %}Accounts Ping{% endblock %}
{% block header_title %}Accounts Ping{% endblock %}
{% block header_badge %}
  <span class="badge bg-indigo-lt text-indigo header-icon-badge"><i class="ti ti-wifi"></i></span>
{% endblock %}
{% block content %}
{% if message %}
  <div class="alert alert-info">{{ message }}</div>
{% endif %}

<div class="card">
  <div class="card-body">
    <ul class="nav nav-tabs" data-bs-toggle="tabs">
      <li class="nav-item">
        <a href="#accounts-ping-status" class="nav-link {% if active_tab == 'status' %}active{% endif %}" data-bs-toggle="tab">Status</a>
      </li>
      <li class="nav-item">
        <a href="#accounts-ping-settings" class="nav-link {% if active_tab != 'status' %}active{% endif %}" data-bs-toggle="tab">Settings</a>
      </li>
    </ul>

    <div class="tab-content pt-4">
      <div class="tab-pane {% if active_tab == 'status' %}active{% endif %}" id="accounts-ping-status">
        <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-2">
          <div>
            <h4 class="mb-1">Accounts Ping <span class="badge bg-azure-lt" id="accounts-ping-status-window">{{ accounts_ping_status.window_label }}</span></h4>
            <div class="text-muted small">
              Last run: {{ accounts_ping_job.last_run_at_ph or 'n/a' }} · Last success: {{ accounts_ping_job.last_success_at_ph or 'n/a' }}
            </div>
          </div>
	          <div class="d-flex gap-2 align-items-center flex-wrap">
	            <span class="badge bg-blue-lt">Total: {{ accounts_ping_status.total }}</span>
	            <span class="badge bg-red-lt">Issues: {{ accounts_ping_status.issue_total }}</span>
	            <span class="badge bg-green-lt">Stable: {{ accounts_ping_status.stable_total }}</span>
              <span class="badge bg-secondary-lt">Pending: {{ accounts_ping_status.pending_total }}</span>
              {% set accounts_ping_limit_param = 'all' if accounts_ping_status.pagination.limit == 0 else accounts_ping_status.pagination.limit %}
              <div class="dropdown">
                <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" id="accounts-ping-limit-button">Show: {{ accounts_ping_status.pagination.limit_label }}</button>
                <div class="dropdown-menu dropdown-menu-end" id="accounts-ping-limit-menu">
                  {% for opt in accounts_ping_status.pagination.options %}
                    <div class="dropdown-item accounts-ping-limit-row" data-limit="{{ opt }}">{{ opt }}</div>
                  {% endfor %}
	                  {# "ALL" removed to keep pages fast #}
	                </div>
	              </div>
	            <div class="dropdown">
	              <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" id="accounts-ping-window-button">Filter</button>
	              <div class="dropdown-menu dropdown-menu-end" id="accounts-ping-window-menu">
	                {% for label, hours in accounts_ping_window_options %}
	                  <div class="dropdown-item d-flex align-items-center justify-content-between accounts-ping-window-row" data-hours="{{ hours }}" data-label="{{ label }}">
	                    <span>{{ label }}</span>
	                    <button class="btn btn-sm btn-link p-0 accounts-ping-window-star-btn" data-hours="{{ hours }}" title="Set default filter">
	                      <i class="ti ti-star text-muted"></i>
	                    </button>
	                  </div>
	                {% endfor %}
	              </div>
	            </div>
	          </div>
	        </div>

        <div class="alert alert-info">
          <div class="d-flex align-items-start">
            <span class="me-2"><i class="ti ti-info-circle"></i></span>
		            <div>
		              Accounts Ping uses SSH to pull the ShapedDevices CSV and pings each IPv4 entry.
		              Issues are shown when a customer is down, loss is at least {{ accounts_ping_status.rules.issue_loss_pct }}%, latency is at least {{ accounts_ping_status.rules.issue_latency_ms }}ms, or Fail % is at least {{ accounts_ping_status.rules.issue_rto_pct }}%.
		              Up accounts with Fail % above {{ accounts_ping_status.rules.stable_rto_pct }}% are shown as Monitor.
		            </div>
		          </div>
		        </div>

        <ul class="nav nav-tabs" data-bs-toggle="tabs">
          <li class="nav-item">
            <a href="#accounts-ping-issues" class="nav-link active" data-bs-toggle="tab">Connection Issues</a>
          </li>
          <li class="nav-item">
            <a href="#accounts-ping-stable" class="nav-link" data-bs-toggle="tab">Stable Connections</a>
          </li>
          <li class="nav-item ms-auto">
            <div class="px-2 py-2">
              <div class="input-icon">
	                <input class="form-control form-control-sm" id="accounts-ping-search" type="text" placeholder="Search" autocomplete="off" value="{{ accounts_ping_status.query or '' }}" />
                <span class="input-icon-addon">
                  <i class="ti ti-search"></i>
                </span>
              </div>
            </div>
          </li>
        </ul>

        <div class="tab-content pt-3">
	          <div class="tab-pane active" id="accounts-ping-issues">
	            <div class="table-responsive">
	              <table class="table table-vcenter rto-table">
	                <thead>
	                  <tr>
	                    <th class="rto-sort" data-sort-key="customer" aria-sort="none">Customer <span class="rto-sort-indicator" aria-hidden="true"></span></th>
	                    <th class="rto-sort" data-sort-key="ip" aria-sort="none">IPv4 <span class="rto-sort-indicator" aria-hidden="true"></span></th>
	                    <th class="rto-sort" data-sort-key="status" aria-sort="none">Status <span class="rto-sort-indicator" aria-hidden="true"></span></th>
	                    <th class="rto-sort" data-sort-key="loss" aria-sort="none">Loss <span class="rto-sort-indicator" aria-hidden="true"></span></th>
	                    <th class="rto-sort" data-sort-key="latency" aria-sort="none">Latency <span class="rto-sort-indicator" aria-hidden="true"></span></th>
	                    <th class="rto-sort" data-sort-key="fail_pct" aria-sort="none">Fail % <span class="rto-sort-indicator" aria-hidden="true"></span></th>
	                    <th class="rto-sort" data-sort-key="uptime_pct" aria-sort="none">Uptime % <span class="rto-sort-indicator" aria-hidden="true"></span></th>
	                    <th class="rto-sort" data-sort-key="streak" aria-sort="none">Streak <span class="rto-sort-indicator" aria-hidden="true"></span></th>
	                    <th class="rto-sort" data-sort-key="down_seconds" aria-sort="none">Down For <span class="rto-sort-indicator" aria-hidden="true"></span></th>
	                    <th class="rto-sort" data-sort-key="last_check_at" aria-sort="none">Last Check <span class="rto-sort-indicator" aria-hidden="true"></span></th>
	                    <th>24H Trend</th>
	                    <th class="rto-sort" data-sort-key="reason" aria-sort="none">Reason <span class="rto-sort-indicator" aria-hidden="true"></span></th>
	                    <th class="text-end">Actions</th>
	                  </tr>
	                </thead>
	                <tbody>
	                  {% for row in accounts_ping_status.issue_rows %}
			                    {% set surv_key = (row.name or '') %}
                        {% set surv_status = surveillance_index.get(surv_key) %}
				                    <tr class="accounts-ping-row{% if surv_status == 'under' %} table-warning{% elif surv_status == 'level2' %} table-danger{% endif %}" data-search="{{ (row.name ~ ' ' ~ row.ip)|lower }}">
	                      <td>{{ row.name }}</td>
                      <td>{{ row.ip }}</td>
                      <td>
                        {% if row.status == 'down' %}
                          <span class="badge bg-red-lt">Down</span>
                        {% else %}
                          <span class="badge bg-yellow-lt">Monitor</span>
                        {% endif %}
                      </td>
                      <td>{{ row.loss is not none and ("%.1f"|format(row.loss) ~ "%") or "n/a" }}</td>
                      <td>{{ row.avg_ms is not none and ("%.1f"|format(row.avg_ms) ~ "ms") or "n/a" }}</td>
                      <td>{{ "%.1f"|format(row.rto_pct) }}</td>
                      <td>{{ "%.1f"|format(row.uptime_pct) }}</td>
                      <td>{{ row.streak }}</td>
                      <td>{{ row.down_for or "—" }}</td>
                      <td>{{ row.last_check }}</td>
	                      <td>
	                        <button type="button"
	                                class="btn btn-link p-0 accounts-ping-spark-btn"
	                                style="line-height:0"
	                                data-account-id="{{ row.id }}"
	                                data-name="{{ row.name }}"
	                                data-ip="{{ row.ip }}"
	                                data-bs-toggle="modal"
	                                data-bs-target="#accounts-ping-spark-modal">
	                          <svg class="accounts-ping-sparkline" width="120" height="30" viewBox="0 0 140 28" preserveAspectRatio="none" aria-hidden="true">
	                            <polyline fill="none" stroke="#206bc4" stroke-width="2" points="{{ row.spark_points_24h }}" />
	                          </svg>
	                        </button>
	                      </td>
	                      <td>
	                        {% set reason_text = row.reasons|join('; ') %}
	                        <div class="text-muted small text-truncate d-inline-block" style="max-width: 320px;" title="{{ reason_text }}">{{ reason_text }}</div>
	                      </td>
		                      <td class="text-end">
			                        <span data-surveillance-slot>
			                          {% if surv_status == 'under' %}
			                            <a class="badge bg-yellow-lt text-yellow header-icon-badge" href="/surveillance?tab=under&focus={{ row.name|urlencode }}" title="Under Surveillance" aria-label="Under Surveillance">
			                              <i class="ti ti-eye"></i>
			                            </a>
			                          {% elif surv_status == 'level2' %}
			                            <a class="badge bg-red-lt text-red header-icon-badge" href="/surveillance?tab=level2&focus={{ row.name|urlencode }}" title="LEVEL II SUSPECT" aria-label="LEVEL II SUSPECT">
			                              <i class="ti ti-eye"></i>
			                            </a>
			                          {% else %}
			                            <button type="button"
			                                    class="badge bg-blue-lt text-blue header-icon-badge border-0 surveillance-add-btn"
		                                    title="For Surveillance"
		                                    data-pppoe="{{ row.name }}"
		                                    data-name="{{ row.name }}"
		                                    data-ip="{{ row.ip }}"
		                                    data-source="accounts_ping">
		                              <i class="ti ti-eye"></i>
		                            </button>
		                          {% endif %}
		                        </span>
			                      </td>
		                    </tr>
	                  {% else %}
                      <tr>
                        <td colspan="13" class="text-muted">No connection issues detected yet.</td>
                      </tr>
	                  {% endfor %}
	                </tbody>
	              </table>
	            </div>
              {% set meta = accounts_ping_status.pagination.issues %}
              <div class="d-flex flex-wrap align-items-center justify-content-between mt-2 gap-2">
                <div class="text-muted small">Showing {{ meta.start }}–{{ meta.end }} of {{ meta.total }}</div>
                {% if meta.pages > 1 %}
                  {% set prev_page = meta.page - 1 if meta.page > 1 else 1 %}
                  {% set next_page = meta.page + 1 if meta.page < meta.pages else meta.pages %}
                  <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Page {{ meta.page }} of {{ meta.pages }}</span>
                    <ul class="pagination pagination-sm mb-0">
                      <li class="page-item {% if not meta.has_prev %}disabled{% endif %}">
	                        <a class="page-link" href="/settings/accounts-ping?window={{ accounts_ping_status.window_hours }}&limit={{ accounts_ping_limit_param }}&issues_page={{ prev_page }}&stable_page={{ accounts_ping_status.pagination.stable.page }}&issues_sort={{ accounts_ping_status.sort.issues.key }}&issues_dir={{ accounts_ping_status.sort.issues.dir }}&stable_sort={{ accounts_ping_status.sort.stable.key }}&stable_dir={{ accounts_ping_status.sort.stable.dir }}&q={{ accounts_ping_status.query|urlencode }}#accounts-ping-issues">Prev</a>
	                      </li>
	                      <li class="page-item {% if not meta.has_next %}disabled{% endif %}">
	                        <a class="page-link" href="/settings/accounts-ping?window={{ accounts_ping_status.window_hours }}&limit={{ accounts_ping_limit_param }}&issues_page={{ next_page }}&stable_page={{ accounts_ping_status.pagination.stable.page }}&issues_sort={{ accounts_ping_status.sort.issues.key }}&issues_dir={{ accounts_ping_status.sort.issues.dir }}&stable_sort={{ accounts_ping_status.sort.stable.key }}&stable_dir={{ accounts_ping_status.sort.stable.dir }}&q={{ accounts_ping_status.query|urlencode }}#accounts-ping-issues">Next</a>
	                      </li>
                    </ul>
                  </div>
                {% endif %}
              </div>
	          </div>

	          <div class="tab-pane" id="accounts-ping-stable">
	            <div class="table-responsive">
	              <table class="table table-vcenter rto-table">
	                <thead>
		                  <tr>
		                    <th class="rto-sort" data-sort-key="customer" aria-sort="none">Customer <span class="rto-sort-indicator" aria-hidden="true"></span></th>
		                    <th class="rto-sort" data-sort-key="ip" aria-sort="none">IPv4 <span class="rto-sort-indicator" aria-hidden="true"></span></th>
		                    <th class="rto-sort" data-sort-key="status" aria-sort="none">Status <span class="rto-sort-indicator" aria-hidden="true"></span></th>
		                    <th class="rto-sort" data-sort-key="loss" aria-sort="none">Loss <span class="rto-sort-indicator" aria-hidden="true"></span></th>
		                    <th class="rto-sort" data-sort-key="latency" aria-sort="none">Latency <span class="rto-sort-indicator" aria-hidden="true"></span></th>
		                    <th class="rto-sort" data-sort-key="fail_pct" aria-sort="none">Fail % <span class="rto-sort-indicator" aria-hidden="true"></span></th>
		                    <th class="rto-sort" data-sort-key="uptime_pct" aria-sort="none">Uptime % <span class="rto-sort-indicator" aria-hidden="true"></span></th>
		                    <th class="rto-sort" data-sort-key="last_check_at" aria-sort="none">Last Check <span class="rto-sort-indicator" aria-hidden="true"></span></th>
		                    <th>24H Trend</th>
		                    <th class="text-end">Actions</th>
		                  </tr>
	                </thead>
	                <tbody>
	                  {% for row in accounts_ping_status.stable_rows %}
			                    {% set surv_key = (row.name or '') %}
                        {% set surv_status = surveillance_index.get(surv_key) %}
				                    <tr class="accounts-ping-row{% if surv_status == 'under' %} table-warning{% elif surv_status == 'level2' %} table-danger{% endif %}" data-search="{{ (row.name ~ ' ' ~ row.ip)|lower }}">
	                      <td>{{ row.name }}</td>
                      <td>{{ row.ip }}</td>
	                      <td>
	                        {% if row.status == 'pending' %}
	                          <span class="badge bg-secondary-lt">Pending</span>
	                        {% else %}
	                          <span class="badge bg-green-lt">Up</span>
	                        {% endif %}
	                      </td>
                      <td>{{ row.loss is not none and ("%.1f"|format(row.loss) ~ "%") or "n/a" }}</td>
                      <td>{{ row.avg_ms is not none and ("%.1f"|format(row.avg_ms) ~ "ms") or "n/a" }}</td>
                      <td>{{ "%.1f"|format(row.rto_pct) }}</td>
                      <td>{{ "%.1f"|format(row.uptime_pct) }}</td>
                      <td>{{ row.last_check }}</td>
			                      <td>
                              {% if row.status == 'pending' %}
                                <span class="text-muted small">n/a</span>
                              {% else %}
			                          <button type="button"
			                                  class="btn btn-link p-0 accounts-ping-spark-btn"
		                                  style="line-height:0"
		                                  data-account-id="{{ row.id }}"
		                                  data-name="{{ row.name }}"
		                                  data-ip="{{ row.ip }}"
		                                  data-bs-toggle="modal"
		                                  data-bs-target="#accounts-ping-spark-modal">
		                            <svg class="accounts-ping-sparkline" width="120" height="30" viewBox="0 0 140 28" preserveAspectRatio="none" aria-hidden="true">
		                              <polyline fill="none" stroke="#2fb344" stroke-width="2" points="{{ row.spark_points_24h }}" />
		                            </svg>
			                          </button>
                              {% endif %}
			                      </td>
			                      <td class="text-end">
				                        <span data-surveillance-slot>
				                          {% if surv_status == 'under' %}
				                            <a class="badge bg-yellow-lt text-yellow header-icon-badge" href="/surveillance?tab=under&focus={{ row.name|urlencode }}" title="Under Surveillance" aria-label="Under Surveillance">
				                              <i class="ti ti-eye"></i>
				                            </a>
				                          {% elif surv_status == 'level2' %}
				                            <a class="badge bg-red-lt text-red header-icon-badge" href="/surveillance?tab=level2&focus={{ row.name|urlencode }}" title="LEVEL II SUSPECT" aria-label="LEVEL II SUSPECT">
				                              <i class="ti ti-eye"></i>
				                            </a>
				                          {% else %}
				                            <button type="button"
				                                    class="badge bg-blue-lt text-blue header-icon-badge border-0 surveillance-add-btn"
			                                    title="For Surveillance"
			                                    data-pppoe="{{ row.name }}"
			                                    data-name="{{ row.name }}"
			                                    data-ip="{{ row.ip }}"
			                                    data-source="accounts_ping">
			                              <i class="ti ti-eye"></i>
			                            </button>
			                          {% endif %}
			                        </span>
				                      </td>
		                    </tr>
	                  {% else %}
                      <tr>
                        <td colspan="10" class="text-muted">No stable connections listed yet.</td>
                      </tr>
	                  {% endfor %}
	                </tbody>
	              </table>
	            </div>
              {% set meta = accounts_ping_status.pagination.stable %}
              <div class="d-flex flex-wrap align-items-center justify-content-between mt-2 gap-2">
                <div class="text-muted small">Showing {{ meta.start }}–{{ meta.end }} of {{ meta.total }}</div>
                {% if meta.pages > 1 %}
                  {% set prev_page = meta.page - 1 if meta.page > 1 else 1 %}
                  {% set next_page = meta.page + 1 if meta.page < meta.pages else meta.pages %}
                  <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Page {{ meta.page }} of {{ meta.pages }}</span>
                    <ul class="pagination pagination-sm mb-0">
                      <li class="page-item {% if not meta.has_prev %}disabled{% endif %}">
	                        <a class="page-link" href="/settings/accounts-ping?window={{ accounts_ping_status.window_hours }}&limit={{ accounts_ping_limit_param }}&issues_page={{ accounts_ping_status.pagination.issues.page }}&stable_page={{ prev_page }}&issues_sort={{ accounts_ping_status.sort.issues.key }}&issues_dir={{ accounts_ping_status.sort.issues.dir }}&stable_sort={{ accounts_ping_status.sort.stable.key }}&stable_dir={{ accounts_ping_status.sort.stable.dir }}&q={{ accounts_ping_status.query|urlencode }}#accounts-ping-stable">Prev</a>
	                      </li>
	                      <li class="page-item {% if not meta.has_next %}disabled{% endif %}">
	                        <a class="page-link" href="/settings/accounts-ping?window={{ accounts_ping_status.window_hours }}&limit={{ accounts_ping_limit_param }}&issues_page={{ accounts_ping_status.pagination.issues.page }}&stable_page={{ next_page }}&issues_sort={{ accounts_ping_status.sort.issues.key }}&issues_dir={{ accounts_ping_status.sort.issues.dir }}&stable_sort={{ accounts_ping_status.sort.stable.key }}&stable_dir={{ accounts_ping_status.sort.stable.dir }}&q={{ accounts_ping_status.query|urlencode }}#accounts-ping-stable">Next</a>
	                      </li>
                    </ul>
                  </div>
                {% endif %}
              </div>
	          </div>
	        </div>

	        <div class="modal modal-blur fade" id="accounts-ping-spark-modal" tabindex="-1" role="dialog" aria-hidden="true">
	          <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
	            <div class="modal-content">
	              <div class="modal-header">
	                <h5 class="modal-title" id="accounts-ping-spark-title">Accounts Ping Trend</h5>
	                <div class="dropdown ms-auto">
	                  <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" id="accounts-ping-modal-window-button">Filter</button>
	                  <div class="dropdown-menu dropdown-menu-end" id="accounts-ping-modal-window-menu">
	                    {% for label, hours in accounts_ping_window_options %}
	                      <button class="dropdown-item accounts-ping-modal-window-option" data-hours="{{ hours }}" data-label="{{ label }}">{{ label }}</button>
	                    {% endfor %}
	                  </div>
	                </div>
	                <button type="button" class="btn-close ms-2" data-bs-dismiss="modal" aria-label="Close"></button>
	              </div>
	              <div class="modal-body">
	                <div id="accounts-ping-spark-modal-chart" style="height: 260px;"></div>
	                <div class="text-muted small mt-2">Latency and loss history based on raw ping results for the selected window.</div>
	              </div>
	            </div>
	          </div>
	        </div>
	      </div>

      <div class="tab-pane {% if active_tab != 'status' %}active{% endif %}" id="accounts-ping-settings">
        <form method="post" action="/settings/accounts-ping" id="accounts-ping-form">
          <input type="hidden" name="active_tab" value="settings" />
          <input type="hidden" name="settings_tab" id="accounts-ping-settings-tab" value="{{ settings_tab or 'general' }}" />

          <ul class="nav nav-tabs" data-bs-toggle="tabs">
            <li class="nav-item"><a href="#accounts-ping-general" class="nav-link {% if settings_tab == 'general' %}active{% endif %}" data-bs-toggle="tab">General</a></li>
            <li class="nav-item"><a href="#accounts-ping-source" class="nav-link {% if settings_tab == 'source' %}active{% endif %}" data-bs-toggle="tab">Source</a></li>
            <li class="nav-item"><a href="#accounts-ping-classification" class="nav-link {% if settings_tab == 'classification' %}active{% endif %}" data-bs-toggle="tab">Classification</a></li>
            <li class="nav-item"><a href="#accounts-ping-storage" class="nav-link {% if settings_tab == 'storage' %}active{% endif %}" data-bs-toggle="tab">Storage</a></li>
            <li class="nav-item"><a href="#accounts-ping-danger" class="nav-link {% if settings_tab == 'danger' %}active{% endif %}" data-bs-toggle="tab">Danger</a></li>
          </ul>

          <div class="tab-content pt-3">
            <div class="tab-pane {% if settings_tab == 'general' %}active{% endif %}" id="accounts-ping-general">
              <div class="card mb-3">
                <div class="card-body">
                  <h5 class="mb-3">General</h5>
                  <div class="row g-3">
                    <div class="col-12">
                      <label class="form-label">Enable Accounts Ping <span class="info" data-tip="Turns Accounts Ping monitoring on/off. When disabled, no pings are sent.">i</span></label>
                      <label class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="enabled" {% if settings.enabled %}checked{% endif %} />
                        <span class="form-check-label">Enabled</span>
                      </label>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Base Interval (seconds) <span class="info" data-tip="Normal check interval per account (seconds). Under Surveillance can override this interval.">i</span></label>
                      <input class="form-control" type="number" name="base_interval_seconds" value="{{ settings.general.base_interval_seconds }}" min="1" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Max Parallel <span class="info" data-tip="Maximum number of concurrent pings per loop. Higher values increase load.">i</span></label>
                      <input class="form-control" type="number" name="max_parallel" value="{{ settings.general.max_parallel }}" min="1" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Ping Count <span class="info" data-tip="Number of ICMP echo requests per normal check. Higher count improves accuracy but increases load.">i</span></label>
                      <input class="form-control" type="number" name="ping_count" value="{{ settings.ping.count }}" min="1" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Ping Timeout (seconds) <span class="info" data-tip="Timeout per ICMP echo request in normal mode (seconds).">i</span></label>
                      <input class="form-control" type="number" name="ping_timeout_seconds" value="{{ settings.ping.timeout_seconds }}" min="1" />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane {% if settings_tab == 'source' %}active{% endif %}" id="accounts-ping-source">
              <div class="card mb-3">
                <div class="card-body">
                  <div class="alert alert-info">
                    <div class="d-flex align-items-start">
                      <span class="me-2"><i class="ti ti-info-circle"></i></span>
                      <div>Accounts Ping uses SSH to pull the ShapedDevices CSV and pings each IPv4 entry.</div>
                    </div>
                  </div>
                  <h5 class="mb-3">SSH Source</h5>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Host <span class="info" data-tip="SSH host that contains the ShapedDevices CSV file.">i</span></label>
                      <input class="form-control" type="text" name="ssh_host" value="{{ settings.ssh.host }}" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Port <span class="info" data-tip="SSH port (usually 22).">i</span></label>
                      <input class="form-control" type="number" name="ssh_port" value="{{ settings.ssh.port }}" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">User <span class="info" data-tip="SSH username for the remote host.">i</span></label>
                      <input class="form-control" type="text" name="ssh_user" value="{{ settings.ssh.user }}" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Password <span class="info" data-tip="SSH password (leave blank if using a private key).">i</span></label>
                      <input class="form-control" type="password" name="ssh_password" value="{{ settings.ssh.password }}" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Use SSH Key <span class="info" data-tip="Enable when authenticating with a private key file.">i</span></label>
                      <label class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="ssh_use_key" {% if settings.ssh.use_key %}checked{% endif %} />
                        <span class="form-check-label">Enabled</span>
                      </label>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Key Path <span class="info" data-tip="Path to the private key inside the container (leave blank if using password).">i</span></label>
                      <input class="form-control" type="text" name="ssh_key_path" value="{{ settings.ssh.key_path }}" placeholder="/data/id_rsa" />
                    </div>
                    <div class="col-md-9">
                      <label class="form-label">CSV Path <span class="info" data-tip="Remote path to the ShapedDevices CSV file to import accounts from.">i</span></label>
                      <input class="form-control" type="text" name="ssh_remote_csv_path" value="{{ settings.ssh.remote_csv_path }}" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Refresh (minutes) <span class="info" data-tip="How often to reload the CSV source into the Accounts Ping cache (minutes).">i</span></label>
                      <input class="form-control" type="number" name="source_refresh_minutes" value="{{ settings.source.refresh_minutes }}" min="1" />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane {% if settings_tab == 'classification' %}active{% endif %}" id="accounts-ping-classification">
              <div class="card mb-3">
                <div class="card-body">
                  <h5 class="mb-3">Classification</h5>
	                  <div class="row g-3">
	                    <div class="col-md-4">
	                      <label class="form-label">Issue Loss % (min) <span class="info" data-tip="Minimum packet loss percentage to classify a connection as an issue/monitor.">i</span></label>
	                      <input class="form-control" type="number" step="0.1" name="issue_loss_pct" value="{{ settings.classification.issue_loss_pct }}" />
	                    </div>
	                    <div class="col-md-4">
	                      <label class="form-label">Issue Latency ms (min) <span class="info" data-tip="Minimum average latency (ms) to classify a connection as an issue/monitor.">i</span></label>
	                      <input class="form-control" type="number" step="0.1" name="issue_latency_ms" value="{{ settings.classification.issue_latency_ms }}" />
	                    </div>
	                    <div class="col-md-4">
	                      <label class="form-label">Down Loss % <span class="info" data-tip="Loss threshold to treat a connection as down (usually 100%).">i</span></label>
	                      <input class="form-control" type="number" step="0.1" name="down_loss_pct" value="{{ settings.classification.down_loss_pct }}" />
	                    </div>
	                    <div class="col-md-4">
	                      <label class="form-label">Stable Fail % (max) <span class="info" data-tip="Up accounts with Fail % at or below this threshold are shown as Stable. Above this becomes Monitor.">i</span></label>
	                      <input class="form-control" type="number" step="0.1" name="stable_rto_pct" value="{{ settings.classification.stable_rto_pct }}" />
	                    </div>
	                    <div class="col-md-4">
	                      <label class="form-label">Issue Fail % (min) <span class="info" data-tip="Fail % at or above this threshold counts as an issue.">i</span></label>
	                      <input class="form-control" type="number" step="0.1" name="issue_rto_pct" value="{{ settings.classification.issue_rto_pct }}" />
	                    </div>
	                    <div class="col-md-4">
	                      <label class="form-label">Issue Streak (down) <span class="info" data-tip="Consecutive down checks required to add a streak reason for down accounts.">i</span></label>
	                      <input class="form-control" type="number" name="issue_streak" value="{{ settings.classification.issue_streak }}" min="1" />
	                    </div>
	                  </div>
	                </div>
	              </div>
            </div>
            <div class="tab-pane {% if settings_tab == 'storage' %}active{% endif %}" id="accounts-ping-storage">
              <div class="card mb-3">
                <div class="card-body">
                  <h5 class="mb-3">Storage</h5>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">Raw retention (days) <span class="info" data-tip="Days to keep per-check raw results for Accounts Ping.">i</span></label>
                      <input class="form-control" type="number" name="raw_retention_days" value="{{ settings.storage.raw_retention_days }}" min="1" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Rollup retention (days) <span class="info" data-tip="Days to keep rollups (bucketed summaries) for Accounts Ping.">i</span></label>
                      <input class="form-control" type="number" name="rollup_retention_days" value="{{ settings.storage.rollup_retention_days }}" min="1" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Rollup bucket (seconds) <span class="info" data-tip="Bucket size for rollups (seconds). Smaller buckets store more data.">i</span></label>
                      <input class="form-control" type="number" name="bucket_seconds" value="{{ settings.storage.bucket_seconds }}" min="30" />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane {% if settings_tab == 'danger' %}active{% endif %}" id="accounts-ping-danger">
              <div class="card mb-3">
                <div class="card-body">
                  <h4 class="mb-2">Format Accounts Ping Database</h4>
                  <div class="alert alert-warning">
                    <div class="d-flex align-items-center">
                      <span class="me-2"><i class="ti ti-alert-triangle"></i></span>
                      <div>Formatting removes stored Accounts Ping history so the next run starts fresh.</div>
                    </div>
                  </div>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="confirm_format" form="accounts-ping-format-form" />
                    <span class="form-check-label">I understand this will erase Accounts Ping history data. <span class="info" data-tip="Required to enable the Format button.">i</span></span>
                  </label>
                  <div class="mt-3">
                    <button type="submit" class="btn btn-danger" form="accounts-ping-format-form">Format Accounts Ping Database</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-end gap-2">
            <button type="submit" class="btn btn-primary">Save Accounts Ping Settings</button>
            <button type="submit" class="btn btn-outline-secondary" formaction="/settings/accounts-ping/test" formmethod="post">
              Test SSH & Load CSV
            </button>
          </div>
        </form>
        <form id="accounts-ping-format-form" method="post" action="/settings/accounts-ping/format"></form>
      </div>
    </div>
  </div>
</div>

	<script>
	  document.addEventListener("DOMContentLoaded", () => {
      const tabLinks = document.querySelectorAll('a[data-bs-toggle="tab"]');
      const tabKey = "accounts_ping_active_tab";
      const storedTab = localStorage.getItem(tabKey);
      if (window.location.hash) {
        const target = document.querySelector(`a[href="${window.location.hash}"]`);
        if (target && window.bootstrap?.Tab) {
          new window.bootstrap.Tab(target).show();
        }
      } else if (storedTab) {
        const target = document.querySelector(`a[href="${storedTab}"]`);
        if (target && window.bootstrap?.Tab) {
          new window.bootstrap.Tab(target).show();
        }
      }
      tabLinks.forEach((link) => {
        link.addEventListener("shown.bs.tab", (event) => {
          const href = event.target.getAttribute("href");
          if (href) {
            localStorage.setItem(tabKey, href);
            history.replaceState(null, "", href);
          }
        });
      });

      const setupServerSort = (table, prefix, hash) => {
        if (!table) return;
        const headers = Array.from(table.querySelectorAll("th.rto-sort"));
        if (!headers.length) return;
        const url = new URL(window.location.href);
        const activeKey = (url.searchParams.get(`${prefix}_sort`) || "").trim();
        const activeDir = ((url.searchParams.get(`${prefix}_dir`) || "desc").trim().toLowerCase() === "asc") ? "asc" : "desc";
        headers.forEach((th) => {
          const key = (th.dataset.sortKey || "").trim();
          const indicator = th.querySelector(".rto-sort-indicator");
          th.classList.remove("rto-sorted-asc", "rto-sorted-desc");
          th.setAttribute("aria-sort", "none");
          if (indicator) indicator.textContent = "";
          if (key && key === activeKey) {
            th.classList.add(activeDir === "asc" ? "rto-sorted-asc" : "rto-sorted-desc");
            th.setAttribute("aria-sort", activeDir === "asc" ? "ascending" : "descending");
            if (indicator) indicator.textContent = activeDir === "asc" ? "▲" : "▼";
          }
        });
        table.addEventListener("click", (event) => {
          const header = event.target.closest("th.rto-sort");
          if (!header || !table.contains(header)) return;
          const sortKey = (header.dataset.sortKey || "").trim();
          if (!sortKey) return;
          const nextDir = (sortKey === activeKey && activeDir === "asc") ? "desc" : "asc";
          const nextUrl = new URL(window.location.href);
          nextUrl.searchParams.set(`${prefix}_sort`, sortKey);
          nextUrl.searchParams.set(`${prefix}_dir`, nextDir);
          nextUrl.searchParams.set(`${prefix}_page`, "1");
          nextUrl.hash = hash;
          window.location.href = nextUrl.toString();
        });
      };

      const issuesTable = document.querySelector("#accounts-ping-issues table");
      const stableTable = document.querySelector("#accounts-ping-stable table");
      setupServerSort(issuesTable, "issues", "#accounts-ping-issues");
      setupServerSort(stableTable, "stable", "#accounts-ping-stable");

	      const searchEl = document.getElementById("accounts-ping-search");
	      if (searchEl) {
	        let lastValue = (searchEl.value || "").trim();
	        let timer = null;
	        const submit = () => {
	          const q = (searchEl.value || "").trim();
	          if (q === lastValue) return;
	          lastValue = q;
	          if (q && q.length < 2) return;
	          const url = new URL(window.location.href);
	          if (q) url.searchParams.set("q", q);
	          else url.searchParams.delete("q");
	          url.searchParams.set("issues_page", "1");
	          url.searchParams.set("stable_page", "1");
	          const tabHash = localStorage.getItem(tabKey) || window.location.hash;
	          if (tabHash) url.hash = tabHash;
	          window.location.href = url.toString();
	        };
	        searchEl.addEventListener("input", () => {
	          if (timer) clearTimeout(timer);
	          timer = setTimeout(submit, 350);
	        });
	        searchEl.addEventListener("keydown", (event) => {
	          if (event.key === "Enter") {
	            event.preventDefault();
	            if (timer) clearTimeout(timer);
	            submit();
	          }
	        });
	      }

      const windowBadge = document.getElementById("accounts-ping-status-window");
      const windowButton = document.getElementById("accounts-ping-window-button");
      const windowOptions = document.querySelectorAll(".accounts-ping-window-row");
      const windowStars = document.querySelectorAll(".accounts-ping-window-star-btn");
      const windowParam = new URLSearchParams(window.location.search).get("window");
      let defaultWindow = localStorage.getItem("accounts_ping_status_default_window");
      if (!defaultWindow) {
        defaultWindow = "24";
        localStorage.setItem("accounts_ping_status_default_window", defaultWindow);
      }
      const currentWindow = windowParam || "24";
      const updateStars = () => {
        windowStars.forEach((btn) => {
          const icon = btn.querySelector("i");
          if (!icon) return;
          if (btn.dataset.hours === defaultWindow) {
            icon.classList.remove("ti-star");
            icon.classList.add("ti-star-filled", "text-warning");
          } else {
            icon.classList.remove("ti-star-filled", "text-warning");
            icon.classList.add("ti-star");
          }
        });
      };
      const updateButtonLabel = () => {
        const label = windowBadge ? windowBadge.textContent.trim() : "1D";
        const isDefault = Boolean(windowParam) && currentWindow === defaultWindow;
        if (windowButton) {
          windowButton.textContent = isDefault ? `Filter: ${label} ⭐` : `Filter: ${label}`;
        }
      };
      updateStars();
      updateButtonLabel();
      windowOptions.forEach((row) => {
        row.addEventListener("click", () => {
          const hours = row.dataset.hours || "24";
          const url = new URL(window.location.href);
          url.searchParams.set("window", hours);
          url.searchParams.set("issues_page", "1");
          url.searchParams.set("stable_page", "1");
          const tabHash = localStorage.getItem(tabKey) || window.location.hash;
          if (tabHash) url.hash = tabHash;
          window.location.href = url.toString();
        });
      });
      windowStars.forEach((btn) => {
        btn.addEventListener("click", (event) => {
          event.preventDefault();
          event.stopPropagation();
          defaultWindow = btn.dataset.hours;
          localStorage.setItem("accounts_ping_status_default_window", defaultWindow);
          updateStars();
          updateButtonLabel();
        });
      });

      document.querySelectorAll(".accounts-ping-limit-row").forEach((row) => {
        row.addEventListener("click", () => {
          const limit = row.dataset.limit || "50";
          const url = new URL(window.location.href);
          url.searchParams.set("limit", limit);
          url.searchParams.set("issues_page", "1");
          url.searchParams.set("stable_page", "1");
          const tabHash = localStorage.getItem(tabKey) || window.location.hash;
          if (tabHash) url.hash = tabHash;
          window.location.href = url.toString();
        });
      });

    const settingsInput = document.getElementById("accounts-ping-settings-tab");
    if (settingsInput) {
      const settingsTabs = document.querySelectorAll('#accounts-ping-settings [data-bs-toggle="tabs"] .nav-link');
      settingsTabs.forEach((tab) => {
        tab.addEventListener("shown.bs.tab", (event) => {
          const target = event.target.getAttribute("href") || "";
          if (target.startsWith("#accounts-ping-")) {
            settingsInput.value = target.replace("#accounts-ping-", "");
          }
        });
      });
    }

	    const modalEl = document.getElementById("accounts-ping-spark-modal");
	    const modalTitle = document.getElementById("accounts-ping-spark-title");
	    const modalChart = document.getElementById("accounts-ping-spark-modal-chart");
	    const modalWindowButton = document.getElementById("accounts-ping-modal-window-button");
	    const modalWindowOptions = document.querySelectorAll(".accounts-ping-modal-window-option");
	    let modalAccountId = "";
	    let modalAccountName = "Account";
	    let modalAccountIp = "";
	    let chart = null;

	    const renderChart = async (name, accountId, hours) => {
	      if (!modalChart) return;
	      modalChart.innerHTML = "<div class='text-muted'>Loading…</div>";
      if (chart) {
        try { chart.destroy(); } catch (e) {}
        chart = null;
      }
	      try {
	        if (!window.ApexCharts) {
	          throw new Error("ApexCharts not loaded");
	        }
	        const params = new URLSearchParams({ account_id: accountId, window: String(hours) });
	        const res = await fetch(`/accounts-ping/series?${params.toString()}`, { headers: { "Accept": "application/json" }, cache: "no-store" });
	        if (!res.ok) throw new Error("fetch failed");
        const payload = await res.json();
        const points = (payload.series || []).map((row) => {
          const ts = row.ts ? Date.parse(String(row.ts)) : NaN;
          if (!Number.isFinite(ts)) return null;
          return { x: ts, loss: row.loss === null || row.loss === undefined ? null : Number(row.loss), avg_ms: row.avg_ms === null || row.avg_ms === undefined ? null : Number(row.avg_ms) };
        }).filter(Boolean);
        if (!points.length) throw new Error("no data");
        const latency = points.map((p) => ({ x: p.x, y: p.avg_ms }));
        const loss = points.map((p) => ({ x: p.x, y: p.loss }));
        modalChart.innerHTML = "";
	        chart = new window.ApexCharts(modalChart, {
	          chart: { type: "line", height: 260, toolbar: { show: false }, zoom: { enabled: false } },
	          stroke: { width: 2 },
	          markers: { size: 0 },
          series: [
            { name: "Latency (ms)", data: latency },
            { name: "Loss (%)", data: loss },
          ],
	          colors: ["#206bc4", "#d63939"],
	          xaxis: { type: "datetime" },
	          yaxis: [
	            { title: { text: "ms" } },
	            { opposite: true, min: 0, max: 100, tickAmount: 5, title: { text: "%" } },
	          ],
	          tooltip: {
	            shared: true,
	            intersect: false,
	            x: {
	              formatter: (value) => {
	                const dt = new Date(value);
	                if (Number.isNaN(dt.getTime())) return "";
	                return dt.toLocaleString("en-PH", {
	                  month: "short",
	                  day: "2-digit",
	                  hour: "2-digit",
	                  minute: "2-digit",
	                  hour12: true,
	                });
	              },
	            },
	          },
	          grid: { strokeDashArray: 4 },
	          legend: { position: "top" },
	        });
	        chart.render();
	        if (modalTitle) modalTitle.textContent = `${name}${modalAccountIp ? ` (${modalAccountIp})` : ""}`;
	      } catch (err) {
	        modalChart.innerHTML = "<div class='text-muted'>No data available.</div>";
	      }
	    };

	    const getDefaultHours = () => {
	      const urlParam = new URLSearchParams(window.location.search).get("window");
	      const stored = localStorage.getItem("accounts_ping_modal_window_hours");
	      const candidate = stored || urlParam || "24";
	      const parsed = parseInt(candidate, 10);
	      return Number.isNaN(parsed) ? 24 : parsed;
	    };

	    const setModalWindowLabel = (hours) => {
	      const match = Array.from(modalWindowOptions).find((btn) => parseInt(btn.dataset.hours || "", 10) === hours);
	      if (modalWindowButton) {
	        modalWindowButton.textContent = match ? (match.dataset.label || `${hours}h`) : `${hours}h`;
	      }
	    };

	    // Ensure modal isn't clipped by tab containers.
	    if (modalEl && modalEl.parentElement && modalEl.parentElement !== document.body) {
	      document.body.appendChild(modalEl);
	    }

	    document.querySelectorAll(".accounts-ping-spark-btn").forEach((btn) => {
	      btn.addEventListener("click", () => {
	        modalAccountId = btn.getAttribute("data-account-id") || "";
	        modalAccountName = btn.getAttribute("data-name") || "Account";
	        modalAccountIp = btn.getAttribute("data-ip") || "";
	        setModalWindowLabel(getDefaultHours());
	      });
	    });

	    modalWindowOptions.forEach((btn) => {
	      btn.addEventListener("click", async (event) => {
	        event.preventDefault();
	        if (!modalAccountId) return;
	        const hours = parseInt(btn.dataset.hours || "24", 10);
	        localStorage.setItem("accounts_ping_modal_window_hours", String(hours));
	        setModalWindowLabel(hours);
	        await renderChart(modalAccountName, modalAccountId, hours);
	      });
	    });

	    if (modalEl) {
	      modalEl.addEventListener("shown.bs.modal", async () => {
	        if (!modalAccountId) return;
	        const hours = getDefaultHours();
	        setModalWindowLabel(hours);
	        await renderChart(modalAccountName, modalAccountId, hours);
	      });

	      modalEl.addEventListener("hidden.bs.modal", () => {
	        if (chart) {
	          try { chart.destroy(); } catch (e) {}
	          chart = null;
	        }
	        if (modalChart) modalChart.innerHTML = "";
	        modalAccountId = "";
	        modalAccountName = "Account";
	        modalAccountIp = "";
	      });
	    }
	  });
	</script>
{% endblock %}
