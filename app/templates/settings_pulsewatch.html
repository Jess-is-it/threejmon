{% extends "base.html" %}
{% block content %}
<div class="card">
  <h2>ISP Pulsewatch</h2>
  {% if message %}
    <div class="alert">{{ message }}</div>
    <div id="pulsewatch_modal" style="position: fixed; inset: 0; background: rgba(0,0,0,0.45); display: flex; align-items: center; justify-content: center; z-index: 1000;">
      <div style="background: #fffdf4; border: 1px solid #d6d6cf; padding: 18px; border-radius: 10px; min-width: 320px; max-width: 720px; box-shadow: 0 10px 30px rgba(0,0,0,0.2);">
        <div style="display: flex; justify-content: space-between; align-items: center;">
          <strong>Pulsewatch Result</strong>
          <button type="button" id="pulsewatch_modal_close" style="border: none; background: transparent; font-size: 18px; cursor: pointer;">&times;</button>
        </div>
        <div style="margin-top: 10px; white-space: pre-wrap;">{{ message }}</div>
        <div style="margin-top: 14px; text-align: right;">
          <button type="button" class="button-blue" id="pulsewatch_modal_ok">OK</button>
        </div>
      </div>
    </div>
  {% endif %}

  <form method="post">
    <h3>Telegram</h3>
    <div class="form-grid">
      <div>
        <label>Bot Token <span class="info" data-tip="Telegram bot token from BotFather.">i</span></label>
        <input type="text" name="telegram_bot_token" value="{{ settings.telegram.bot_token }}" />
      </div>
      <div>
        <label>Alert Channel ID <span class="info" data-tip="Override channel ID for Pulsewatch alerts.">i</span></label>
        <input type="text" name="telegram_alert_channel_id" value="{{ settings.telegram.alert_channel_id }}" />
      </div>
    </div>

    <h3>Pulsewatch</h3>
    <div class="toggle" style="margin-bottom: 12px;">
      <input type="checkbox" name="pulsewatch_enabled" id="pulsewatch_enabled" {% if settings.pulsewatch.enabled %}checked{% endif %} />
      <label for="pulsewatch_enabled">Enable ISP Pulsewatch</label>
    </div>

    <div class="form-grid">
      <div>
        <label>Auto-manage MikroTik address-lists <span class="info" data-tip="Keeps TO-ISP# address-lists in sync for Pulsewatch source IPs.">i</span></label>
        <input type="checkbox" name="pulsewatch_manage_address_lists" {% if settings.pulsewatch.manage_address_lists %}checked{% endif %} />
      </div>
      <div>
        <label>Reconcile Interval (minutes) <span class="info" data-tip="How often to reconcile MikroTik address-lists.">i</span></label>
        <input type="number" name="pulsewatch_reconcile_interval_minutes" value="{{ settings.pulsewatch.reconcile_interval_minutes }}" />
      </div>
      <div>
        <label>Store raw output <span class="info" data-tip="Persist raw ping/speedtest output in the database.">i</span></label>
        <input type="checkbox" name="pulsewatch_store_raw_output" {% if settings.pulsewatch.store_raw_output %}checked{% endif %} />
      </div>
    </div>
    <div class="help">MikroTik API credentials are managed under System Settings.</div>

    <h4 style="margin-top: 18px;">Pulsewatch Speedtest</h4>
    <div class="form-grid">
      <div>
        <label>Enable Speedtest</label>
        <input type="checkbox" name="speedtest_enabled" {% if settings.pulsewatch.speedtest.enabled %}checked{% endif %} />
      </div>
      <div>
        <label>Min Interval (minutes)</label>
        <input type="number" name="speedtest_min_interval_minutes" value="{{ settings.pulsewatch.speedtest.min_interval_minutes }}" />
      </div>
      <div>
        <label>Command</label>
        <input type="text" name="speedtest_command" value="{{ settings.pulsewatch.speedtest.command }}" />
      </div>
      <div>
        <label>Args</label>
        <input type="text" name="speedtest_args" value="{{ settings.pulsewatch.speedtest.args }}" />
      </div>
      <div>
        <label>Use network namespaces</label>
        <input type="checkbox" name="speedtest_use_netns" {% if settings.pulsewatch.speedtest.use_netns %}checked{% endif %} />
      </div>
      <div>
        <label>Netns Prefix</label>
        <input type="text" name="speedtest_netns_prefix" value="{{ settings.pulsewatch.speedtest.netns_prefix }}" />
      </div>
    </div>

    <h4 style="margin-top: 18px;">Pulsewatch Presets</h4>
    <div class="help">Lists are loaded from each MikroTik. Fill in the IP address for the list entry you want added.</div>
    {% set cores = settings.pulsewatch.mikrotik.cores %}
    <div style="display: flex; justify-content: space-between; align-items: center; margin: 12px 0;">
      <div>
        <input type="text" id="pulsewatch_search" placeholder="Search list..." style="min-width: 220px;" />
      </div>
      <div>
        <button type="submit" formaction="/settings/pulsewatch/test" formmethod="post" style="margin-left: 6px;">Send Test Telegram</button>
        <button type="button" class="button-blue" id="pulsewatch_ping_all" style="margin-left: 6px;">Run Ping All</button>
        <button type="submit" formaction="/isp/pulsewatch/speedtest" formmethod="post" style="margin-left: 6px;">Run Speedtest All</button>
      </div>
    </div>

    <div style="overflow-x: auto;">
      <table id="pulsewatch_table" style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th data-sort="text" title="Which MikroTik router this preset belongs to." style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf; cursor: pointer;">MikroTik</th>
            <th data-sort="text" title="Address-list name pulled from the MikroTik firewall." style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf; cursor: pointer;">List</th>
            <th data-sort="text" title="Source IP to bind for this list (used by ping/speedtest)." style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf; cursor: pointer;">IP Address</th>
            <th data-sort="number" title="Latency threshold (ms) before a breach is counted." style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf; cursor: pointer;">Latency</th>
            <th data-sort="number" title="Packet loss threshold (%) before a breach is counted." style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf; cursor: pointer;">Loss</th>
            <th data-sort="number" title="How many consecutive breaches trigger an alert." style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf; cursor: pointer;">Breaches</th>
            <th data-sort="number" title="Cooldown minutes after an alert to avoid repeats." style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf; cursor: pointer;">Cooldown</th>
            <th data-sort="text" title="Ping targets (one per line) to test for this list." style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf; cursor: pointer;">Targets</th>
            <th title="Run ping/speedtest actions for this preset." style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf;">Actions</th>
          </tr>
        </thead>
        <tbody>
          <input type="hidden" name="preset_count" value="{{ preset_rows|length }}" />
          {% for row in preset_rows %}
            <tr class="pulsewatch-row">
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                {{ row.core_label }}
                <input type="hidden" name="preset_{{ loop.index0 }}_core_id" value="{{ row.core_id }}" />
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                {{ row.list_name }}
                <input type="hidden" name="preset_{{ loop.index0 }}_list" value="{{ row.list_name }}" />
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                <input type="text" name="preset_{{ loop.index0 }}_address" value="{{ row.address }}" />
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                <input type="number" name="preset_{{ loop.index0 }}_latency_ms" value="{{ row.latency_ms }}" style="max-width: 90px;" />
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                <input type="number" name="preset_{{ loop.index0 }}_loss_pct" value="{{ row.loss_pct }}" style="max-width: 70px;" />
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                <input type="number" name="preset_{{ loop.index0 }}_breach_count" value="{{ row.breach_count }}" style="max-width: 70px;" />
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                <input type="number" name="preset_{{ loop.index0 }}_cooldown_minutes" value="{{ row.cooldown_minutes }}" style="max-width: 80px;" />
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                <textarea name="preset_{{ loop.index0 }}_ping_targets" style="min-width: 160px; min-height: 60px;">{% for target in row.ping_targets %}{{ target }}
{% endfor %}</textarea>
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #efefe7; white-space: nowrap;">
                <button type="button" class="button-blue pulsewatch-ping" title="Run Ping" data-row-id="{{ row.row_id }}">P</button>
                <button type="submit" title="Run Speedtest" formaction="/isp/pulsewatch/speedtest/{{ row.row_id }}" formmethod="post">S</button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div style="margin-top: 16px;">
      <button type="submit" class="button-green">Save ISP Pulsewatch Settings</button>
    </div>
  </form>
</div>

  <div id="pulsewatch_stream_modal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.55); align-items: center; justify-content: center; z-index: 1000;">
  <div style="background: #0f172a; color: #e2e8f0; border: 1px solid #1f2937; padding: 16px; border-radius: 10px; width: 80vw; max-width: 1100px; max-height: 80vh; display: flex; flex-direction: column;">
    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
      <strong id="pulsewatch_stream_title">Live Ping</strong>
      <button type="button" id="pulsewatch_stream_close" style="border: none; background: transparent; font-size: 18px; color: #e2e8f0; cursor: pointer;">&times;</button>
    </div>
    <div id="pulsewatch_stream_targets" style="display: none; gap: 6px; flex-wrap: wrap; margin-bottom: 10px;"></div>
    <div style="font-size: 12px; color: #94a3b8; margin-bottom: 8px;">Live ping output. Closing the modal stops this manual ping.</div>
    <pre id="pulsewatch_stream_output" style="flex: 1; overflow: auto; margin: 0; padding: 10px; background: #0b1020; border: 1px solid #1f2937; border-radius: 8px; white-space: pre-wrap;"></pre>
    <div style="margin-top: 12px; text-align: right;">
      <button type="button" class="button-blue" id="pulsewatch_stream_stop">Stop</button>
    </div>
  </div>
</div>

<script>
  const modal = document.getElementById("pulsewatch_modal");
  const closeBtn = document.getElementById("pulsewatch_modal_close");
  const okBtn = document.getElementById("pulsewatch_modal_ok");

  const closeModal = () => {
    if (modal) {
      modal.style.display = "none";
    }
  };

  if (closeBtn) {
    closeBtn.addEventListener("click", closeModal);
  }
  if (okBtn) {
    okBtn.addEventListener("click", closeModal);
  }
  if (modal) {
    modal.addEventListener("click", (event) => {
      if (event.target === modal) {
        closeModal();
      }
    });
  }

  const streamModal = document.getElementById("pulsewatch_stream_modal");
  const streamOutput = document.getElementById("pulsewatch_stream_output");
  const streamTitle = document.getElementById("pulsewatch_stream_title");
  const streamClose = document.getElementById("pulsewatch_stream_close");
  const streamStop = document.getElementById("pulsewatch_stream_stop");
  const streamTargets = document.getElementById("pulsewatch_stream_targets");
  let streamSource = null;
  let streamBase = "";
  let streamParams = {};

  const buildStreamUrl = (baseUrl, params) => {
    const search = new URLSearchParams();
    Object.entries(params || {}).forEach(([key, value]) => {
      if (value) {
        search.set(key, value);
      }
    });
    const query = search.toString();
    return query ? `${baseUrl}?${query}` : baseUrl;
  };

  const renderTargets = (targets, baseUrl, params) => {
    if (!streamTargets) {
      return;
    }
    streamTargets.innerHTML = "";
    if (!targets || targets.length === 0) {
      streamTargets.style.display = "none";
      return;
    }
    streamTargets.style.display = "flex";
    targets.forEach((target, index) => {
      const btn = document.createElement("button");
      btn.type = "button";
      btn.textContent = target;
      btn.className = "button-blue";
      if (index !== 0) {
        btn.style.opacity = "0.75";
      }
      btn.addEventListener("click", () => {
        streamParams = { ...params, target };
        openStream(streamTitle.textContent, buildStreamUrl(baseUrl, streamParams));
        Array.from(streamTargets.children).forEach((child) => {
          child.style.opacity = child === btn ? "1" : "0.75";
        });
      });
      streamTargets.appendChild(btn);
    });
  };

  const openStream = (title, url) => {
    if (!streamModal || !streamOutput) {
      return;
    }
    if (streamSource) {
      streamSource.close();
    }
    streamTitle.textContent = title;
    streamOutput.textContent = "";
    streamModal.style.display = "flex";
    streamSource = new EventSource(url);
    streamSource.onmessage = (event) => {
      streamOutput.textContent += `${event.data}\n`;
      streamOutput.scrollTop = streamOutput.scrollHeight;
    };
    streamSource.addEventListener("done", () => {
      streamSource.close();
      streamSource = null;
    });
    streamSource.onerror = () => {
      if (streamSource) {
        streamSource.close();
        streamSource = null;
      }
      streamOutput.textContent += "Stream closed.\n";
    };
  };

  const openStreamWithTargets = (title, baseUrl, params, targets) => {
    streamBase = baseUrl;
    streamParams = params || {};
    const targetList = (targets || []).filter((value) => value && value.trim().length);
    if (targetList.length > 0) {
      streamParams = { ...streamParams, target: targetList[0] };
    }
    renderTargets(targetList, baseUrl, params);
    openStream(title, buildStreamUrl(baseUrl, streamParams));
  };

  const closeStream = () => {
    if (streamSource) {
      streamSource.close();
      streamSource = null;
    }
    if (streamModal) {
      streamModal.style.display = "none";
    }
    if (streamTargets) {
      streamTargets.innerHTML = "";
      streamTargets.style.display = "none";
    }
  };

  if (streamClose) {
    streamClose.addEventListener("click", closeStream);
  }
  if (streamStop) {
    streamStop.addEventListener("click", closeStream);
  }
  if (streamModal) {
    streamModal.addEventListener("click", (event) => {
      if (event.target === streamModal) {
        closeStream();
      }
    });
  }

  const pingButtons = document.querySelectorAll(".pulsewatch-ping");
  pingButtons.forEach((button) => {
    button.addEventListener("click", () => {
      const rowId = button.getAttribute("data-row-id");
      if (!rowId) {
        return;
      }
      const row = button.closest("tr");
      const addressInput = row ? row.querySelector("input[name$='_address']") : null;
      const targetInput = row ? row.querySelector("textarea[name$='_ping_targets']") : null;
      const labelCore = row ? row.querySelector("td:nth-child(1)") : null;
      const labelList = row ? row.querySelector("td:nth-child(2)") : null;
      const sourceIp = addressInput ? (addressInput.value || "").trim() : "";
      const targets = targetInput ? (targetInput.value || "").trim().split("\n") : [];
      const label = `${labelCore ? labelCore.textContent.trim() : ""} ${labelList ? labelList.textContent.trim() : ""}`.trim();
      const params = {};
      if (sourceIp) {
        params.source_ip = sourceIp;
      }
      if (label) {
        params.label = label;
      }
      openStreamWithTargets("Live Ping (Single ISP)", `/isp/pulsewatch/ping/stream/${rowId}`, params, targets);
    });
  });

  const pingAllButton = document.getElementById("pulsewatch_ping_all");
  if (pingAllButton) {
    pingAllButton.addEventListener("click", () => {
      openStream("Live Ping (All ISPs)", "/isp/pulsewatch/ping/stream");
    });
  }

  const searchInput = document.getElementById("pulsewatch_search");
  const rows = document.querySelectorAll("#pulsewatch_table .pulsewatch-row");

  const filterRows = () => {
    const query = (searchInput.value || "").toLowerCase();
    rows.forEach((row) => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(query) ? "" : "none";
    });
  };

  if (searchInput) {
    searchInput.addEventListener("input", filterRows);
  }

  const table = document.getElementById("pulsewatch_table");
  if (table) {
    const headers = table.querySelectorAll("thead th[data-sort]");
    const tbody = table.querySelector("tbody");
    const sortState = {};

    const getCellValue = (row, index) => {
      const cell = row.children[index];
      if (!cell) {
        return "";
      }
      const input = cell.querySelector("input, textarea");
      if (input) {
        return (input.value || "").trim();
      }
      return (cell.textContent || "").trim();
    };

    headers.forEach((header, index) => {
      header.addEventListener("click", () => {
        const type = header.getAttribute("data-sort") || "text";
        const current = sortState[index] || "asc";
        const next = current === "asc" ? "desc" : "asc";
        sortState[index] = next;

        const sorted = Array.from(tbody.querySelectorAll("tr.pulsewatch-row"));
        sorted.sort((a, b) => {
          const aVal = getCellValue(a, index);
          const bVal = getCellValue(b, index);
          if (type === "number") {
            const aNum = parseFloat(aVal) || 0;
            const bNum = parseFloat(bVal) || 0;
            return next === "asc" ? aNum - bNum : bNum - aNum;
          }
          const compare = aVal.localeCompare(bVal, undefined, { numeric: true, sensitivity: "base" });
          return next === "asc" ? compare : -compare;
        });

        sorted.forEach((row) => tbody.appendChild(row));
      });
    });
  }
</script>
{% endblock %}
