{% extends "base.html" %}
{% block content %}
<div class="card">
  <h2>ISP Pulsewatch</h2>
  {% if message %}
    <div class="alert">{{ message }}</div>
  {% endif %}

  <form method="post">
    <h3>Telegram</h3>
    <div class="form-grid">
      <div>
        <label>Bot Token <span class="info" data-tip="Telegram bot token from BotFather.">i</span></label>
        <input type="text" name="telegram_bot_token" value="{{ settings.telegram.bot_token }}" />
      </div>
      <div>
        <label>Chat ID <span class="info" data-tip="Target Telegram chat ID where alerts should be sent.">i</span></label>
        <input type="text" name="telegram_chat_id" value="{{ settings.telegram.chat_id }}" />
      </div>
      <div>
        <label>Alert Channel ID <span class="info" data-tip="Override channel ID for Pulsewatch alerts.">i</span></label>
        <input type="text" name="telegram_alert_channel_id" value="{{ settings.telegram.alert_channel_id }}" />
      </div>
      <div>
        <label>Allowed User IDs <span class="info" data-tip="One Telegram user ID per line for future commands.">i</span></label>
        <textarea name="telegram_allowed_user_ids">{% for user_id in settings.telegram.allowed_user_ids %}{{ user_id }}
{% endfor %}</textarea>
      </div>
    </div>

    <h3>Pulsewatch</h3>
    <div class="toggle" style="margin-bottom: 12px;">
      <input type="checkbox" name="pulsewatch_enabled" id="pulsewatch_enabled" {% if settings.pulsewatch.enabled %}checked{% endif %} />
      <label for="pulsewatch_enabled">Enable ISP Pulsewatch</label>
    </div>

    <div class="form-grid">
      <div>
        <label>Auto-manage MikroTik address-lists <span class="info" data-tip="Keeps TO-ISP# address-lists in sync for Pulsewatch source IPs.">i</span></label>
        <input type="checkbox" name="pulsewatch_manage_address_lists" {% if settings.pulsewatch.manage_address_lists %}checked{% endif %} />
      </div>
      <div>
        <label>Reconcile Interval (minutes) <span class="info" data-tip="How often to reconcile MikroTik address-lists.">i</span></label>
        <input type="number" name="pulsewatch_reconcile_interval_minutes" value="{{ settings.pulsewatch.reconcile_interval_minutes }}" />
      </div>
      <div>
        <label>Store raw output <span class="info" data-tip="Persist raw ping/speedtest output in the database.">i</span></label>
        <input type="checkbox" name="pulsewatch_store_raw_output" {% if settings.pulsewatch.store_raw_output %}checked{% endif %} />
      </div>
    </div>
    <div class="help">MikroTik API credentials are managed under System Settings.</div>

    <h4 style="margin-top: 18px;">Pulsewatch Speedtest</h4>
    <div class="form-grid">
      <div>
        <label>Enable Speedtest</label>
        <input type="checkbox" name="speedtest_enabled" {% if settings.pulsewatch.speedtest.enabled %}checked{% endif %} />
      </div>
      <div>
        <label>Min Interval (minutes)</label>
        <input type="number" name="speedtest_min_interval_minutes" value="{{ settings.pulsewatch.speedtest.min_interval_minutes }}" />
      </div>
      <div>
        <label>Command</label>
        <input type="text" name="speedtest_command" value="{{ settings.pulsewatch.speedtest.command }}" />
      </div>
      <div>
        <label>Args</label>
        <input type="text" name="speedtest_args" value="{{ settings.pulsewatch.speedtest.args }}" />
      </div>
      <div>
        <label>Use network namespaces</label>
        <input type="checkbox" name="speedtest_use_netns" {% if settings.pulsewatch.speedtest.use_netns %}checked{% endif %} />
      </div>
      <div>
        <label>Netns Prefix</label>
        <input type="text" name="speedtest_netns_prefix" value="{{ settings.pulsewatch.speedtest.netns_prefix }}" />
      </div>
    </div>

    <h4 style="margin-top: 18px;">ISP Profiles</h4>
    <div class="help">Add or remove ISPs as needed. Source IPs are bound to MikroTik cores configured under System Settings.</div>
    {% set cores = settings.pulsewatch.mikrotik.cores %}
    <div style="display: flex; justify-content: space-between; align-items: center; margin: 12px 0;">
      <div>
        <input type="text" id="pulsewatch_search" placeholder="Search ISP..." style="min-width: 220px;" />
      </div>
      <div>
        <button type="button" id="open_add_isp">Add ISP</button>
        <button type="submit" formaction="/settings/pulsewatch/test" formmethod="post" style="margin-left: 6px;">Send Test Telegram</button>
        <button type="submit" class="button-blue" formaction="/isp/pulsewatch/ping" formmethod="post" style="margin-left: 6px;">Run Ping All</button>
        <button type="submit" formaction="/isp/pulsewatch/speedtest" formmethod="post" style="margin-left: 6px;">Run Speedtest All</button>
      </div>
    </div>

    <div style="overflow-x: auto;">
      <table id="pulsewatch_table" style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf;">ID</th>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf;">Label</th>
            {% for core in cores %}
              <th style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf;">Src IP ({{ core.label }})</th>
            {% endfor %}
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf;">Ping Core</th>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf;">Latency</th>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf;">Loss</th>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf;">Breaches</th>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf;">Cooldown</th>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf;">Targets</th>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf;">Actions</th>
          </tr>
        </thead>
        <tbody>
          {% for isp in settings.pulsewatch.isps %}
            {% set sources = isp.sources if isp.sources is defined else {} %}
            <tr class="pulsewatch-row">
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">{{ isp.id }}</td>
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                <input type="text" name="{{ isp.id }}_label" value="{{ isp.label }}" />
              </td>
              {% for core in cores %}
                <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                  <input type="text" name="{{ isp.id }}_source_{{ core.id }}" value="{{ sources.get(core.id, '') }}" />
                </td>
              {% endfor %}
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                <select name="{{ isp.id }}_ping_core_id">
                  <option value="auto" {% if isp.ping_core_id == 'auto' %}selected{% endif %}>auto</option>
                  {% for core in cores %}
                    <option value="{{ core.id }}" {% if isp.ping_core_id == core.id %}selected{% endif %}>{{ core.label }}</option>
                  {% endfor %}
                </select>
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                <input type="number" name="{{ isp.id }}_latency_ms" value="{{ isp.thresholds.latency_ms }}" style="max-width: 90px;" />
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                <input type="number" name="{{ isp.id }}_loss_pct" value="{{ isp.thresholds.loss_pct }}" style="max-width: 70px;" />
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                <input type="number" name="{{ isp.id }}_breach_count" value="{{ isp.consecutive_breach_count }}" style="max-width: 70px;" />
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                <input type="number" name="{{ isp.id }}_cooldown_minutes" value="{{ isp.cooldown_minutes }}" style="max-width: 80px;" />
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                <textarea name="{{ isp.id }}_ping_targets" style="min-width: 160px; min-height: 60px;">{% for target in isp.ping_targets %}{{ target }}
{% endfor %}</textarea>
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #efefe7; white-space: nowrap;">
                <button type="submit" class="button-blue" title="Run Ping" formaction="/isp/pulsewatch/ping/{{ isp.id }}" formmethod="post">P</button>
                <button type="submit" title="Run Speedtest" formaction="/isp/pulsewatch/speedtest/{{ isp.id }}" formmethod="post">S</button>
                <button type="submit" title="Remove ISP" formaction="/settings/pulsewatch/isp/remove/{{ isp.id }}" formmethod="post">X</button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div style="margin-top: 16px;">
      <button type="submit" class="button-green">Save ISP Pulsewatch Settings</button>
    </div>
  </form>
</div>

<div id="addIspModal" style="display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.45); z-index: 1000;">
  <div style="background: #fff; max-width: 720px; margin: 6% auto; padding: 16px; border-radius: 12px;">
    <h3 style="margin-top: 0;">Add ISP</h3>
    <form method="post" action="/settings/pulsewatch/isp/create">
      <div class="form-grid">
        <div>
          <label>ISP ID (optional)</label>
          <input type="text" name="new_id" placeholder="isp10" />
        </div>
        <div>
          <label>Label</label>
          <input type="text" name="new_label" placeholder="My ISP" />
        </div>
        {% for core in cores %}
          <div>
            <label>Source IP ({{ core.label }})</label>
            <input type="text" name="new_source_{{ core.id }}" />
          </div>
        {% endfor %}
        <div>
          <label>Ping Source Core</label>
          <select name="new_ping_core_id">
            <option value="auto">auto</option>
            {% for core in cores %}
              <option value="{{ core.id }}">{{ core.label }}</option>
            {% endfor %}
          </select>
        </div>
        <div>
          <label>Latency Threshold (ms)</label>
          <input type="number" name="new_latency_ms" value="120" />
        </div>
        <div>
          <label>Loss Threshold (%)</label>
          <input type="number" name="new_loss_pct" value="20" />
        </div>
        <div>
          <label>Consecutive Breaches</label>
          <input type="number" name="new_breach_count" value="3" />
        </div>
        <div>
          <label>Cooldown Minutes</label>
          <input type="number" name="new_cooldown_minutes" value="10" />
        </div>
      </div>
      <label style="margin-top: 10px;">Ping Targets (one per line)</label>
      <textarea name="new_ping_targets" style="width: 100%; min-height: 90px;">1.1.1.1
8.8.8.8</textarea>
      <div style="margin-top: 12px; display: flex; justify-content: flex-end; gap: 8px;">
        <button type="button" id="cancel_add_isp">Cancel</button>
        <button type="submit" class="button-green">Save</button>
      </div>
    </form>
  </div>
</div>

<script>
  const searchInput = document.getElementById("pulsewatch_search");
  const rows = document.querySelectorAll("#pulsewatch_table .pulsewatch-row");
  const openAdd = document.getElementById("open_add_isp");
  const addModal = document.getElementById("addIspModal");
  const cancelAdd = document.getElementById("cancel_add_isp");

  const filterRows = () => {
    const query = (searchInput.value || "").toLowerCase();
    rows.forEach((row) => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(query) ? "" : "none";
    });
  };

  if (searchInput) {
    searchInput.addEventListener("input", filterRows);
  }
  if (openAdd && addModal) {
    openAdd.addEventListener("click", () => {
      addModal.style.display = "block";
    });
  }
  if (cancelAdd && addModal) {
    cancelAdd.addEventListener("click", () => {
      addModal.style.display = "none";
    });
  }
  if (addModal) {
    addModal.addEventListener("click", (event) => {
      if (event.target === addModal) {
        addModal.style.display = "none";
      }
    });
  }
</script>
{% endblock %}
