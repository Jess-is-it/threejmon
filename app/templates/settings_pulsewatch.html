{% extends "base.html" %}
{% block content %}
<div class="card">
  <h2>ISP Pulsewatch</h2>
  {% if message %}
    <div class="alert">{{ message }}</div>
  {% endif %}

  <form method="post">
    <h3>Telegram</h3>
    <div class="form-grid">
      <div>
        <label>Bot Token <span class="info" data-tip="Telegram bot token from BotFather.">i</span></label>
        <input type="text" name="telegram_bot_token" value="{{ settings.telegram.bot_token }}" />
      </div>
      <div>
        <label>Chat ID <span class="info" data-tip="Target Telegram chat ID where alerts should be sent.">i</span></label>
        <input type="text" name="telegram_chat_id" value="{{ settings.telegram.chat_id }}" />
      </div>
      <div>
        <label>Alert Channel ID <span class="info" data-tip="Override channel ID for Pulsewatch alerts.">i</span></label>
        <input type="text" name="telegram_alert_channel_id" value="{{ settings.telegram.alert_channel_id }}" />
      </div>
      <div>
        <label>Allowed User IDs <span class="info" data-tip="One Telegram user ID per line for future commands.">i</span></label>
        <textarea name="telegram_allowed_user_ids">{% for user_id in settings.telegram.allowed_user_ids %}{{ user_id }}
{% endfor %}</textarea>
      </div>
    </div>

    <h3>Pulsewatch</h3>
    <div class="toggle" style="margin-bottom: 12px;">
      <input type="checkbox" name="pulsewatch_enabled" id="pulsewatch_enabled" {% if settings.pulsewatch.enabled %}checked{% endif %} />
      <label for="pulsewatch_enabled">Enable ISP Pulsewatch</label>
    </div>

    <div class="form-grid">
      <div>
        <label>Auto-manage MikroTik address-lists <span class="info" data-tip="Keeps TO-ISP# address-lists in sync for Pulsewatch source IPs.">i</span></label>
        <input type="checkbox" name="pulsewatch_manage_address_lists" {% if settings.pulsewatch.manage_address_lists %}checked{% endif %} />
      </div>
      <div>
        <label>Reconcile Interval (minutes) <span class="info" data-tip="How often to reconcile MikroTik address-lists.">i</span></label>
        <input type="number" name="pulsewatch_reconcile_interval_minutes" value="{{ settings.pulsewatch.reconcile_interval_minutes }}" />
      </div>
      <div>
        <label>Store raw output <span class="info" data-tip="Persist raw ping/speedtest output in the database.">i</span></label>
        <input type="checkbox" name="pulsewatch_store_raw_output" {% if settings.pulsewatch.store_raw_output %}checked{% endif %} />
      </div>
    </div>
    <div class="help">MikroTik API credentials are managed under System Settings.</div>

    <h4 style="margin-top: 18px;">Pulsewatch Speedtest</h4>
    <div class="form-grid">
      <div>
        <label>Enable Speedtest</label>
        <input type="checkbox" name="speedtest_enabled" {% if settings.pulsewatch.speedtest.enabled %}checked{% endif %} />
      </div>
      <div>
        <label>Min Interval (minutes)</label>
        <input type="number" name="speedtest_min_interval_minutes" value="{{ settings.pulsewatch.speedtest.min_interval_minutes }}" />
      </div>
      <div>
        <label>Command</label>
        <input type="text" name="speedtest_command" value="{{ settings.pulsewatch.speedtest.command }}" />
      </div>
      <div>
        <label>Args</label>
        <input type="text" name="speedtest_args" value="{{ settings.pulsewatch.speedtest.args }}" />
      </div>
      <div>
        <label>Use network namespaces</label>
        <input type="checkbox" name="speedtest_use_netns" {% if settings.pulsewatch.speedtest.use_netns %}checked{% endif %} />
      </div>
      <div>
        <label>Netns Prefix</label>
        <input type="text" name="speedtest_netns_prefix" value="{{ settings.pulsewatch.speedtest.netns_prefix }}" />
      </div>
    </div>

    <h4 style="margin-top: 18px;">Pulsewatch Presets</h4>
    <div class="help">Lists are loaded from each MikroTik. Fill in the IP address for the list entry you want added.</div>
    {% set cores = settings.pulsewatch.mikrotik.cores %}
    <div style="display: flex; justify-content: space-between; align-items: center; margin: 12px 0;">
      <div>
        <input type="text" id="pulsewatch_search" placeholder="Search list..." style="min-width: 220px;" />
      </div>
      <div>
        <button type="submit" formaction="/settings/pulsewatch/test" formmethod="post" style="margin-left: 6px;">Send Test Telegram</button>
        <button type="submit" class="button-blue" formaction="/isp/pulsewatch/ping" formmethod="post" style="margin-left: 6px;">Run Ping All</button>
        <button type="submit" formaction="/isp/pulsewatch/speedtest" formmethod="post" style="margin-left: 6px;">Run Speedtest All</button>
      </div>
    </div>

    <div style="overflow-x: auto;">
      <table id="pulsewatch_table" style="width: 100%; border-collapse: collapse;">
        <thead>
          <tr>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf;">MikroTik</th>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf;">List</th>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf;">IP Address</th>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf;">Latency</th>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf;">Loss</th>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf;">Breaches</th>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf;">Cooldown</th>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf;">Targets</th>
            <th style="text-align: left; padding: 8px; border-bottom: 1px solid #d6d6cf;">Actions</th>
          </tr>
        </thead>
        <tbody>
          <input type="hidden" name="preset_count" value="{{ preset_rows|length }}" />
          {% for row in preset_rows %}
            <tr class="pulsewatch-row">
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                {{ row.core_label }}
                <input type="hidden" name="preset_{{ loop.index0 }}_core_id" value="{{ row.core_id }}" />
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                {{ row.list_name }}
                <input type="hidden" name="preset_{{ loop.index0 }}_list" value="{{ row.list_name }}" />
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                <input type="text" name="preset_{{ loop.index0 }}_address" value="{{ row.address }}" />
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                <input type="number" name="preset_{{ loop.index0 }}_latency_ms" value="{{ row.latency_ms }}" style="max-width: 90px;" />
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                <input type="number" name="preset_{{ loop.index0 }}_loss_pct" value="{{ row.loss_pct }}" style="max-width: 70px;" />
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                <input type="number" name="preset_{{ loop.index0 }}_breach_count" value="{{ row.breach_count }}" style="max-width: 70px;" />
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                <input type="number" name="preset_{{ loop.index0 }}_cooldown_minutes" value="{{ row.cooldown_minutes }}" style="max-width: 80px;" />
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #efefe7;">
                <textarea name="preset_{{ loop.index0 }}_ping_targets" style="min-width: 160px; min-height: 60px;">{% for target in row.ping_targets %}{{ target }}
{% endfor %}</textarea>
              </td>
              <td style="padding: 8px; border-bottom: 1px solid #efefe7; white-space: nowrap;">
                <button type="submit" class="button-blue" title="Run Ping" formaction="/isp/pulsewatch/ping/{{ row.row_id }}" formmethod="post">P</button>
                <button type="submit" title="Run Speedtest" formaction="/isp/pulsewatch/speedtest/{{ row.row_id }}" formmethod="post">S</button>
              </td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

    <div style="margin-top: 16px;">
      <button type="submit" class="button-green">Save ISP Pulsewatch Settings</button>
    </div>
  </form>
</div>

<script>
  const searchInput = document.getElementById("pulsewatch_search");
  const rows = document.querySelectorAll("#pulsewatch_table .pulsewatch-row");

  const filterRows = () => {
    const query = (searchInput.value || "").toLowerCase();
    rows.forEach((row) => {
      const text = row.textContent.toLowerCase();
      row.style.display = text.includes(query) ? "" : "none";
    });
  };

  if (searchInput) {
    searchInput.addEventListener("input", filterRows);
  }
</script>
{% endblock %}
