{% extends "base.html" %}
{% block content %}
<div class="card">
  <h2>System Settings</h2>
  {% if message %}
    <div class="alert">{{ message }}</div>
  {% endif %}
</div>

<div class="card" style="margin-top: 20px;">
  <h2>MikroTik API (Pulsewatch)</h2>
  <form method="post" action="/settings/system/mikrotik">
    {% set cores = settings.pulsewatch.mikrotik.cores %}
    {% set interface_options = interfaces if interfaces is defined else [] %}
    <textarea name="core_ids" style="display: none;">{% for core in cores %}{{ core.id }}
{% endfor %}</textarea>
    {% for core in cores %}
      <div style="margin-top: 12px; padding: 12px; border: 1px dashed #c4c6bf; border-radius: 12px;">
        <div style="font-weight: 700; margin-bottom: 8px;">{{ core.label }}</div>
        <div class="form-grid">
          <div>
            <label>Core ID <span class="info" data-tip="Internal identifier for this MikroTik entry.">i</span></label>
            <input type="text" name="{{ core.id }}_id" value="{{ core.id }}" disabled />
          </div>
          <div>
            <label>Router Name <span class="info" data-tip="Friendly label shown in Pulsewatch tables.">i</span></label>
            <input type="text" name="{{ core.id }}_label" value="{{ core.label }}" />
          </div>
          <div>
            <label>Host <span class="info" data-tip="MikroTik API IP/hostname for this router.">i</span></label>
            <input type="text" name="{{ core.id }}_host" value="{{ core.host }}" />
          </div>
          <div>
            <label>Interface <span class="info" data-tip="Linux NIC that carries this router's Pulsewatch source IPs (e.g., enp0s8).">i</span></label>
            <input type="text" name="{{ core.id }}_interface" list="interface_options" value="{{ core.interface }}" />
          </div>
          <div>
            <label>Prefix <span class="info" data-tip="CIDR prefix length for the source IPs on this interface (usually 24).">i</span></label>
            <input type="number" name="{{ core.id }}_prefix" value="{{ core.prefix }}" />
          </div>
          <div>
            <label>Source IP Gateway <span class="info" data-tip="Default gateway used when traffic is sourced from this core's IPs. Example: 172.16.90.1.">i</span></label>
            <input type="text" name="{{ core.id }}_gateway" value="{{ core.gateway }}" placeholder="e.g. 172.16.90.1" />
          </div>
          <div>
            <label>Port <span class="info" data-tip="MikroTik API port (8728 by default).">i</span></label>
            <input type="number" name="{{ core.id }}_port" value="{{ core.port }}" />
          </div>
          <div>
            <label>Username <span class="info" data-tip="MikroTik API username.">i</span></label>
            <input type="text" name="{{ core.id }}_username" value="{{ core.username }}" />
          </div>
          <div>
            <label>Password <span class="info" data-tip="MikroTik API password.">i</span></label>
            <input type="password" name="{{ core.id }}_password" value="{{ core.password }}" />
          </div>
        </div>
        <div style="margin-top: 8px;">
          <button type="submit" formaction="/settings/system/mikrotik/remove/{{ core.id }}" formmethod="post">Remove Core</button>
        </div>
      </div>
    {% endfor %}
    <datalist id="interface_options">
      {% for iface in interface_options %}
        <option value="{{ iface }}"></option>
      {% endfor %}
    </datalist>
    <div style="margin-top: 12px;">
      <button type="submit" class="button-green">Save MikroTik Settings</button>
    </div>
  </form>
  <form method="post" action="/settings/system/mikrotik/add" style="margin-top: 12px;">
    <button type="submit">Add MikroTik Core</button>
  </form>
  <form method="post" action="/settings/isp/mikrotik/test" style="margin-top: 12px;">
    <button type="submit">Test MikroTik API</button>
  </form>
  <form method="post" action="/settings/isp/mikrotik/sync" style="margin-top: 12px;">
    <button type="submit" class="button-blue">Sync MikroTik Address-Lists</button>
  </form>
</div>

<div class="card" style="margin-top: 20px;">
  <h2>Telegram Commands</h2>
  <form method="post" action="/settings/system/telegram">
    <div class="form-grid">
      <div>
        <label>Command Chat ID <span class="info" data-tip="Chat/group ID where users send commands and receive replies.">i</span></label>
        <input type="text" name="telegram_command_chat_id" value="{{ settings.telegram.command_chat_id }}" />
      </div>
      <div>
        <label>Allowed User IDs <span class="info" data-tip="One Telegram user ID per line for command access control.">i</span></label>
        <textarea name="telegram_allowed_user_ids">{% for user_id in settings.telegram.allowed_user_ids %}{{ user_id }}
{% endfor %}</textarea>
      </div>
    </div>
    <div style="margin-top: 12px;">
      <button type="submit" class="button-green">Save Telegram Command Settings</button>
    </div>
  </form>
</div>

<div class="card" style="margin-top: 20px;">
  <h2>Backup & Restore</h2>
  <div class="status">
    <div><a href="/settings/export">Download settings backup</a></div>
  </div>
  <form method="post" action="/settings/import" enctype="multipart/form-data" style="margin-top: 12px;">
    <label>Restore from JSON file</label>
    <input type="file" name="settings_file" accept="application/json" />
    <div style="margin-top: 10px;">
      <button type="submit">Import Settings</button>
    </div>
  </form>
</div>

<div class="card" style="margin-top: 20px;">
  <h2>Uninstall</h2>
  <div class="alert">Warning: This will remove Docker, all containers/images/volumes, and delete the app files. This action is irreversible.</div>
  <p class="help">Type UNINSTALL to confirm.</p>
  <form method="post" action="/settings/system/uninstall">
    <input type="text" name="confirm_text" placeholder="Type UNINSTALL" />
    <div style="margin-top: 12px;">
      <button type="submit" class="button-blue">Uninstall Everything</button>
    </div>
  </form>
</div>

{% endblock %}
