{% extends "base.html" %}
{% block content %}
<div class="card">
  <h2>System Settings</h2>
  <div class="status">
    <div>Current version: {{ repo_version.version }} ({{ repo_version.date }})</div>
    <div id="ota-status-line">Status: {{ ota_status }}</div>
  </div>
  {% if message %}
    <div class="alert">{{ message }}</div>
  {% endif %}

  <h3>OTA Update</h3>
  <p class="help">This will pull the latest code and rebuild the container. Your settings stay in the database.</p>
  <form method="post" action="/settings/system/update" style="margin-top: 12px;" id="ota-form">
    <button type="submit" class="button-blue" id="ota-button">Run OTA Update</button>
  </form>
  <div id="ota-progress" style="margin-top: 12px; display: none;">
    <div style="height: 8px; background: #d7dde0; border-radius: 999px; overflow: hidden;">
      <div id="ota-bar" style="height: 8px; width: 100%; background: #2f6fd6; animation: otaPulse 1.2s infinite;"></div>
    </div>
    <div class="help" style="margin-top: 6px;">Updating... this may take a few minutes.</div>
  </div>
  <div style="margin-top: 16px;">
    <label>OTA Output</label>
    <textarea readonly id="ota-log" style="min-height: 180px;">{{ log_text }}</textarea>
  </div>
</div>

<div class="card" style="margin-top: 20px;">
  <h2>Uninstall</h2>
  <div class="alert">Warning: This will remove Docker, all containers/images/volumes, and delete the app files. This action is irreversible.</div>
  <p class="help">Type UNINSTALL to confirm.</p>
  <form method="post" action="/settings/system/uninstall">
    <input type="text" name="confirm_text" placeholder="Type UNINSTALL" />
    <div style="margin-top: 12px;">
      <button type="submit" class="button-blue">Uninstall Everything</button>
    </div>
  </form>
</div>

<style>
  @keyframes otaPulse {
    0% { opacity: 0.3; }
    50% { opacity: 1; }
    100% { opacity: 0.3; }
  }
</style>
<script>
  const statusLine = document.getElementById("ota-status-line");
  const logBox = document.getElementById("ota-log");
  const progress = document.getElementById("ota-progress");
  const button = document.getElementById("ota-button");
  let lastStatus = "{{ ota_status }}";

  function updateUi(status) {
    statusLine.textContent = `Status: ${status}`;
    const running = status === "running";
    progress.style.display = running ? "block" : "none";
    button.disabled = running;
    button.style.opacity = running ? "0.7" : "1";
  }

  async function pollOta() {
    try {
      const statusResp = await fetch("/settings/system/status");
      const statusData = await statusResp.json();
      const status = statusData.status || "idle";
      updateUi(status);

      const logResp = await fetch("/settings/system/log");
      if (logResp.ok) {
        logBox.value = await logResp.text();
        logBox.scrollTop = logBox.scrollHeight;
      }

      if (lastStatus === "running" && status !== "running") {
        window.location.reload();
        return;
      }
      lastStatus = status;
    } catch (err) {
      // ignore transient errors during restart
    }
    setTimeout(pollOta, 3000);
  }

  updateUi(lastStatus);
  pollOta();

  const otaForm = document.getElementById("ota-form");
  otaForm.addEventListener("submit", async (event) => {
    event.preventDefault();
    updateUi("running");
    try {
      const resp = await fetch("/settings/system/update/start", { method: "POST" });
      const data = await resp.json();
      if (data.status === "failed") {
        statusLine.textContent = `Status: failed (${data.error || "error"})`;
      }
    } catch (err) {
      statusLine.textContent = "Status: failed (network error)";
    }
  });
</script>
{% endblock %}
