{% extends "base.html" %}
{% block title %}Profile Review{% endblock %}
{% block header_title %}Profile Review{% endblock %}
{% block header_badge %}
  <span class="badge bg-cyan-lt text-cyan header-icon-badge"><i class="ti ti-user-search"></i></span>
{% endblock %}
{% block content %}

<div class="card mb-3">
  <div class="card-body">
    <div class="row align-items-center g-3">
      <div class="col-md">
        <h4 class="mb-1">Search Customer</h4>
        <div class="text-muted small">Search by PPPoE, IP, device ID, or account name.</div>
      </div>
      <div class="col-md-6 col-lg-5">
        <div class="position-relative">
          <div class="input-icon">
            <input class="form-control" id="profile-search" type="text" placeholder="Search customer..." autocomplete="off" />
            <span class="input-icon-addon">
              <i class="ti ti-search"></i>
            </span>
          </div>
          <div class="dropdown-menu w-100" id="profile-suggest" style="max-height: 320px; overflow: auto;"></div>
        </div>
      </div>
	  </div>
  </div>
</div>

{% if profile.pppoe or profile.ip or profile.device_id %}
<div class="row row-deck row-cards">
  <div class="col-12">
    <div class="card">
      <div class="card-body">
        <div class="d-flex align-items-start gap-3">
          <span class="avatar bg-cyan-lt text-cyan">{{ (profile.name or "C")[:1]|upper }}</span>
          <div class="flex-fill">
            <div class="d-flex align-items-center gap-2 flex-wrap">
              <h3 class="mb-0">{{ profile.name or "Customer" }}</h3>
              {% for src in profile.sources %}
                {% if src == "optical" %}
                  <span class="badge bg-azure-lt text-azure"><i class="ti ti-sun me-1"></i>Optical</span>
                {% elif src == "accounts_ping" %}
                  <span class="badge bg-indigo-lt text-indigo"><i class="ti ti-wifi me-1"></i>ACC-Ping</span>
                {% elif src == "usage" %}
                  <span class="badge bg-teal-lt text-teal"><i class="ti ti-chart-bar me-1"></i>Usage</span>
                {% endif %}
              {% endfor %}
            </div>
            <div class="text-muted mt-1 d-flex flex-wrap gap-3">
              {% if profile.ip %}
                <span><i class="ti ti-network me-1"></i>{{ profile.ip }}</span>
              {% endif %}
              {% if profile.device_id %}
                <span>
                  <i class="ti ti-device-desktop me-1"></i>
                  {% if profile.device_url %}
                    <a class="text-reset text-decoration-none profile-device-link" href="{{ profile.device_url }}" target="_blank" rel="noopener" title="Open in GenieACS">
                      {{ profile.device_id }}
                    </a>
                  {% else %}
                    {{ profile.device_id }}
                  {% endif %}
                </span>
              {% endif %}
              <span><i class="ti ti-clock me-1"></i>Window: {{ profile.window_label }}</span>
            </div>
          </div>
	          <div class="ms-auto d-flex gap-2 align-items-start">
              {% set surv_pppoe = (profile.pppoe or '') %}
              {% set surv_status = surveillance_index.get(surv_pppoe) if surv_pppoe else None %}
              <span data-surveillance-slot>
                {% if not surv_pppoe %}
                  <button type="button" class="btn btn-outline-secondary btn-sm" title="No PPPoE detected for this profile" aria-label="No PPPoE detected" disabled>
                    <i class="ti ti-eye me-1"></i>For Surveillance
                  </button>
                {% elif surv_status == 'under' %}
                  <a class="btn btn-outline-warning btn-sm" href="/surveillance?tab=under&focus={{ surv_pppoe|urlencode }}" title="Under Surveillance" aria-label="Under Surveillance">
                    <i class="ti ti-eye me-1"></i>Under Surveillance
                  </a>
                {% elif surv_status == 'level2' %}
                  <a class="btn btn-outline-danger btn-sm" href="/surveillance?tab=level2&focus={{ surv_pppoe|urlencode }}" title="LEVEL II SUSPECT" aria-label="LEVEL II SUSPECT">
                    <i class="ti ti-eye me-1"></i>LEVEL II SUSPECT
                  </a>
                {% else %}
                  <button type="button"
                          class="btn btn-outline-secondary btn-sm surveillance-add-btn"
                          title="For Surveillance"
                          data-pppoe="{{ surv_pppoe }}"
                          data-name="{{ surv_pppoe }}"
                          data-ip="{{ profile.ip }}"
                          data-source="profile_review">
                    <i class="ti ti-eye me-1"></i>For Surveillance
                  </button>
                {% endif %}
              </span>
	            <div class="dropdown">
	              <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" id="profile-window-button">
	                Window: {{ profile.window_label }}
	              </button>
              <div class="dropdown-menu dropdown-menu-end">
                <button class="dropdown-item profile-window-option" data-hours="6" data-label="6H">6H</button>
                <button class="dropdown-item profile-window-option" data-hours="12" data-label="12H">12H</button>
                <button class="dropdown-item profile-window-option" data-hours="24" data-label="1D">1D</button>
                <button class="dropdown-item profile-window-option" data-hours="168" data-label="7D">7D</button>
                <button class="dropdown-item profile-window-option" data-hours="360" data-label="15D">15D</button>
                <button class="dropdown-item profile-window-option" data-hours="720" data-label="30D">30D</button>
              </div>
            </div>
            <a class="btn btn-outline-secondary btn-sm" href="/profile-review">
              <i class="ti ti-x me-1"></i>Clear
            </a>
          </div>
	  </div>
  </div>
</div>
  </div>

  <div class="col-12">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title"><i class="ti ti-chart-bar me-2"></i>Usage</h3>
        {% if profile.usage and not profile.usage.enabled %}
          <span class="badge bg-secondary-lt ms-auto">Disabled</span>
        {% elif profile.usage and profile.usage.active %}
          {% if profile.usage.issue %}
            <span class="badge bg-yellow-lt ms-auto"><i class="ti ti-eye me-1"></i>Monitor</span>
          {% else %}
            <span class="badge bg-green-lt ms-auto"><i class="ti ti-check me-1"></i>Active</span>
          {% endif %}
        {% else %}
          <span class="badge bg-secondary-lt ms-auto">No live session</span>
        {% endif %}
      </div>
      <div class="card-body">
        {% if not profile.pppoe %}
          <div class="empty">
            <div class="empty-icon"><i class="ti ti-user-off"></i></div>
            <p class="empty-title">No PPPoE detected</p>
            <p class="empty-subtitle text-muted">Usage history and live session matching require a PPPoE username.</p>
          </div>
        {% elif not profile.usage or not profile.usage.enabled %}
          <div class="empty">
            <div class="empty-icon"><i class="ti ti-plug-off"></i></div>
            <p class="empty-title">Usage collector is disabled</p>
            <p class="empty-subtitle text-muted">Enable it in Settings → Usage to see MikroTik usage and device trends here.</p>
          </div>
        {% elif not profile.usage.active %}
          <div class="d-flex align-items-start gap-2 text-muted">
            <i class="ti ti-info-circle mt-1"></i>
            <div>
              <div class="fw-semibold text-reset">No usage detected for this account right now.</div>
              <div class="small">This usually means the PPPoE session is offline or not matched. Check <a class="link-secondary" href="/settings/usage">Settings → Usage</a> for live sessions, router connectivity, and PPPoE username matching.</div>
            </div>
          </div>
        {% else %}
          <div class="row g-2 mb-3">
            <div class="col-6 col-md-3">
              <div class="text-muted small">DL Rate</div>
              <div class="h3 m-0">{{ profile.usage.dl_bps_fmt }}</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-muted small">UL Rate</div>
              <div class="h3 m-0">{{ profile.usage.ul_bps_fmt }}</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-muted small">Connected Devices</div>
              <div class="h3 m-0">{{ profile.usage.devices }}</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-muted small">Last Seen</div>
              <div class="fw-semibold">{{ profile.usage.last_seen }}</div>
            </div>
          </div>

          <div class="row g-2 mb-3">
            <div class="col-6 col-md-3">
              <div class="text-muted small">DL Total</div>
              <div class="fw-semibold">{{ profile.usage.dl_total_fmt }}</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-muted small">UL Total</div>
              <div class="fw-semibold">{{ profile.usage.ul_total_fmt }}</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-muted small">Router</div>
              <div class="fw-semibold">{{ profile.usage.router_name or 'n/a' }}</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-muted small">Session</div>
              <div class="fw-semibold">{{ profile.usage.uptime or 'n/a' }}</div>
            </div>
          </div>

          <div class="row g-3">
            <div class="col-lg-8">
              <div class="row g-2 mb-2">
                <div class="col-6 col-md-3">
                  <div class="text-muted small">Transfer (est)</div>
                  <div class="fw-semibold" id="profile-usage-stat-transfer">n/a</div>
                </div>
                <div class="col-6 col-md-3">
                  <div class="text-muted small">Max Rate</div>
                  <div class="fw-semibold" id="profile-usage-stat-max">n/a</div>
                </div>
                <div class="col-6 col-md-3">
                  <div class="text-muted small">Avg Rate</div>
                  <div class="fw-semibold" id="profile-usage-stat-avg">n/a</div>
                </div>
                <div class="col-6 col-md-3">
                  <div class="text-muted small">Idle</div>
                  <div class="fw-semibold" id="profile-usage-stat-idle">n/a</div>
                </div>
              </div>
              <div class="border rounded p-2">
                <div id="profile-usage-chart" style="height: 260px;"></div>
              </div>
              <div class="text-muted small mt-2">History from stored usage samples (Window: {{ profile.window_label }}). Tooltip shows devices connected at that time.</div>
            </div>
            <div class="col-lg-4">
              <div class="card card-sm">
                <div class="card-body">
                  <div class="d-flex align-items-center justify-content-between mb-2">
                    <div class="fw-semibold">Active Devices</div>
                    <span class="badge bg-secondary-lt">{{ profile.usage.devices }}</span>
                  </div>
                  {% set names = profile.usage.hostnames or [] %}
                  {% if names %}
                    <div class="table-responsive" style="max-height: 280px; overflow: auto;">
                      <table class="table table-sm table-vcenter">
                        <thead>
                          <tr>
                            <th>Hostname</th>
                          </tr>
                        </thead>
                        <tbody>
                          {% for n in names %}
                            <tr><td class="text-muted">{{ n }}</td></tr>
                          {% endfor %}
                        </tbody>
                      </table>
                    </div>
                  {% else %}
                    <div class="text-muted small">No devices detected from GenieACS host table.</div>
                  {% endif %}
                  {% if profile.usage.issue_peak or profile.usage.issue_anytime %}
                    <div class="mt-3">
                      <div class="fw-semibold mb-1">Detection</div>
                      <div class="d-flex flex-wrap gap-1">
                        {% if profile.usage.issue_peak %}
                          <span class="badge bg-yellow-lt">Peak-hour low-usage</span>
                        {% endif %}
                        {% if profile.usage.issue_anytime %}
                          <span class="badge bg-yellow-lt">Anytime no-usage window</span>
                        {% endif %}
                      </div>
                    </div>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title"><i class="ti ti-wifi me-2"></i>ACC-Ping</h3>
        {% if profile.accounts_ping %}
          {% if profile.accounts_ping.status == "down" %}
            <span class="badge bg-red-lt ms-auto"><i class="ti ti-alert-circle me-1"></i>Down</span>
          {% elif profile.accounts_ping.status == "stable" %}
            <span class="badge bg-green-lt ms-auto"><i class="ti ti-check me-1"></i>Stable</span>
          {% elif profile.accounts_ping.status == "pending" %}
            <span class="badge bg-secondary-lt ms-auto">Pending</span>
          {% else %}
            <span class="badge bg-yellow-lt ms-auto"><i class="ti ti-eye me-1"></i>Monitor</span>
          {% endif %}
        {% else %}
          <span class="badge bg-secondary-lt ms-auto">No data</span>
        {% endif %}
      </div>
      <div class="card-body">
        {% if profile.accounts_ping %}
          <div class="row g-2 mb-3">
            <div class="col-6 col-md-3">
              <div class="text-muted small">Uptime</div>
              <div class="h3 m-0">{{ "%.1f"|format(profile.accounts_ping.uptime_pct) }}%</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-muted small">Loss</div>
              <div class="h3 m-0">{{ profile.accounts_ping.loss_avg is not none and ("%.1f"|format(profile.accounts_ping.loss_avg) ~ "%") or "n/a" }}</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-muted small">Latency</div>
              <div class="h3 m-0">{{ profile.accounts_ping.avg_ms_avg is not none and ("%.1f"|format(profile.accounts_ping.avg_ms_avg) ~ "ms") or "n/a" }}</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-muted small">Last Check</div>
              <div class="fw-semibold">{{ profile.accounts_ping.last_seen }}</div>
            </div>
          </div>
          <div class="border rounded p-2 mb-3">
            <div id="profile-accping-chart" style="height: 220px;"></div>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-vcenter">
              <thead>
                <tr>
                  <th>Timestamp</th>
                  <th>Ping</th>
                  <th>Loss</th>
                  <th>Latency</th>
                </tr>
              </thead>
              <tbody>
                {% for row in profile.accounts_ping.recent %}
                  <tr>
                    <td class="text-muted">{{ row.ts }}</td>
                    <td>
                      {% if row.status == "pending" %}
                        <span class="badge bg-secondary-lt">Pending</span>
                      {% elif row.ok %}
                        <span class="badge bg-green-lt">Up</span>
                      {% else %}
                        <span class="badge bg-red-lt">Down</span>
                      {% endif %}
                    </td>
                    <td>{{ row.loss is not none and ("%.1f"|format(row.loss) ~ "%") or "n/a" }}</td>
                    <td>{{ row.avg_ms is not none and ("%.1f"|format(row.avg_ms) ~ "ms") or "n/a" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="empty">
            <div class="empty-icon"><i class="ti ti-database-off"></i></div>
            <p class="empty-title">No ACC-Ping history found</p>
            <p class="empty-subtitle text-muted">Search another account or provide a PPPoE/IP that exists in Accounts Ping data.</p>
          </div>
        {% endif %}
      </div>
    </div>
  </div>

  <div class="col-lg-6">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title"><i class="ti ti-sun me-2"></i>Optical</h3>
        {% if profile.optical %}
          {% if profile.optical.status == "issue" %}
            <span class="badge bg-red-lt ms-auto"><i class="ti ti-alert-circle me-1"></i>Issue</span>
          {% elif profile.optical.status == "stable" %}
            <span class="badge bg-green-lt ms-auto"><i class="ti ti-check me-1"></i>Stable</span>
          {% else %}
            <span class="badge bg-yellow-lt ms-auto"><i class="ti ti-eye me-1"></i>Monitor</span>
          {% endif %}
        {% else %}
          <span class="badge bg-secondary-lt ms-auto">No data</span>
        {% endif %}
      </div>
      <div class="card-body">
        {% if profile.optical %}
          <div class="row g-2 mb-3">
            <div class="col-6 col-md-3">
              <div class="text-muted small">RX</div>
              <div class="h3 m-0">{{ profile.optical.rx is not none and ("%.2f"|format(profile.optical.rx)) or "n/a" }}</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-muted small">TX</div>
              <div class="h3 m-0">
                {% if profile.optical.tx_missing %}
                  <span class="text-muted">Missing</span>
                {% elif profile.optical.tx_unrealistic %}
                  {{ profile.optical.tx is not none and ("%.2f"|format(profile.optical.tx)) or "n/a" }} <span class="text-muted small">(unrealistic)</span>
                {% else %}
                  {{ profile.optical.tx is not none and ("%.2f"|format(profile.optical.tx)) or "n/a" }}
                {% endif %}
              </div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-muted small">Samples</div>
              <div class="h3 m-0">{{ profile.optical.samples }}</div>
            </div>
            <div class="col-6 col-md-3">
              <div class="text-muted small">Last Check</div>
              <div class="fw-semibold">{{ profile.optical.last_seen }}</div>
            </div>
          </div>
          <div class="border rounded p-2 mb-3">
            <div id="profile-optical-chart" style="height: 220px;"></div>
          </div>
          <div class="table-responsive">
            <table class="table table-sm table-vcenter">
              <thead>
                <tr>
                  <th>Timestamp</th>
                  <th>RX</th>
                  <th>TX</th>
                </tr>
              </thead>
              <tbody>
                {% for row in profile.optical.recent %}
                  <tr>
                    <td class="text-muted">{{ row.ts }}</td>
                    <td>{{ row.rx is not none and ("%.2f"|format(row.rx)) or "n/a" }}</td>
                    <td>{{ row.tx is not none and ("%.2f"|format(row.tx)) or "n/a" }}</td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="empty">
            <div class="empty-icon"><i class="ti ti-database-off"></i></div>
            <p class="empty-title">No optical history found</p>
            <p class="empty-subtitle text-muted">Search another account or provide a device ID that exists in optical results.</p>
          </div>
        {% endif %}
      </div>
	    </div>
		</div>
</div>
{% else %}
<div class="empty">
  <div class="empty-icon"><i class="ti ti-user-search"></i></div>
  <p class="empty-title">Search or Choose account below to review</p>
  <p class="empty-subtitle text-muted">Start typing at least 2 characters to see suggestions.</p>
</div>

<div class="row justify-content-center mt-4 d-none" id="profile-top10-wrap">
  <div class="col-12 col-lg-8 col-xl-7">
    <div class="card">
      <div class="card-header">
        <h3 class="card-title mb-0" id="profile-top10-title">TOP10 - Critical Connections (Last 24h)</h3>
      </div>
      <div class="list-group list-group-flush" id="profile-top10-list">
        <div class="p-3 text-muted">Loading…</div>
      </div>
    </div>
  </div>
</div>
{% endif %}

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const profile = {{ profile | tojson }};
    const searchInput = document.getElementById("profile-search");
    const suggestMenu = document.getElementById("profile-suggest");
    const top10Wrap = document.getElementById("profile-top10-wrap");
    const top10Title = document.getElementById("profile-top10-title");
    const top10List = document.getElementById("profile-top10-list");
    const windowButton = document.getElementById("profile-window-button");
    const windowOptions = document.querySelectorAll(".profile-window-option");
    let pendingTimer = null;
    let lastItems = [];

    const showTop10 = () => {
      if (!top10Wrap) return;
      top10Wrap.classList.remove("d-none");
    };

    const hideTop10 = () => {
      if (!top10Wrap) return;
      top10Wrap.classList.add("d-none");
    };

    const closeSuggest = () => {
      if (!suggestMenu) return;
      suggestMenu.classList.remove("show");
      suggestMenu.innerHTML = "";
      lastItems = [];
    };

    const openSuggest = () => {
      if (!suggestMenu) return;
      suggestMenu.classList.add("show");
    };

	    const iconFor = (sources) => {
	      if ((sources || []).includes("optical") && (sources || []).includes("accounts_ping") && (sources || []).includes("usage")) return "ti ti-layers";
	      if ((sources || []).includes("optical") && (sources || []).includes("accounts_ping")) return "ti ti-layers";
	      if ((sources || []).includes("optical")) return "ti ti-sun";
	      if ((sources || []).includes("accounts_ping")) return "ti ti-wifi";
	      if ((sources || []).includes("usage")) return "ti ti-chart-bar";
	      return "ti ti-user";
	    };

    const statusBadgeHtml = (item) => {
      const status = String(item?.meta?.status || "").toLowerCase();
      if (!status) return "";
      if (status === "down" || status === "issue") return '<span class="badge bg-red-lt">Critical</span>';
      if (status === "monitor") return '<span class="badge bg-yellow-lt">Monitor</span>';
      if (status === "up" || status === "stable") return '<span class="badge bg-green-lt">Stable</span>';
      return "";
    };

    const navigateTo = (item) => {
      hideTop10();
      const params = new URLSearchParams();
      if (item.pppoe) params.set("pppoe", item.pppoe);
      if (item.ip) params.set("ip", item.ip);
      if (item.device_id) params.set("device_id", item.device_id);
      window.location.href = `/profile-review?${params.toString()}`;
    };

    const renderTop10 = (payload) => {
      if (!top10List) return;
      top10List.innerHTML = "";
      if (top10Title) top10Title.textContent = payload?.header || "TOP10 - Critical Connections (Last 24h)";

      const items = payload?.items || [];
      if (!items.length) {
        top10List.innerHTML = "<div class='p-3 text-muted'>No results</div>";
        showTop10();
        return;
      }

      const groups = new Map();
      items.forEach((item) => {
        const group = item.group || "Results";
        if (!groups.has(group)) groups.set(group, []);
        groups.get(group).push(item);
      });

      for (const [groupName, groupItems] of groups.entries()) {
        const header = document.createElement("div");
        header.className = "px-3 py-2 text-muted fw-semibold bg-light border-top";
        header.textContent = groupName;
        top10List.appendChild(header);
        groupItems.forEach((item) => {
          const row = document.createElement("button");
          row.type = "button";
          row.className = "list-group-item list-group-item-action";
          row.innerHTML = `
            <div class="d-flex align-items-center gap-2">
              <span class="text-muted"><i class="${iconFor(item.sources)}"></i></span>
              <div class="flex-fill">
                <div class="fw-semibold">${item.name || "Customer"}</div>
                <div class="text-muted small">${[item.pppoe, item.ip, item.device_id].filter(Boolean).join(" · ")}</div>
              </div>
              <div class="d-flex gap-1 align-items-center flex-wrap justify-content-end">
                ${statusBadgeHtml(item)}
                ${(item.sources || []).includes("optical") ? '<span class="badge bg-azure-lt text-azure">Optical</span>' : ""}
                ${(item.sources || []).includes("accounts_ping") ? '<span class="badge bg-indigo-lt text-indigo">ACC-Ping</span>' : ""}
              </div>
            </div>
          `;
          row.addEventListener("click", () => navigateTo(item));
          top10List.appendChild(row);
        });
      }

      showTop10();
    };

    const renderSuggest = (items) => {
      if (!suggestMenu) return;
      suggestMenu.innerHTML = "";
      if (!items.length) {
        suggestMenu.innerHTML = "<div class='dropdown-item text-muted'>No matches</div>";
        openSuggest();
        return;
      }
      suggestMenu.appendChild(Object.assign(document.createElement("div"), { className: "dropdown-header", textContent: "Results" }));
      items.forEach((item) => {
        const row = document.createElement("button");
        row.type = "button";
        row.className = "dropdown-item";
        row.innerHTML = `
          <div class="d-flex align-items-center gap-2">
            <span class="text-muted"><i class="${iconFor(item.sources)}"></i></span>
            <div class="flex-fill">
              <div class="fw-semibold">${item.name || "Customer"}</div>
              <div class="text-muted small">${[item.pppoe, item.ip, item.device_id].filter(Boolean).join(" · ")}</div>
            </div>
            <div class="d-flex gap-1">
              ${statusBadgeHtml(item)}
              ${(item.sources || []).includes("optical") ? '<span class="badge bg-azure-lt text-azure">Optical</span>' : ""}
              ${(item.sources || []).includes("accounts_ping") ? '<span class="badge bg-indigo-lt text-indigo">ACC-Ping</span>' : ""}
            </div>
          </div>
        `;
        row.addEventListener("click", () => navigateTo(item));
        suggestMenu.appendChild(row);
      });
      openSuggest();
    };

    const fetchSuggest = async () => {
      const q = (searchInput?.value || "").trim();
      try {
        const url = q.length >= 2
          ? `/profile-review/suggest?q=${encodeURIComponent(q)}`
          : "/profile-review/suggest";
        const res = await fetch(url, { headers: { "Accept": "application/json" } });
        if (!res.ok) return;
        const payload = await res.json();
        lastItems = payload.items || [];
        if (payload.mode === "top10") {
          closeSuggest();
          renderTop10(payload);
        } else {
          hideTop10();
          renderSuggest(lastItems);
        }
      } catch (err) {
        closeSuggest();
      }
    };

    if (searchInput) {
      searchInput.addEventListener("input", () => {
        if (pendingTimer) window.clearTimeout(pendingTimer);
        pendingTimer = window.setTimeout(fetchSuggest, 180);
      });
      searchInput.addEventListener("focus", () => {
        fetchSuggest();
      });
      searchInput.addEventListener("keydown", (event) => {
        if (event.key === "Escape") {
          closeSuggest();
        }
        if (event.key === "Enter" && lastItems.length) {
          event.preventDefault();
          navigateTo(lastItems[0]);
        }
      });
    }

    document.addEventListener("click", (event) => {
      if (!suggestMenu || !searchInput) return;
      if (suggestMenu.contains(event.target) || searchInput.contains(event.target)) return;
      closeSuggest();
    });

    if (windowButton && windowOptions.length) {
      windowOptions.forEach((btn) => {
        btn.addEventListener("click", () => {
          const hours = btn.dataset.hours || "24";
          const label = btn.dataset.label || "";
          if (label) {
            windowButton.textContent = `Window: ${label}`;
          }
          const url = new URL(window.location.href);
          url.searchParams.set("window", hours);
          window.location.href = url.toString();
        });
      });
    }

    const renderAccPingChart = async () => {
      const el = document.getElementById("profile-accping-chart");
      if (!el || !profile?.accounts_ping?.account_id) return;
      try {
        const params = new URLSearchParams({ account_id: profile.accounts_ping.account_id, window: String(profile.window_hours || 24) });
        const res = await fetch(`/accounts-ping/series?${params.toString()}`, { headers: { "Accept": "application/json" } });
        if (!res.ok) return;
        const payload = await res.json();
        const points = (payload.series || [])
          .map((row) => {
            const ts = row.ts ? Date.parse(String(row.ts)) : NaN;
            if (!Number.isFinite(ts)) return null;
            const loss = row.loss === null || row.loss === undefined ? null : Number(row.loss);
            const avg = row.avg_ms === null || row.avg_ms === undefined ? null : Number(row.avg_ms);
            return { x: ts, loss, avg_ms: avg };
          })
          .filter((row) => row !== null);
        if (!points.length) return;
        const lossSeries = points.map((p) => ({ x: p.x, y: p.loss }));
        const latSeries = points.map((p) => ({ x: p.x, y: p.avg_ms }));
        const chart = new window.ApexCharts(el, {
          chart: { type: "line", height: 220, toolbar: { show: false }, zoom: { enabled: false }, animations: { enabled: false } },
          series: [
            { name: "Latency (ms)", data: latSeries },
            { name: "Loss (%)", data: lossSeries },
          ],
          colors: ["#206bc4", "#d63939"],
          stroke: { width: 2 },
          markers: { size: 0 },
          xaxis: { type: "datetime", tooltip: { enabled: false } },
          yaxis: [
            {
              seriesName: "Latency (ms)",
              min: 0,
              labels: { formatter: (val) => `${val.toFixed(0)}ms` },
            },
            {
              opposite: true,
              seriesName: "Loss (%)",
              min: 0,
              max: 100,
              tickAmount: 2,
              labels: { formatter: (val) => `${val.toFixed(0)}%` },
            },
          ],
          tooltip: {
            shared: true,
            intersect: false,
            followCursor: true,
            y: {
              formatter: (val, opts) => {
                const name = opts?.w?.globals?.seriesNames?.[opts.seriesIndex] || "";
                if (name.includes("Loss")) return `${Number(val).toFixed(1)}%`;
                return `${Number(val).toFixed(1)}ms`;
              },
            },
          },
          grid: { borderColor: "#e9ecef" },
          legend: { position: "top" },
        });
        chart.render();
      } catch (err) {
        // ignore
      }
    };

	    const renderOpticalChart = async () => {
      const el = document.getElementById("profile-optical-chart");
      if (!el || !profile?.optical?.device_id) return;
      try {
        const params = new URLSearchParams({ device_id: profile.optical.device_id, window: String(profile.window_hours || 24) });
        const res = await fetch(`/optical/series?${params.toString()}`, { headers: { "Accept": "application/json" } });
        if (!res.ok) return;
        const payload = await res.json();
        const txMin = Number(profile?.classification?.tx_realistic_min_dbm ?? -10);
        const txMax = Number(profile?.classification?.tx_realistic_max_dbm ?? 10);
        const points = (payload.series || [])
          .map((row) => {
            const ts = row.ts ? Date.parse(String(row.ts)) : NaN;
            if (!Number.isFinite(ts)) return null;
            const rx = row.rx === null || row.rx === undefined ? null : Number(row.rx);
            const txRaw = row.tx === null || row.tx === undefined ? null : Number(row.tx);
            const txPlot = txRaw === null || !Number.isFinite(txRaw) || txRaw < txMin || txRaw > txMax ? null : txRaw;
            return { x: ts, rx, tx: txPlot, tx_raw: txRaw };
          })
          .filter((row) => row !== null);
        if (!points.length) return;
        const rxSeries = points.map((p) => ({ x: p.x, y: p.rx }));
        const txSeries = points.map((p) => ({ x: p.x, y: p.tx }));
        const chartMin = Number(profile?.optical?.chart?.min_dbm ?? -35);
        const chartMax = Number(profile?.optical?.chart?.max_dbm ?? -10);
        const fmtDbm = (value) => (value === null || value === undefined || Number.isNaN(Number(value)) ? "n/a" : `${Number(value).toFixed(1)} dBm`);
        const chart = new window.ApexCharts(el, {
          chart: { type: "line", height: 220, toolbar: { show: false }, zoom: { enabled: false }, animations: { enabled: false } },
          series: [
            { name: "RX (dBm)", data: rxSeries },
            { name: "TX (dBm)", data: txSeries },
          ],
          colors: ["#2fb344", "#206bc4"],
          stroke: { width: 2 },
          markers: { size: 0 },
          xaxis: { type: "datetime", tooltip: { enabled: false } },
          yaxis: { min: chartMin, max: chartMax, tickAmount: 5, labels: { formatter: (val) => `${val.toFixed(1)} dBm` } },
          tooltip: {
            shared: true,
            intersect: false,
            followCursor: true,
            y: {
              formatter: (val, { seriesIndex, dataPointIndex }) => {
                const point = points[dataPointIndex];
                if (!point) return fmtDbm(val);
                if (seriesIndex === 1) {
                  const txRaw = point.tx_raw;
                  if (txRaw === null || txRaw === undefined || !Number.isFinite(txRaw)) return "Missing";
                  if (txRaw < txMin || txRaw > txMax) return `${fmtDbm(txRaw)} (unrealistic)`;
                  return fmtDbm(txRaw);
                }
                return fmtDbm(point.rx);
              },
            },
          },
          grid: { borderColor: "#e9ecef" },
          legend: { position: "top" },
        });
        chart.render();
      } catch (err) {
        // ignore
      }
	    };

	    const fmtBytes = (value) => {
	      const num = Number(value);
	      if (!Number.isFinite(num)) return "n/a";
	      const units = ["B", "KB", "MB", "GB", "TB", "PB"];
	      let size = Math.max(0, num);
	      let idx = 0;
	      while (size >= 1024 && idx < units.length - 1) {
	        size /= 1024;
	        idx++;
	      }
	      if (idx === 0) return `${Math.floor(size)} ${units[idx]}`;
	      return `${size.toFixed(2)} ${units[idx]}`;
	    };

	    const fmtBps = (value) => {
	      const num = Number(value);
	      if (!Number.isFinite(num)) return "n/a";
	      const units = ["bps", "kbps", "Mbps", "Gbps"];
	      let size = Math.max(0, num);
	      let idx = 0;
	      while (size >= 1000 && idx < units.length - 1) {
	        size /= 1000;
	        idx++;
	      }
	      if (idx === 0) return `${Math.floor(size)} ${units[idx]}`;
	      if (size >= 100) return `${size.toFixed(0)} ${units[idx]}`;
	      if (size >= 10) return `${size.toFixed(1)} ${units[idx]}`;
	      return `${size.toFixed(2)} ${units[idx]}`;
	    };

	    const renderUsageChart = async () => {
	      const el = document.getElementById("profile-usage-chart");
	      if (!el || !profile?.pppoe || !profile?.usage?.enabled || !profile?.usage?.active) return;
	      const kpiTransfer = document.getElementById("profile-usage-stat-transfer");
	      const kpiMax = document.getElementById("profile-usage-stat-max");
	      const kpiAvg = document.getElementById("profile-usage-stat-avg");
	      const kpiIdle = document.getElementById("profile-usage-stat-idle");
	      try {
	        const hours = Number(profile.window_hours || 24) || 24;
	        const params = new URLSearchParams({ pppoe: String(profile.pppoe), hours: String(hours) });
	        const res = await fetch(`/usage/series?${params.toString()}`, { headers: { "Accept": "application/json" } });
	        if (!res.ok) return;
	        const payload = await res.json().catch(() => null);
	        const seriesRaw = Array.isArray(payload?.series) ? payload.series : [];
	        const nowMs = Date.now();
	        const windowStartMs = nowMs - (hours * 3600 * 1000);
	        const windowEndMs = nowMs;

	        const points = seriesRaw
	          .map((p) => {
	            const ts = Date.parse(String(p?.ts || ""));
	            if (!Number.isFinite(ts)) return null;
	            const dl = p?.dl_bps === null || p?.dl_bps === undefined ? null : Number(p.dl_bps);
	            const ul = p?.ul_bps === null || p?.ul_bps === undefined ? null : Number(p.ul_bps);
	            const devicesRaw = p?.devices;
	            const devices = (devicesRaw === null || devicesRaw === undefined || devicesRaw === "") ? null : Number(devicesRaw);
	            return { x: ts, dl: Number.isFinite(dl) ? dl : null, ul: Number.isFinite(ul) ? ul : null, devices: Number.isFinite(devices) ? devices : null };
	          })
	          .filter((p) => p !== null)
	          .sort((a, b) => a.x - b.x);

	        let dlSeries = points.map((p) => ({ x: p.x, y: p.dl, devices: p.devices }));
	        let ulSeries = points.map((p) => ({ x: p.x, y: p.ul, devices: p.devices }));
	        if (!dlSeries.length) dlSeries = [{ x: windowStartMs, y: null, devices: null }, { x: windowEndMs, y: null, devices: null }];
	        if (!ulSeries.length) ulSeries = [{ x: windowStartMs, y: null, devices: null }, { x: windowEndMs, y: null, devices: null }];

	        // Stats (approx) based on samples.
	        const idleBps = Math.max(0, Number(profile?.usage?.idle_kbps_to || 8) * 1000);
	        let maxTotal = 0;
	        let sumTotal = 0;
	        let countTotal = 0;
	        let idleCount = 0;
	        let bytesEst = 0;
	        for (let i = 0; i < points.length; i++) {
	          const cur = points[i];
	          const dl = Number(cur.dl || 0);
	          const ul = Number(cur.ul || 0);
	          const total = Math.max(0, dl + ul);
	          maxTotal = Math.max(maxTotal, total);
	          sumTotal += total;
	          countTotal += 1;
	          if (total <= idleBps) idleCount += 1;
	          if (i > 0) {
	            const prev = points[i - 1];
	            const dt = Math.max(0, (cur.x - prev.x) / 1000);
	            const prevTotal = Math.max(0, Number(prev.dl || 0) + Number(prev.ul || 0));
	            // trapezoid integration of bps -> bytes
	            bytesEst += ((prevTotal + total) / 2) * dt / 8;
	          }
	        }
	        if (kpiTransfer) kpiTransfer.textContent = points.length ? fmtBytes(bytesEst) : "n/a";
	        if (kpiMax) kpiMax.textContent = points.length ? fmtBps(maxTotal) : "n/a";
	        if (kpiAvg) kpiAvg.textContent = points.length ? fmtBps(sumTotal / Math.max(1, countTotal)) : "n/a";
	        if (kpiIdle) kpiIdle.textContent = points.length ? `${((idleCount / Math.max(1, countTotal)) * 100).toFixed(0)}%` : "n/a";

	        const chart = new window.ApexCharts(el, {
	          chart: { type: "line", height: 260, toolbar: { show: false }, zoom: { enabled: false }, animations: { enabled: false } },
	          series: [
	            { name: "DL", data: dlSeries },
	            { name: "UL", data: ulSeries },
	          ],
	          colors: ["#206bc4", "#2fb344"],
	          stroke: { width: 2, curve: "smooth" },
	          markers: { size: 0 },
	          xaxis: { type: "datetime", min: windowStartMs, max: windowEndMs, tooltip: { enabled: false } },
	          yaxis: { labels: { formatter: (val) => fmtBps(val) } },
	          tooltip: {
	            shared: true,
	            intersect: false,
	            followCursor: true,
	            y: {
	              formatter: (val, { seriesIndex, dataPointIndex, w }) => {
	                const formatted = fmtBps(val);
	                const devices = w?.config?.series?.[seriesIndex]?.data?.[dataPointIndex]?.devices ?? null;
	                if (devices === null || devices === undefined || devices === "") return formatted;
	                const n = Number(devices);
	                if (!Number.isFinite(n)) return formatted;
	                return `${formatted} · Devices: ${n}`;
	              },
	            },
	          },
	          grid: { borderColor: "#e9ecef" },
	          legend: { position: "top" },
	        });
	        chart.render();
	      } catch (err) {
	        // ignore
	      }
	    };

	    renderAccPingChart();
	    renderOpticalChart();
	    renderUsageChart();

	    if (top10Wrap && !profile?.ip && !profile?.device_id) {
	      fetchSuggest();
	    }
  });
</script>

{% endblock %}
