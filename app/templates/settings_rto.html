{% extends "base.html" %}
{% block title %}Request Timeout Customers{% endblock %}
{% block header_title %}Request Timeout Customers{% endblock %}
{% block header_badge %}
  <span class="badge bg-purple-lt text-purple header-icon-badge"><i class="ti ti-tower"></i></span>
{% endblock %}
{% block content %}
{% if message %}
  <div class="alert alert-info">{{ message }}</div>
{% endif %}

<div class="card">
  <div class="card-body">
    <ul class="nav nav-tabs" data-bs-toggle="tabs">
      <li class="nav-item">
        <a href="#rto-status" class="nav-link {% if active_tab == 'status' %}active{% endif %}" data-bs-toggle="tab">RTO Status</a>
      </li>
      <li class="nav-item">
        <a href="#rto-settings" class="nav-link {% if active_tab != 'status' %}active{% endif %}" data-bs-toggle="tab">Settings</a>
      </li>
    </ul>

    <div class="tab-content pt-4">
      <div class="tab-pane {% if active_tab == 'status' %}active{% endif %}" id="rto-status">
        <div id="rto-loading-overlay" style="display: none; position: fixed; inset: 0; background: rgba(255,255,255,0.75); z-index: 1050; align-items: center; justify-content: center;">
          <div class="spinner-border text-primary" role="status" aria-hidden="true"></div>
        </div>
        <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-2">
          <div>
            <h4 class="mb-1">RTO Status <span class="badge bg-azure-lt" id="rto-status-window">{{ rto_status.window_label }}</span></h4>
            <div class="text-muted small">
              Last run: {{ rto_job.last_run_at_ph or 'n/a' }} · Last success: {{ rto_job.last_success_at_ph or 'n/a' }}
            </div>
          </div>
          <div class="d-flex gap-2 align-items-center">
            <span class="badge bg-blue-lt">Total: {{ rto_status.total }}</span>
            <span class="badge bg-red-lt">Issues: {{ rto_status.issue_total }}</span>
            <span class="badge bg-green-lt">Stable: {{ rto_status.stable_total }}</span>
            <div class="dropdown">
              <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" id="rto-window-button">Filter</button>
              <div class="dropdown-menu dropdown-menu-end" id="rto-window-menu">
                {% for label, hours in rto_window_options %}
                  <div class="dropdown-item d-flex align-items-center justify-content-between rto-window-row" data-hours="{{ hours }}" data-label="{{ label }}">
                    <span>{{ label }}</span>
                    <button class="btn btn-sm btn-link p-0 rto-window-star-btn" data-hours="{{ hours }}" title="Set default filter">
                      <i class="ti ti-star text-muted"></i>
                    </button>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <div class="alert alert-info">
          <div class="d-flex align-items-start">
            <span class="me-2"><i class="ti ti-info-circle"></i></span>
            <div>
              Connection issues are shown when a customer is currently down, RTO is at least {{ rto_status.rules.issue_rto_pct }}%, or the down streak is {{ rto_status.rules.issue_streak }}+ checks.
              Stable connections are shown when status is up and RTO is {{ rto_status.rules.stable_rto_pct }}% or lower.
            </div>
          </div>
        </div>

        <ul class="nav nav-tabs" data-bs-toggle="tabs">
          <li class="nav-item">
            <a href="#rto-issues" class="nav-link active" data-bs-toggle="tab">Connection Issues</a>
          </li>
          <li class="nav-item">
            <a href="#rto-stable" class="nav-link" data-bs-toggle="tab">Stable Connections</a>
          </li>
          <li class="nav-item ms-auto">
            <div class="px-2 py-2">
              <div class="input-icon">
                <input class="form-control form-control-sm" id="rto-status-search" type="text" placeholder="Search" autocomplete="off" />
                <span class="input-icon-addon">
                  <i class="ti ti-search"></i>
                </span>
              </div>
            </div>
          </li>
        </ul>
        <div class="tab-content pt-3">
          <div class="tab-pane active" id="rto-issues">
            <div class="rto-table-shell">
              <div class="rto-table-wrap" id="rto-issues-table">
              <table class="table table-vcenter rto-table">
                <thead>
                  <tr>
                    <th class="rto-tip rto-sort" data-sort="text" aria-sort="none" title="Customer or circuit name pulled from the CSV (Circuit Name, Device Name, Circuit ID). Use this to identify the subscriber." data-tip="Customer or circuit name pulled from the CSV (Circuit Name, Device Name, Circuit ID). Use this to identify the subscriber.">Customer <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort="text" aria-sort="none" title="IPv4 address that the system pings for this subscriber." data-tip="IPv4 address that the system pings for this subscriber.">IPv4 <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort="text" aria-sort="none" title="Latest ping result. Up means the last check replied, Down means it failed, and Monitor means it is up now but still exceeds the issue thresholds." data-tip="Latest ping result. Up means the last check replied, Down means it failed, and Monitor means it is up now but still exceeds the issue thresholds.">Status <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort="number" aria-sort="none" title="Request Timeout percentage within the current history window. Higher means more failed checks." data-tip="Request Timeout percentage within the current history window. Higher means more failed checks.">RTO % <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort="number" aria-sort="none" title="Uptime percentage within the same window. It is 100 minus RTO %." data-tip="Uptime percentage within the same window. It is 100 minus RTO %.">Uptime % <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort="number" aria-sort="none" title="Number of consecutive failed checks at the end of the window. Helps spot persistent outages." data-tip="Number of consecutive failed checks at the end of the window. Helps spot persistent outages.">Down Streak <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort="number" aria-sort="none" title="Number of recent checks stored in the history window. More checks means more reliable percentages." data-tip="Number of recent checks stored in the history window. More checks means more reliable percentages.">Total Checks <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort="date" aria-sort="none" title="Timestamp of the most recent check recorded for this subscriber." data-tip="Timestamp of the most recent check recorded for this subscriber.">Last Check <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-trend-header" title="Up/down history for this subscriber based on raw ping results." data-tip="Up/down history for this subscriber based on raw ping results. Click to expand.">{{ rto_status.window_label }} Trend</th>
                    <th class="rto-tip rto-sort" data-sort="text" aria-sort="none" title="Why this subscriber appears in Connection Issues, based on the configured thresholds." data-tip="Why this subscriber appears in Connection Issues, based on the configured thresholds.">Reason <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in rto_status.issue_rows %}
                    <tr>
                      <td>{{ row.name }}</td>
                      <td>{{ row.ip }}</td>
                      <td>
                        {% if row.last_status == 'down' %}
                          <span class="badge bg-red-lt">Down</span>
                        {% else %}
                          <span class="badge bg-yellow-lt">Monitor</span>
                        {% endif %}
                      </td>
                      <td>{{ "%.1f"|format(row.rto_pct) }}</td>
                      <td>{{ "%.1f"|format(row.uptime_pct) }}</td>
                      <td>{{ row.streak }}</td>
                      <td>{{ row.total }}</td>
                      <td>{{ row.last_check or 'n/a' }}</td>
                      <td>
                        {% if row.spark_points_window %}
                          <button type="button"
                                  class="btn btn-link p-0 rto-spark-btn"
                                  data-name="{{ row.name }}"
                                  data-ip="{{ row.ip }}"
                                  data-status="{% if row.last_status == 'down' %}down{% else %}monitor{% endif %}"
                                  data-points="{{ row.spark_points_window_large }}"
                                  data-width="640"
                                  data-height="200"
                                  data-bs-toggle="modal"
                                  data-bs-target="#rto-spark-modal">
                            <svg class="rto-sparkline" width="120" height="30" viewBox="0 0 120 30" preserveAspectRatio="none">
                              <polyline points="{{ row.spark_points_window }}" fill="none" stroke="{% if row.last_status == 'down' %}#d63939{% else %}#f59f00{% endif %}" stroke-width="2"></polyline>
                            </svg>
                          </button>
                        {% else %}
                          <span class="text-muted small">n/a</span>
                        {% endif %}
                      </td>
                      <td>{{ row.reasons|join(', ') }}</td>
                    </tr>
                  {% else %}
                    <tr>
                      <td colspan="10" class="text-muted">No connection issues detected yet.</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
              </div>
              <div class="rto-resize-handle" data-target="rto-issues-table"></div>
            </div>
          </div>

          <div class="tab-pane" id="rto-stable">
            <div class="rto-table-shell">
              <div class="rto-table-wrap" id="rto-stable-table">
              <table class="table table-vcenter rto-table">
                <thead>
                  <tr>
                    <th class="rto-tip rto-sort" data-sort="text" aria-sort="none" title="Customer or circuit name pulled from the CSV (Circuit Name, Device Name, Circuit ID)." data-tip="Customer or circuit name pulled from the CSV (Circuit Name, Device Name, Circuit ID).">Customer <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort="text" aria-sort="none" title="IPv4 address that the system pings for this subscriber." data-tip="IPv4 address that the system pings for this subscriber.">IPv4 <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort="text" aria-sort="none" title="Latest ping result for this subscriber in the current window." data-tip="Latest ping result for this subscriber in the current window.">Status <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort="number" aria-sort="none" title="Uptime percentage within the history window. Higher means more reliable connectivity." data-tip="Uptime percentage within the history window. Higher means more reliable connectivity.">Uptime % <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort="number" aria-sort="none" title="Request Timeout percentage within the current window. Lower values indicate stable connections." data-tip="Request Timeout percentage within the current window. Lower values indicate stable connections.">RTO % <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort="number" aria-sort="none" title="Number of recent checks stored in the history window." data-tip="Number of recent checks stored in the history window.">Total Checks <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort="date" aria-sort="none" title="Timestamp of the most recent check recorded for this subscriber." data-tip="Timestamp of the most recent check recorded for this subscriber.">Last Check <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-trend-header" title="Up/down history for this subscriber based on raw ping results." data-tip="Up/down history for this subscriber based on raw ping results. Click to expand.">{{ rto_status.window_label }} Trend</th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in rto_status.stable_rows %}
                    <tr>
                      <td>{{ row.name }}</td>
                      <td>{{ row.ip }}</td>
                      <td><span class="badge bg-green-lt">Up</span></td>
                      <td>{{ "%.1f"|format(row.uptime_pct) }}</td>
                      <td>{{ "%.1f"|format(row.rto_pct) }}</td>
                      <td>{{ row.total }}</td>
                      <td>{{ row.last_check or 'n/a' }}</td>
                      <td>
                        {% if row.spark_points_window %}
                          <button type="button"
                                  class="btn btn-link p-0 rto-spark-btn"
                                  data-name="{{ row.name }}"
                                  data-ip="{{ row.ip }}"
                                  data-status="up"
                                  data-points="{{ row.spark_points_window_large }}"
                                  data-width="640"
                                  data-height="200"
                                  data-bs-toggle="modal"
                                  data-bs-target="#rto-spark-modal">
                            <svg class="rto-sparkline" width="120" height="30" viewBox="0 0 120 30" preserveAspectRatio="none">
                              <polyline points="{{ row.spark_points_window }}" fill="none" stroke="#2fb344" stroke-width="2"></polyline>
                            </svg>
                          </button>
                        {% else %}
                          <span class="text-muted small">n/a</span>
                        {% endif %}
                      </td>
                    </tr>
                  {% else %}
                    <tr>
                      <td colspan="8" class="text-muted">No stable connections listed yet.</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
              </div>
              <div class="rto-resize-handle" data-target="rto-stable-table"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="tab-pane {% if active_tab != 'status' %}active{% endif %}" id="rto-settings">
        <form method="post">
          <input type="hidden" name="active_tab" value="settings" />
          <input type="hidden" name="settings_tab" id="rto-settings-tab" value="{{ settings_tab or 'general' }}" />

          <div class="d-flex flex-wrap align-items-center justify-content-between mb-2 gap-2">
            <h4 class="mb-0">RTO Settings</h4>
            <span class="text-muted small">Configure how RTO data is collected, classified, and reported.</span>
          </div>

          <ul class="nav nav-tabs" data-bs-toggle="tabs">
            <li class="nav-item">
              <a href="#rto-general" class="nav-link {% if settings_tab == 'general' %}active{% endif %}" data-bs-toggle="tab">General</a>
            </li>
            <li class="nav-item">
              <a href="#rto-data" class="nav-link {% if settings_tab == 'data' %}active{% endif %}" data-bs-toggle="tab">Data Source</a>
            </li>
            <li class="nav-item">
              <a href="#rto-notifications" class="nav-link {% if settings_tab == 'notifications' %}active{% endif %}" data-bs-toggle="tab">Notifications</a>
            </li>
            <li class="nav-item">
              <a href="#rto-classification" class="nav-link {% if settings_tab == 'classification' %}active{% endif %}" data-bs-toggle="tab">Classification</a>
            </li>
            <li class="nav-item">
              <a href="#rto-danger" class="nav-link {% if settings_tab == 'danger' %}active{% endif %}" data-bs-toggle="tab">Danger</a>
            </li>
          </ul>

          <div class="tab-content pt-4">
            <div class="tab-pane {% if settings_tab == 'general' %}active{% endif %}" id="rto-general">
              <div class="card mb-3">
                <div class="card-body">
                  <div class="alert alert-info">
                    <div class="d-flex align-items-start">
                      <span class="me-2"><i class="ti ti-info-circle"></i></span>
                      <div>Enable the RTO job and set the schedule that triggers daily checks.</div>
                    </div>
                  </div>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">Enable RTO notifier <span class="info" data-tip="Turns on the scheduled RTO job that pulls the CSV and pings all customer IPs.">i</span></label>
                      <label class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="enabled" {% if settings.enabled %}checked{% endif %} />
                        <span class="form-check-label">Active</span>
                      </label>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Ping Interval (minutes) <span class="info" data-tip="How often the server runs RTO pings and stores results.">i</span></label>
                      <input class="form-control" type="number" name="ping_interval_minutes" value="{{ settings.general.ping_interval_minutes }}" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">History Window Size <span class="info" data-tip="Number of recent checks stored per customer for RTO calculations.">i</span></label>
                      <input class="form-control" type="number" name="window_size" value="{{ settings.history.window_size }}" />
      </div>
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="rto-spark-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="rto-spark-title">RTO Trend</h5>
        <div class="dropdown ms-auto">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" id="rto-modal-window-button">Filter</button>
          <div class="dropdown-menu dropdown-menu-end" id="rto-modal-window-menu">
            {% for label, hours in rto_window_options %}
              <button class="dropdown-item rto-modal-window-option" data-hours="{{ hours }}" data-label="{{ label }}">{{ label }}</button>
            {% endfor %}
          </div>
        </div>
        <button type="button" class="btn-close ms-2" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="rto-spark-modal-chart" class="rto-spark-modal-chart"></div>
        <div class="text-muted small mt-2">Up/down history based on raw ping results for the selected window.</div>
      </div>
    </div>
  </div>
</div>

<script>
	  document.addEventListener("DOMContentLoaded", () => {
    const tabLinks = document.querySelectorAll('a[data-bs-toggle="tab"]');
    const tabKey = "rto_status_active_tab";
    const storedTab = localStorage.getItem(tabKey);
    if (window.location.hash) {
      const target = document.querySelector(`a[href="${window.location.hash}"]`);
      if (target && window.bootstrap?.Tab) {
        new window.bootstrap.Tab(target).show();
      }
    } else if (storedTab) {
      const target = document.querySelector(`a[href="${storedTab}"]`);
      if (target && window.bootstrap?.Tab) {
        new window.bootstrap.Tab(target).show();
      }
    }
    tabLinks.forEach((link) => {
      link.addEventListener("shown.bs.tab", (event) => {
        const href = event.target.getAttribute("href");
        if (href) {
          localStorage.setItem(tabKey, href);
          history.replaceState(null, "", href);
        }
      });
    });

    const windowBadge = document.getElementById("rto-status-window");
    const windowButton = document.getElementById("rto-window-button");
    const windowOptions = document.querySelectorAll(".rto-window-row");
    const windowStars = document.querySelectorAll(".rto-window-star-btn");
    const windowParam = new URLSearchParams(window.location.search).get("window");
    let defaultWindow = localStorage.getItem("rto_status_default_window");
    if (!defaultWindow) {
      defaultWindow = "24";
      localStorage.setItem("rto_status_default_window", defaultWindow);
    }
    let currentWindow = windowParam || defaultWindow;
    if (!windowParam && windowBadge) {
      const url = new URL(window.location.href);
      url.searchParams.set("window", currentWindow);
      window.location.replace(url.toString());
      return;
    }
    const loadingOverlay = document.getElementById("rto-loading-overlay");
    const showLoading = () => {
      if (loadingOverlay) {
        loadingOverlay.style.display = "flex";
      }
    };
    const hideLoading = () => {
      if (loadingOverlay) {
        loadingOverlay.style.display = "none";
      }
    };
    showLoading();
    window.addEventListener("load", () => {
      hideLoading();
    });
    const updateStars = () => {
      windowStars.forEach((btn) => {
        const icon = btn.querySelector("i");
        if (!icon) return;
        if (btn.dataset.hours === defaultWindow) {
          icon.classList.remove("ti-star");
          icon.classList.add("ti-star-filled", "text-warning");
        } else {
          icon.classList.remove("ti-star-filled", "text-warning");
          icon.classList.add("ti-star");
        }
      });
    };
    const updateButtonLabel = () => {
      const label = windowBadge ? windowBadge.textContent.trim() : "1D";
      const isDefault = currentWindow === defaultWindow;
      if (windowButton) {
        windowButton.textContent = isDefault ? `Filter: ${label} ⭐` : `Filter: ${label}`;
      }
      document.querySelectorAll(".rto-trend-header").forEach((el) => {
        el.textContent = `${label} Trend`;
      });
    };
    updateStars();
    updateButtonLabel();
    windowOptions.forEach((row) => {
      row.addEventListener("click", () => {
        currentWindow = row.dataset.hours;
        updateStars();
        updateButtonLabel();
        const url = new URL(window.location.href);
        url.searchParams.set("window", currentWindow);
        const tabHash = localStorage.getItem(tabKey) || window.location.hash;
        if (tabHash) {
          url.hash = tabHash;
        }
        showLoading();
        window.location.href = url.toString();
      });
    });
    windowStars.forEach((btn) => {
      btn.addEventListener("click", (event) => {
        event.preventDefault();
        event.stopPropagation();
        defaultWindow = btn.dataset.hours;
        localStorage.setItem("rto_status_default_window", defaultWindow);
        updateStars();
        updateButtonLabel();
      });
    });

    const parseSortValue = (value, type) => {
      if (type === "number") {
        const cleaned = value.replace(/[^0-9.-]/g, "");
        const parsed = parseFloat(cleaned);
        return Number.isNaN(parsed) ? -Infinity : parsed;
      }
      if (type === "date") {
        const parsed = Date.parse(value);
        return Number.isNaN(parsed) ? -Infinity : parsed;
      }
      return value.toLowerCase();
    };

    const setupSortableTable = (table) => {
      if (!table) return;
      const headers = Array.from(table.querySelectorAll("th.rto-sort"));
      if (!headers.length) return;
      const tbody = table.querySelector("tbody");
      table.addEventListener("click", (event) => {
        const header = event.target.closest("th.rto-sort");
        if (!header || !table.contains(header)) return;
        if (!tbody) return;
        const index = headers.indexOf(header);
        if (index < 0) return;
        const rows = Array.from(tbody.querySelectorAll("tr"));
        if (rows.length <= 1 && rows[0]?.querySelector("td[colspan]")) {
          return;
        }
        const currentDir = header.dataset.sortDir === "asc" ? "asc" : "desc";
        const nextDir = currentDir === "asc" ? "desc" : "asc";
        headers.forEach((th) => {
          delete th.dataset.sortDir;
          th.classList.remove("rto-sorted-asc", "rto-sorted-desc");
          th.setAttribute("aria-sort", "none");
          const indicator = th.querySelector(".rto-sort-indicator");
          if (indicator) {
            indicator.textContent = "";
          }
        });
        header.dataset.sortDir = nextDir;
        header.classList.add(nextDir === "asc" ? "rto-sorted-asc" : "rto-sorted-desc");
        header.setAttribute("aria-sort", nextDir === "asc" ? "ascending" : "descending");
        const indicator = header.querySelector(".rto-sort-indicator");
        if (indicator) {
          indicator.textContent = nextDir === "asc" ? "▲" : "▼";
        }
        let sortType = header.dataset.sort || "text";
        let sortIndex = index;
        if (sortType === "trend") {
          const rtoHeader = headers.find((item) =>
            (item.textContent || "").trim().toLowerCase().startsWith("rto %")
          );
          if (rtoHeader) {
            sortIndex = headers.indexOf(rtoHeader);
            sortType = rtoHeader.dataset.sort || "number";
          }
        }
        rows.sort((a, b) => {
          const aCell = a.children[sortIndex]?.textContent.trim() || "";
          const bCell = b.children[sortIndex]?.textContent.trim() || "";
          const aValue = parseSortValue(aCell, sortType);
          const bValue = parseSortValue(bCell, sortType);
          let result = 0;
          if (typeof aValue === "number" && typeof bValue === "number") {
            result = aValue - bValue;
          } else {
            result = String(aValue).localeCompare(String(bValue), undefined, { numeric: true, sensitivity: "base" });
          }
          return nextDir === "asc" ? result : -result;
        });
        rows.forEach((row) => tbody.appendChild(row));
      });
    };

	    document.querySelectorAll(".rto-table").forEach((table) => {
	      setupSortableTable(table);
	    });

	    const rtoSearch = document.getElementById("rto-status-search");
	    const applyTableFilter = (tableWrapId, query) => {
	      const wrap = document.getElementById(tableWrapId);
	      const table = wrap ? wrap.querySelector("table") : null;
	      const tbody = table ? table.querySelector("tbody") : null;
	      if (!tbody) return;
	      const q = (query || "").trim().toLowerCase();
	      const rows = Array.from(tbody.querySelectorAll("tr"));
	      let emptyRow = null;
	      let visible = 0;
	      rows.forEach((row) => {
	        const isEmpty = !!row.querySelector("td[colspan]");
	        if (isEmpty) {
	          emptyRow = row;
	          return;
	        }
	        const text = (row.textContent || "").toLowerCase();
	        const match = !q || text.includes(q);
	        row.style.display = match ? "" : "none";
	        if (match) visible += 1;
	      });
	      if (emptyRow) {
	        emptyRow.style.display = visible === 0 ? "" : "none";
	      }
	    };
	    const applyRtoSearch = () => {
	      const query = rtoSearch ? rtoSearch.value : "";
	      applyTableFilter("rto-issues-table", query);
	      applyTableFilter("rto-stable-table", query);
	    };
	    if (rtoSearch) {
	      rtoSearch.addEventListener("input", applyRtoSearch);
	      applyRtoSearch();
	    }

	    const modalTitle = document.getElementById("rto-spark-title");
    const modalChart = document.getElementById("rto-spark-modal-chart");
    const modalWindowButton = document.getElementById("rto-modal-window-button");
    const modalWindowOptions = document.querySelectorAll(".rto-modal-window-option");
    let modalChartInstance = null;
    const modalEl = document.getElementById("rto-spark-modal");
    let modalIp = "";
    let modalStatus = "up";
    if (modalEl && modalEl.parentElement !== document.body) {
      document.body.appendChild(modalEl);
    }

    const renderModalChart = async (name, ip, status, hours) => {
      const colorMap = { up: "#2fb344", down: "#d63939", monitor: "#f59f00" };
      const stroke = colorMap[status] || "#2fb344";
      const label = hours >= 24 ? `${Math.floor(hours / 24)}D` : `${hours}H`;
      modalTitle.textContent = `${name} (${ip}) · ${label} Trend`;
      if (modalWindowButton) {
        modalWindowButton.textContent = `Filter: ${label}`;
      }
      if (modalChartInstance) {
        modalChartInstance.destroy();
        modalChartInstance = null;
      }
      modalChart.innerHTML = "<div class='text-muted'>Loading chart...</div>";
      try {
        const params = new URLSearchParams({ ip, window: String(hours) });
        const res = await fetch(`/rto/series?${params.toString()}`, { headers: { "Accept": "application/json" } });
        if (!res.ok) {
          modalChart.innerHTML = "<div class='text-muted'>No data available.</div>";
          return;
        }
        const payload = await res.json();
        const series = (payload.series || []).map((item) => ({
          x: item.ts,
          y: item.value,
        }));
        if (!series.length) {
          modalChart.innerHTML = "<div class='text-muted'>No data available.</div>";
          return;
        }
        modalChart.innerHTML = "";
        const formatTime = (value) =>
          new Date(value).toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit" });
        const formatDate = (value) =>
          new Date(value).toLocaleDateString("en-US", { month: "short", day: "2-digit" });
        const labelFormatter = hours <= 24 ? formatTime : formatDate;
        const options = {
          chart: {
            type: "line",
            height: 220,
            toolbar: { show: false },
            zoom: { enabled: false },
          },
          stroke: { curve: "straight", width: 2 },
          colors: [stroke],
          markers: { size: 0 },
          series: [{ name: "Uptime", data: series }],
          xaxis: {
            type: "datetime",
            labels: { formatter: labelFormatter },
          },
          yaxis: {
            min: 0,
            max: 100,
            tickAmount: 2,
            labels: { formatter: (val) => `${val}%` },
          },
          tooltip: {
            x: { formatter: (val) => new Date(val).toLocaleString("en-US") },
            y: { formatter: (val) => `${val}%` },
          },
          grid: { strokeDashArray: 4 },
        };
        modalChartInstance = new ApexCharts(modalChart, options);
        modalChartInstance.render();
      } catch (err) {
        modalChart.innerHTML = "<div class='text-muted'>No data available.</div>";
      }
    };

    document.querySelectorAll(".rto-spark-btn").forEach((btn) => {
      btn.addEventListener("click", async () => {
        const name = btn.getAttribute("data-name") || "";
        modalIp = btn.getAttribute("data-ip") || "";
        modalStatus = btn.getAttribute("data-status") || "up";
        const windowText = windowBadge ? windowBadge.textContent.trim() : "1D";
        const hours = windowText.endsWith("H")
          ? parseInt(windowText.replace("H", ""), 10)
          : windowText.endsWith("D")
            ? parseInt(windowText.replace("D", ""), 10) * 24
            : 24;
        await renderModalChart(name, modalIp, modalStatus, hours);
      });
    });

    modalWindowOptions.forEach((btn) => {
      btn.addEventListener("click", async () => {
        const hours = parseInt(btn.dataset.hours || "24", 10);
        const name = modalTitle.textContent.split(" (")[0] || "RTO";
        await renderModalChart(name, modalIp, modalStatus, hours);
      });
    });
  });
</script>
            </div>

            <div class="tab-pane {% if settings_tab == 'data' %}active{% endif %}" id="rto-data">
              <div class="card mb-3">
                <div class="card-body">
                  <div class="alert alert-info">
                    <div class="d-flex align-items-start">
                      <span class="me-2"><i class="ti ti-info-circle"></i></span>
                      <div>RTO uses SSH to pull the ShapedDevices CSV and pings each IPv4 entry.</div>
                    </div>
                  </div>
                  <h5 class="mb-3">SSH Source</h5>
                  <div class="row g-3 mb-4">
                    <div class="col-md-6">
                      <label class="form-label">Host <span class="info" data-tip="SSH host that contains the ShapedDevices CSV file.">i</span></label>
                      <input class="form-control" type="text" name="ssh_host" value="{{ settings.ssh.host }}" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Port <span class="info" data-tip="SSH port (usually 22).">i</span></label>
                      <input class="form-control" type="number" name="ssh_port" value="{{ settings.ssh.port }}" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">User <span class="info" data-tip="SSH username for the remote host.">i</span></label>
                      <input class="form-control" type="text" name="ssh_user" value="{{ settings.ssh.user }}" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Password <span class="info" data-tip="SSH password (leave blank if using a private key).">i</span></label>
                      <input class="form-control" type="password" name="ssh_password" value="{{ settings.ssh.password }}" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Use SSH Key <span class="info" data-tip="Enable when authenticating with a private key file.">i</span></label>
                      <label class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="ssh_use_key" {% if settings.ssh.use_key %}checked{% endif %} />
                        <span class="form-check-label">Enabled</span>
                      </label>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Key Path <span class="info" data-tip="Path to the private key inside the container.">i</span></label>
                      <input class="form-control" type="text" name="ssh_key_path" value="{{ settings.ssh.key_path }}" />
                    </div>
                    <div class="col-md-12">
                      <label class="form-label">Remote CSV Path <span class="info" data-tip="Absolute path to ShapedDevices.csv on the remote host.">i</span></label>
                      <input class="form-control" type="text" name="ssh_remote_csv_path" value="{{ settings.ssh.remote_csv_path }}" />
                    </div>
                  </div>
                </div>
              </div>

              <div class="card mb-3">
                <div class="card-body">
                  <h5 class="mb-3">Ping Settings</h5>
                  <div class="alert alert-info">
                    <div class="d-flex align-items-start">
                      <span class="me-2"><i class="ti ti-info-circle"></i></span>
                      <div>
                        Sample sizing: on a 4-core / 6GB server, 64 workers is a safe starting point for 800 IPs.
                        Each worker runs one ping task per IP, then moves to the next.
                      </div>
                    </div>
                  </div>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">Count <span class="info" data-tip="How many ICMP packets to send per IP per run (example: 5). More packets increase accuracy but take longer.">i</span></label>
                      <input class="form-control" type="number" name="ping_count" value="{{ settings.ping.count }}" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Timeout (seconds) <span class="info" data-tip="Per-packet timeout. If each packet takes longer than this, it counts as a failure. Lower values are faster but stricter.">i</span></label>
                      <input class="form-control" type="number" name="per_ping_timeout_sec" value="{{ settings.ping.per_ping_timeout_sec }}" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Max Workers <span class="info" data-tip="Parallel ping tasks. 1 worker = 1 IP at a time. Higher values finish faster but use more CPU and ICMP bandwidth.">i</span></label>
                      <input class="form-control" type="number" name="max_workers" value="{{ settings.ping.max_workers }}" />
                    </div>
                  </div>
                </div>
              </div>

              <div class="card mb-3">
                <div class="card-body">
                  <h5 class="mb-3">Storage</h5>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">Raw Retention Days <span class="info" data-tip="How long to keep per-check RTO history in the database. Older records are pruned daily.">i</span></label>
                      <input class="form-control" type="number" name="rto_raw_retention_days" value="{{ settings.storage.raw_retention_days }}" />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane {% if settings_tab == 'notifications' %}active{% endif %}" id="rto-notifications">
              <div class="card mb-3">
                <div class="card-body">
                  <div class="alert alert-info">
                    <div class="d-flex align-items-start">
                      <span class="me-2"><i class="ti ti-info-circle"></i></span>
                      <div>Telegram notifications send the RTO list to your chat once per schedule.</div>
                    </div>
                  </div>
                  <div class="row g-3 mb-4">
                    <div class="col-md-6">
                      <label class="form-label">Bot Token <span class="info" data-tip="Telegram bot token from BotFather.">i</span></label>
                      <input class="form-control" type="text" name="telegram_bot_token" value="{{ settings.telegram.bot_token }}" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Chat ID <span class="info" data-tip="Telegram chat ID where RTO alerts should be sent.">i</span></label>
                      <input class="form-control" type="text" name="telegram_chat_id" value="{{ settings.telegram.chat_id }}" />
                    </div>
                  </div>
                </div>
              </div>

              <div class="card mb-3">
                <div class="card-body">
                  <h5 class="mb-3">Daily Report Schedule</h5>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">Schedule Time (HH:MM) <span class="info" data-tip="Daily time to send the Telegram report (24-hour format).">i</span></label>
                      <input class="form-control" type="text" name="schedule_time_ph" value="{{ settings.general.schedule_time_ph }}" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Timezone <span class="info" data-tip="Timezone used for the daily report schedule, e.g., Asia/Manila.">i</span></label>
                      <input class="form-control" type="text" name="timezone" value="{{ settings.general.timezone }}" />
                    </div>
                  </div>
                </div>
              </div>

              <div class="card mb-3">
                <div class="card-body">
                  <h5 class="mb-3">Message Format</h5>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">Message Title <span class="info" data-tip="Title shown at the top of each Telegram message.">i</span></label>
                      <input class="form-control" type="text" name="message_title" value="{{ settings.general.message_title }}" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Include Header <span class="info" data-tip="Adds a column header row inside the Telegram message.">i</span></label>
                      <label class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="include_header" {% if settings.general.include_header %}checked{% endif %} />
                        <span class="form-check-label">Enabled</span>
                      </label>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Output Mode <span class="info" data-tip="split sends multiple messages, truncate limits lines, summary_top shows worst offenders only.">i</span></label>
                      <select class="form-select" name="output_mode">
                        {% for option in ['split', 'truncate', 'summary_top'] %}
                          <option value="{{ option }}" {% if settings.general.output_mode == option %}selected{% endif %}>{{ option }}</option>
                        {% endfor %}
                      </select>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Max Characters <span class="info" data-tip="Split or truncate messages beyond this size.">i</span></label>
                      <input class="form-control" type="number" name="max_chars" value="{{ settings.general.max_chars }}" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Max Lines <span class="info" data-tip="Maximum lines for truncate mode.">i</span></label>
                      <input class="form-control" type="number" name="max_lines" value="{{ settings.general.max_lines }}" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Top N <span class="info" data-tip="Number of devices shown in summary_top mode.">i</span></label>
                      <input class="form-control" type="number" name="top_n" value="{{ settings.general.top_n }}" />
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <div class="tab-pane {% if settings_tab == 'classification' %}active{% endif %}" id="rto-classification">
              <div class="card mb-3">
                <div class="card-body">
                  <div class="alert alert-info">
                    <div class="d-flex align-items-start">
                      <span class="me-2"><i class="ti ti-info-circle"></i></span>
                      <div>Set the thresholds that separate connection issues from stable customers.</div>
                    </div>
                  </div>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">Issue RTO % (min) <span class="info" data-tip="Minimum RTO percentage required to classify a customer as having issues.">i</span></label>
                      <input class="form-control" type="number" step="0.1" name="issue_rto_pct" value="{{ settings.classification.issue_rto_pct }}" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Issue Down Streak (min) <span class="info" data-tip="Minimum consecutive failures required to flag a customer as an issue.">i</span></label>
                      <input class="form-control" type="number" name="issue_streak" value="{{ settings.classification.issue_streak }}" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Stable RTO % (max) <span class="info" data-tip="Maximum RTO percentage to classify a customer as stable.">i</span></label>
                      <input class="form-control" type="number" step="0.1" name="stable_rto_pct" value="{{ settings.classification.stable_rto_pct }}" />
                    </div>
                  </div>
                </div>
              </div>
            </div>
            <div class="tab-pane {% if settings_tab == 'danger' %}active{% endif %}" id="rto-danger">
              <div class="card mb-3">
                <div class="card-body">
                  <h4 class="mb-2">Format RTO Database</h4>
                  <div class="alert alert-warning">
                    <div class="d-flex align-items-center">
                      <span class="me-2"><i class="ti ti-alert-triangle"></i></span>
                      <div>Formatting removes stored RTO status history so the next run starts fresh.</div>
                    </div>
                  </div>
                  <label class="form-check">
                    <input class="form-check-input" type="checkbox" name="confirm_format" form="rto-format-form" />
                    <span class="form-check-label">I understand this will erase RTO history data.</span>
                  </label>
                  <div class="mt-3">
                    <button type="submit" class="btn btn-danger" form="rto-format-form">Format RTO Database</button>
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="d-flex justify-content-end gap-2">
            <button type="submit" class="btn btn-primary">Save RTO Settings</button>
            <button type="submit" class="btn" formaction="/settings/rto/test" formmethod="post">Send Test Telegram</button>
            <button type="submit" class="btn btn-outline-primary" formaction="/settings/rto/run" formmethod="post">Run RTO Now</button>
          </div>
        </form>
        <form id="rto-format-form" method="post" action="/settings/rto/format"></form>

      </div></div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", () => {
    const settingsInput = document.getElementById("rto-settings-tab");
    if (settingsInput) {
      const settingsTabs = document.querySelectorAll('#rto-settings [data-bs-toggle="tabs"] .nav-link');
      settingsTabs.forEach((tab) => {
        tab.addEventListener("shown.bs.tab", (event) => {
          const target = event.target.getAttribute("href") || "";
          if (target.startsWith("#rto-")) {
            settingsInput.value = target.replace("#rto-", "");
          }
        });
      });
    }

    const rtoWraps = document.querySelectorAll(".rto-table-wrap");
    rtoWraps.forEach((wrap) => {
      const head = wrap.querySelector("thead");
      if (head) {
        head.style.position = "sticky";
        head.style.top = "0";
        head.style.zIndex = "2";
      }
    });

    const handles = document.querySelectorAll(".rto-resize-handle");
    handles.forEach((handle) => {
      const targetId = handle.getAttribute("data-target");
      const wrap = targetId ? document.getElementById(targetId) : null;
      if (!wrap) return;

      let dragging = false;
      let startY = 0;
      let startHeight = 0;

      const onMove = (event) => {
        if (!dragging) return;
        const clientY = event.touches ? event.touches[0].clientY : event.clientY;
        const delta = clientY - startY;
        const newHeight = Math.max(260, startHeight + delta);
        wrap.style.height = `${newHeight}px`;

        const edge = 80;
        if (clientY > window.innerHeight - edge) {
          const distance = Math.max(0, clientY - (window.innerHeight - edge));
          const speed = 40 + distance * 3.5;
          window.scrollBy({ top: speed, behavior: "auto" });
        } else if (clientY < edge) {
          const distance = Math.max(0, edge - clientY);
          const speed = 40 + distance * 3.5;
          window.scrollBy({ top: -speed, behavior: "auto" });
        }
        event.preventDefault();
      };

      const stop = () => {
        dragging = false;
        document.body.style.cursor = "";
        document.body.style.userSelect = "";
        window.removeEventListener("mousemove", onMove);
        window.removeEventListener("touchmove", onMove, { passive: false });
        window.removeEventListener("mouseup", stop);
        window.removeEventListener("touchend", stop);
      };

      const start = (event) => {
        dragging = true;
        const clientY = event.touches ? event.touches[0].clientY : event.clientY;
        startY = clientY;
        startHeight = wrap.getBoundingClientRect().height;
        document.body.style.cursor = "row-resize";
        document.body.style.userSelect = "none";
        window.addEventListener("mousemove", onMove);
        window.addEventListener("touchmove", onMove, { passive: false });
        window.addEventListener("mouseup", stop);
        window.addEventListener("touchend", stop);
        event.preventDefault();
      };

      handle.addEventListener("mousedown", start);
      handle.addEventListener("touchstart", start, { passive: false });
    });
  });
</script>
{% endblock %}
