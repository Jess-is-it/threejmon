{% extends "base.html" %}
{% block content %}
<div class="page-header d-print-none">
  <div class="row align-items-center">
    <div class="col">
      <h2 class="page-title">RTO Settings</h2>
    </div>
  </div>
</div>

{% if message %}
  <div class="alert alert-info">{{ message }}</div>
{% endif %}

<div class="card">
  <div class="card-body">
    <form method="post">
      <div class="card mb-3">
        <div class="card-body">
          <h4 class="mb-3">General</h4>
          <label class="form-label">Enable RTO notifier</label>
          <label class="form-check form-switch">
            <input class="form-check-input" type="checkbox" name="enabled" {% if settings.enabled %}checked{% endif %} />
            <span class="form-check-label">Active</span>
          </label>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-body">
          <h4 class="mb-3">SSH</h4>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Host <span class="info" data-tip="SSH host that contains the ShapedDevices CSV.">i</span></label>
              <input class="form-control" type="text" name="ssh_host" value="{{ settings.ssh.host }}" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Port <span class="info" data-tip="SSH port, usually 22.">i</span></label>
              <input class="form-control" type="number" name="ssh_port" value="{{ settings.ssh.port }}" />
            </div>
            <div class="col-md-3">
              <label class="form-label">User <span class="info" data-tip="SSH username for the remote host.">i</span></label>
              <input class="form-control" type="text" name="ssh_user" value="{{ settings.ssh.user }}" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Password <span class="info" data-tip="SSH password (leave blank if using a key).">i</span></label>
              <input class="form-control" type="password" name="ssh_password" value="{{ settings.ssh.password }}" />
            </div>
            <div class="col-md-3">
              <label class="form-label">Use SSH Key <span class="info" data-tip="Enable when authenticating with a private key file.">i</span></label>
              <label class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="ssh_use_key" {% if settings.ssh.use_key %}checked{% endif %} />
                <span class="form-check-label">Enabled</span>
              </label>
            </div>
            <div class="col-md-3">
              <label class="form-label">Key Path <span class="info" data-tip="Path to the private key inside the container.">i</span></label>
              <input class="form-control" type="text" name="ssh_key_path" value="{{ settings.ssh.key_path }}" />
            </div>
            <div class="col-md-12">
              <label class="form-label">Remote CSV Path <span class="info" data-tip="Absolute path to ShapedDevices.csv on the remote host.">i</span></label>
              <input class="form-control" type="text" name="ssh_remote_csv_path" value="{{ settings.ssh.remote_csv_path }}" />
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-body">
          <h4 class="mb-3">Telegram</h4>
          <div class="row g-3">
            <div class="col-md-6">
              <label class="form-label">Bot Token <span class="info" data-tip="Telegram bot token from BotFather.">i</span></label>
              <input class="form-control" type="text" name="telegram_bot_token" value="{{ settings.telegram.bot_token }}" />
            </div>
            <div class="col-md-6">
              <label class="form-label">Chat ID <span class="info" data-tip="Target Telegram chat ID where alerts should be sent.">i</span></label>
              <input class="form-control" type="text" name="telegram_chat_id" value="{{ settings.telegram.chat_id }}" />
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-body">
          <h4 class="mb-3">Ping</h4>
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Count <span class="info" data-tip="How many ping attempts per device.">i</span></label>
              <input class="form-control" type="number" name="ping_count" value="{{ settings.ping.count }}" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Timeout (seconds) <span class="info" data-tip="Timeout per ping attempt.">i</span></label>
              <input class="form-control" type="number" name="per_ping_timeout_sec" value="{{ settings.ping.per_ping_timeout_sec }}" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Max Workers <span class="info" data-tip="Parallel pings during each run.">i</span></label>
              <input class="form-control" type="number" name="max_workers" value="{{ settings.ping.max_workers }}" />
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-body">
          <h4 class="mb-3">Schedule</h4>
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Message Title <span class="info" data-tip="Title shown at the top of each Telegram message.">i</span></label>
              <input class="form-control" type="text" name="message_title" value="{{ settings.general.message_title }}" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Include Header <span class="info" data-tip="Adds a column header row to the message.">i</span></label>
              <label class="form-check form-switch">
                <input class="form-check-input" type="checkbox" name="include_header" {% if settings.general.include_header %}checked{% endif %} />
                <span class="form-check-label">Enabled</span>
              </label>
            </div>
            <div class="col-md-4">
              <label class="form-label">Output Mode <span class="info" data-tip="split sends multiple messages; truncate limits lines; summary_top shows worst offenders.">i</span></label>
              <select class="form-select" name="output_mode">
                {% for option in ['split', 'truncate', 'summary_top'] %}
                  <option value="{{ option }}" {% if settings.general.output_mode == option %}selected{% endif %}>{{ option }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="col-md-4">
              <label class="form-label">Max Characters <span class="info" data-tip="Split or truncate messages beyond this size.">i</span></label>
              <input class="form-control" type="number" name="max_chars" value="{{ settings.general.max_chars }}" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Max Lines <span class="info" data-tip="Maximum lines in truncate mode.">i</span></label>
              <input class="form-control" type="number" name="max_lines" value="{{ settings.general.max_lines }}" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Top N <span class="info" data-tip="Number of devices shown in summary_top mode.">i</span></label>
              <input class="form-control" type="number" name="top_n" value="{{ settings.general.top_n }}" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Schedule Time (HH:MM) <span class="info" data-tip="Daily time to run the RTO check.">i</span></label>
              <input class="form-control" type="text" name="schedule_time_ph" value="{{ settings.general.schedule_time_ph }}" />
            </div>
            <div class="col-md-4">
              <label class="form-label">Timezone <span class="info" data-tip="Timezone for the schedule (example: Asia/Manila).">i</span></label>
              <input class="form-control" type="text" name="timezone" value="{{ settings.general.timezone }}" />
            </div>
          </div>
        </div>
      </div>

      <div class="card mb-3">
        <div class="card-body">
          <h4 class="mb-3">History</h4>
          <div class="row g-3">
            <div class="col-md-4">
              <label class="form-label">Window Size <span class="info" data-tip="Number of recent ping cycles used for RTO calculation.">i</span></label>
              <input class="form-control" type="number" name="window_size" value="{{ settings.history.window_size }}" />
            </div>
          </div>
        </div>
      </div>

      <div class="d-flex gap-2">
        <button type="submit" class="btn btn-primary">Save RTO Settings</button>
      </div>
    </form>
  </div>
  <div class="card-footer">
    <div class="d-flex flex-wrap gap-2">
      <form method="post" action="/settings/rto/test">
        <button type="submit" class="btn">Send Test Telegram</button>
      </form>
      <form method="post" action="/settings/rto/run">
        <button type="submit" class="btn btn-outline-primary">Send Actual Test</button>
      </form>
    </div>
  </div>
</div>
{% endblock %}
