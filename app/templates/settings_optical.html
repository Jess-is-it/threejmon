{% extends "base.html" %}
{% block title %}Optical Monitoring{% endblock %}
{% block header_title %}Optical Monitoring{% endblock %}
{% block header_badge %}
  <span class="badge bg-azure-lt text-azure header-icon-badge"><i class="ti ti-sun"></i></span>
{% endblock %}
{% block content %}
{% if message %}
  {% set msg_lower = message|lower %}
  {% if 'saved' in msg_lower or 'successfully' in msg_lower or 'formatted' in msg_lower %}
    <div class="alert alert-success">
      <div class="d-flex align-items-start">
        <span class="me-2"><i class="ti ti-check"></i></span>
        <div>{{ message }}</div>
      </div>
    </div>
  {% elif 'please confirm' in msg_lower %}
    <div class="alert alert-warning">
      <div class="d-flex align-items-start">
        <span class="me-2"><i class="ti ti-alert-triangle"></i></span>
        <div>{{ message }}</div>
      </div>
    </div>
  {% elif 'failed' in msg_lower or 'error' in msg_lower %}
    <div class="alert alert-danger">
      <div class="d-flex align-items-start">
        <span class="me-2"><i class="ti ti-alert-circle"></i></span>
        <div>{{ message }}</div>
      </div>
    </div>
  {% else %}
    <div class="alert alert-info">
      <div class="d-flex align-items-start">
        <span class="me-2"><i class="ti ti-info-circle"></i></span>
        <div>{{ message }}</div>
      </div>
    </div>
  {% endif %}
{% endif %}

<div class="card">
  <div class="card-body">
    <ul class="nav nav-tabs" data-bs-toggle="tabs">
      <li class="nav-item">
        <a href="#optical-status" class="nav-link {% if active_tab == 'status' %}active{% endif %}" data-bs-toggle="tab">Optical Status</a>
      </li>
      <li class="nav-item">
        <a href="#optical-settings" class="nav-link {% if active_tab != 'status' %}active{% endif %}" data-bs-toggle="tab">Settings</a>
      </li>
    </ul>

    <div class="tab-content pt-4">
	      <div class="tab-pane {% if active_tab == 'status' %}active{% endif %}" id="optical-status">
		        <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-2">
		          <div>
	            <h4 class="mb-1">Optical Status <span class="badge bg-azure-lt" id="optical-status-window">{{ optical_status.window_label }}</span></h4>
	            <div class="text-muted small">
	              Last run: {{ optical_job.last_run_at_ph or 'n/a' }} · Last success: {{ optical_job.last_success_at_ph or 'n/a' }}
	            </div>
	          </div>
		          <div class="d-flex gap-2 align-items-center">
		            <span class="badge bg-blue-lt">Total: {{ optical_status.total }}</span>
		            <span class="badge bg-red-lt">Issues: {{ optical_status.issue_total }}</span>
		            <span class="badge bg-green-lt">Stable: {{ optical_status.stable_total }}</span>
                {% set optical_limit_param = 'all' if optical_status.pagination.limit == 0 else optical_status.pagination.limit %}
                <div class="dropdown">
                  <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" id="optical-limit-button">Show: {{ optical_status.pagination.limit_label }}</button>
                  <div class="dropdown-menu dropdown-menu-end" id="optical-limit-menu">
                    {% for opt in optical_status.pagination.options %}
                      <div class="dropdown-item optical-limit-row" data-limit="{{ opt }}">{{ opt }}</div>
                    {% endfor %}
	                    {# "ALL" removed to keep pages fast #}
	                  </div>
                </div>
		            <div class="dropdown">
	              <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown" id="optical-window-button">Filter</button>
	              <div class="dropdown-menu dropdown-menu-end" id="optical-window-menu">
	                {% for label, hours in optical_window_options %}
	                  <div class="dropdown-item d-flex align-items-center justify-content-between optical-window-row" data-hours="{{ hours }}" data-label="{{ label }}">
                    <span>{{ label }}</span>
                    <button class="btn btn-sm btn-link p-0 optical-window-star-btn" data-hours="{{ hours }}" title="Set default filter">
                      <i class="ti ti-star text-muted"></i>
                    </button>
                  </div>
                {% endfor %}
              </div>
            </div>
          </div>
        </div>

        <div class="alert alert-info">
          <div class="d-flex align-items-start">
            <span class="me-2"><i class="ti ti-info-circle"></i></span>
            <div>
	              Connection issues appear when RX ≤ {{ optical_status.rules.issue_rx_dbm }} dBm, TX ≤ {{ optical_status.rules.issue_tx_dbm }} dBm, or priority RX ≤ {{ optical_status.rules.priority_rx_dbm }} dBm.
	              Stable (green) requires RX ≥ {{ optical_status.rules.stable_rx_dbm }} dBm and TX ≥ {{ optical_status.rules.stable_tx_dbm }} dBm (missing/unrealistic TX is allowed). Non-issue connections below stable show as Monitor (yellow) in the Stable Connections tab.
	            </div>
	          </div>
	        </div>

	        <ul class="nav nav-tabs" data-bs-toggle="tabs">
	          <li class="nav-item">
	            <a href="#optical-issues" class="nav-link active" data-bs-toggle="tab">Connection Issues</a>
	          </li>
	          <li class="nav-item">
	            <a href="#optical-stable" class="nav-link" data-bs-toggle="tab">Stable Connections</a>
	          </li>
          <li class="nav-item ms-auto">
            <div class="px-2 py-2">
              <div class="input-icon">
	                <input class="form-control form-control-sm" id="optical-status-search" type="text" placeholder="Search" autocomplete="off" value="{{ optical_status.query or '' }}" />
                <span class="input-icon-addon">
                  <i class="ti ti-search"></i>
                </span>
              </div>
            </div>
          </li>
        </ul>
        <div class="tab-content pt-3">
		          <div class="tab-pane active" id="optical-issues">
	            <div class="rto-table-shell">
	              <div class="rto-table-wrap" id="optical-issues-table">
	              <table class="table table-vcenter rto-table">
                <thead>
                  <tr>
                    <th class="rto-tip rto-sort" data-sort-key="customer" aria-sort="none" title="Subscriber name detected from GenieACS (PPPoE username or device label)." data-tip="Subscriber name detected from GenieACS (PPPoE username or device label).">Customer <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort-key="ip" aria-sort="none" title="IP address reported by GenieACS." data-tip="IP address reported by GenieACS.">IPv4 <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort-key="status" aria-sort="none" title="Current health classification based on RX/TX thresholds." data-tip="Current health classification based on RX/TX thresholds.">Status <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort-key="rx" aria-sort="none" title="Latest RX power reading in dBm." data-tip="Latest RX power reading in dBm.">RX (dBm) <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort-key="tx" aria-sort="none" title="Latest TX power reading in dBm." data-tip="Latest TX power reading in dBm.">TX (dBm) <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort-key="samples" aria-sort="none" title="Number of samples in the current window." data-tip="Number of samples in the current window.">Samples <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort-key="last_check_at" aria-sort="none" title="Timestamp of the most recent optical reading." data-tip="Timestamp of the most recent optical reading.">Last Check <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-trend-header" title="RX power trend for the current window." data-tip="RX power trend for the current window. Click to expand.">{{ optical_status.window_label }} Trend</th>
                    <th class="rto-tip rto-sort" data-sort-key="reason" aria-sort="none" title="Reason this device is flagged under Connection Issues." data-tip="Reason this device is flagged under Connection Issues.">Reason <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="text-end"> </th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in optical_status.issue_rows %}
                    {% set surv_status = surveillance_index.get(row.name) %}
                    <tr{% if surv_status == 'under' %} class="table-warning"{% elif surv_status == 'level2' %} class="table-danger"{% endif %}>
                      <td>
                        {% if row.device_url %}
                          <a href="{{ row.device_url }}" target="_blank" rel="noopener">{{ row.name }}</a>
                        {% else %}
                          {{ row.name }}
                        {% endif %}
                      </td>
                      <td>{{ row.ip or 'n/a' }}</td>
                      <td>
                        {% if row.status == 'issue' %}
                          <span class="badge bg-red-lt">Issue</span>
                        {% else %}
                          <span class="badge bg-yellow-lt">Monitor</span>
                        {% endif %}
                      </td>
                      <td>
                        {% if row.rx_invalid %}
                          {% set rx_raw = row.rx_raw if row.rx_raw is not none else 'n/a' %}
                          <div class="dropdown">
                            <button type="button" class="btn btn-icon optical-missing-btn" data-bs-toggle="dropdown" aria-label="Missing RX">
                              <i class="ti ti-alert-circle"></i>
                            </button>
                            <div class="dropdown-menu dropdown-menu-end p-2 text-wrap" style="min-width: 240px;">
                              <div class="small text-muted mb-1">Missing/Unrealistic RX</div>
                              <div class="small">{{ row.rx_reason }}</div>
                              <div class="small text-muted mt-1">Raw value: {{ rx_raw }}</div>
                              {% if row.device_url %}
                                <a class="btn btn-sm btn-primary mt-2" target="_blank" rel="noopener" href="{{ row.device_url }}">Open Device</a>
                              {% endif %}
                            </div>
                          </div>
                        {% else %}
                          {{ "%.2f"|format(row.rx) if row.rx is not none else 'n/a' }}
                        {% endif %}
                      </td>
                      <td>
                        {% if row.tx_invalid or row.tx_missing %}
                          {% set tx_raw = row.tx_raw if row.tx_raw is not none else 'n/a' %}
                          <div class="dropdown">
                            <button type="button" class="btn btn-icon optical-missing-btn" data-bs-toggle="dropdown" aria-label="Missing TX">
                              <i class="ti ti-alert-circle"></i>
                            </button>
                            <div class="dropdown-menu dropdown-menu-end p-2 text-wrap" style="min-width: 240px;">
                              <div class="small text-muted mb-1">Missing/Unrealistic TX</div>
                              <div class="small">{{ row.tx_reason }}</div>
                              <div class="small text-muted mt-1">Raw value: {{ tx_raw }}</div>
                              {% if row.device_url %}
                                <a class="btn btn-sm btn-primary mt-2" target="_blank" rel="noopener" href="{{ row.device_url }}">Open Device</a>
                              {% endif %}
                            </div>
                          </div>
                        {% else %}
                          {{ "%.2f"|format(row.tx) if row.tx is not none else 'n/a' }}
                        {% endif %}
                      </td>
                      <td>{{ row.samples }}</td>
                      <td>{{ row.last_check or 'n/a' }}</td>
                      <td>
                        {% if row.spark_points_window %}
                          <button type="button"
                                  class="btn btn-link p-0 optical-spark-btn"
                                  data-name="{{ row.name }}"
                                  data-device-id="{{ row.device_id }}"
                                  data-status="{{ row.status }}"
                                  data-points="{{ row.spark_points_window_large }}"
                                  data-width="640"
                                  data-height="200"
                                  data-bs-toggle="modal"
                                  data-bs-target="#optical-spark-modal">
                            <svg class="rto-sparkline" width="120" height="30" viewBox="0 0 120 30" preserveAspectRatio="none">
                              <polyline points="{{ row.spark_points_window }}" fill="none" stroke="{% if row.status == 'issue' %}#d63939{% else %}#f59f00{% endif %}" stroke-width="2"></polyline>
                            </svg>
                          </button>
                        {% else %}
                          <span class="text-muted small">n/a</span>
                        {% endif %}
                      </td>
                      <td>{{ row.reasons|join(', ') }}</td>
                      <td class="text-end">
                        <span data-surveillance-slot>
                          {% if surv_status == 'under' %}
                            <a class="badge bg-yellow-lt text-yellow header-icon-badge" href="/surveillance?tab=under&focus={{ row.name|urlencode }}" title="Under Surveillance" aria-label="Under Surveillance">
                              <i class="ti ti-eye"></i>
                            </a>
                          {% elif surv_status == 'level2' %}
                            <a class="badge bg-red-lt text-red header-icon-badge" href="/surveillance?tab=level2&focus={{ row.name|urlencode }}" title="LEVEL II SUSPECT" aria-label="LEVEL II SUSPECT">
                              <i class="ti ti-eye"></i>
                            </a>
                          {% else %}
                            <button type="button"
                                    class="badge bg-blue-lt text-blue header-icon-badge border-0 surveillance-add-btn"
                                    title="For Surveillance"
                                    data-pppoe="{{ row.name }}"
                                    data-name="{{ row.name }}"
                                    data-ip="{{ row.ip }}"
                                    data-source="optical">
                              <i class="ti ti-eye"></i>
                            </button>
                          {% endif %}
                        </span>
                      </td>
                    </tr>
                  {% else %}
                    <tr>
                      <td colspan="10" class="text-muted">No connection issues detected yet.</td>
                    </tr>
                  {% endfor %}
                </tbody>
	              </table>
	              </div>
	              <div class="rto-resize-handle" data-target="optical-issues-table"></div>
	            </div>
              {% set meta = optical_status.pagination.issues %}
              <div class="d-flex flex-wrap align-items-center justify-content-between mt-2 gap-2">
                <div class="text-muted small">Showing {{ meta.start }}–{{ meta.end }} of {{ meta.total }}</div>
                {% if meta.pages > 1 %}
                  {% set prev_page = meta.page - 1 if meta.page > 1 else 1 %}
                  {% set next_page = meta.page + 1 if meta.page < meta.pages else meta.pages %}
                  <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Page {{ meta.page }} of {{ meta.pages }}</span>
                    <ul class="pagination pagination-sm mb-0">
                      <li class="page-item {% if not meta.has_prev %}disabled{% endif %}">
	                        <a class="page-link" href="/settings/optical?window={{ optical_status.window_hours }}&limit={{ optical_limit_param }}&issues_page={{ prev_page }}&stable_page={{ optical_status.pagination.stable.page }}&issues_sort={{ optical_status.sort.issues.key }}&issues_dir={{ optical_status.sort.issues.dir }}&stable_sort={{ optical_status.sort.stable.key }}&stable_dir={{ optical_status.sort.stable.dir }}&q={{ optical_status.query|urlencode }}#optical-issues">Prev</a>
                      </li>
                      <li class="page-item {% if not meta.has_next %}disabled{% endif %}">
	                        <a class="page-link" href="/settings/optical?window={{ optical_status.window_hours }}&limit={{ optical_limit_param }}&issues_page={{ next_page }}&stable_page={{ optical_status.pagination.stable.page }}&issues_sort={{ optical_status.sort.issues.key }}&issues_dir={{ optical_status.sort.issues.dir }}&stable_sort={{ optical_status.sort.stable.key }}&stable_dir={{ optical_status.sort.stable.dir }}&q={{ optical_status.query|urlencode }}#optical-issues">Next</a>
                      </li>
                    </ul>
                  </div>
                {% endif %}
              </div>
		          </div>

	          <div class="tab-pane" id="optical-stable">
	            <div class="rto-table-shell">
	              <div class="rto-table-wrap" id="optical-stable-table">
	              <table class="table table-vcenter rto-table">
                <thead>
                  <tr>
                    <th class="rto-tip rto-sort" data-sort-key="customer" aria-sort="none" title="Subscriber name detected from GenieACS (PPPoE username or device label)." data-tip="Subscriber name detected from GenieACS (PPPoE username or device label).">Customer <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort-key="ip" aria-sort="none" title="IP address reported by GenieACS." data-tip="IP address reported by GenieACS.">IPv4 <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort-key="status" aria-sort="none" title="Stable classification based on RX/TX thresholds." data-tip="Stable classification based on RX/TX thresholds.">Status <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort-key="rx" aria-sort="none" title="Latest RX power reading in dBm." data-tip="Latest RX power reading in dBm.">RX (dBm) <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort-key="tx" aria-sort="none" title="Latest TX power reading in dBm." data-tip="Latest TX power reading in dBm.">TX (dBm) <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort-key="samples" aria-sort="none" title="Number of samples in the current window." data-tip="Number of samples in the current window.">Samples <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-sort" data-sort-key="last_check_at" aria-sort="none" title="Timestamp of the most recent optical reading." data-tip="Timestamp of the most recent optical reading.">Last Check <span class="rto-sort-indicator" aria-hidden="true"></span></th>
                    <th class="rto-tip rto-trend-header" title="RX power trend for the current window." data-tip="RX power trend for the current window. Click to expand.">{{ optical_status.window_label }} Trend</th>
                    <th class="text-end"> </th>
                  </tr>
                </thead>
                <tbody>
                  {% for row in optical_status.stable_rows %}
                    {% set surv_status = surveillance_index.get(row.name) %}
                    <tr{% if surv_status == 'under' %} class="table-warning"{% elif surv_status == 'level2' %} class="table-danger"{% endif %}>
                      <td>
                        {% if row.device_url %}
                          <a href="{{ row.device_url }}" target="_blank" rel="noopener">{{ row.name }}</a>
                        {% else %}
                          {{ row.name }}
                        {% endif %}
	                      </td>
	                      <td>{{ row.ip or 'n/a' }}</td>
	                      <td>
	                        {% if row.status == 'stable' %}
	                          <span class="badge bg-green-lt">Stable</span>
	                        {% else %}
	                          <span class="badge bg-yellow-lt">Monitor</span>
	                        {% endif %}
	                      </td>
                      <td>
                        {% if row.rx_invalid %}
                          {% set rx_raw = row.rx_raw if row.rx_raw is not none else 'n/a' %}
                          <div class="dropdown">
                            <button type="button" class="btn btn-icon optical-missing-btn" data-bs-toggle="dropdown" aria-label="Missing RX">
                              <i class="ti ti-alert-circle"></i>
                            </button>
                            <div class="dropdown-menu dropdown-menu-end p-2 text-wrap" style="min-width: 240px;">
                              <div class="small text-muted mb-1">Missing/Unrealistic RX</div>
                              <div class="small">{{ row.rx_reason }}</div>
                              <div class="small text-muted mt-1">Raw value: {{ rx_raw }}</div>
                              {% if row.device_url %}
                                <a class="btn btn-sm btn-primary mt-2" target="_blank" rel="noopener" href="{{ row.device_url }}">Open Device</a>
                              {% endif %}
                            </div>
                          </div>
                        {% else %}
                          {{ "%.2f"|format(row.rx) if row.rx is not none else 'n/a' }}
                        {% endif %}
                      </td>
                      <td>
                        {% if row.tx_invalid or row.tx_missing %}
                          {% set tx_raw = row.tx_raw if row.tx_raw is not none else 'n/a' %}
                          <div class="dropdown">
                            <button type="button" class="btn btn-icon optical-missing-btn" data-bs-toggle="dropdown" aria-label="Missing TX">
                              <i class="ti ti-alert-circle"></i>
                            </button>
                            <div class="dropdown-menu dropdown-menu-end p-2 text-wrap" style="min-width: 240px;">
                              <div class="small text-muted mb-1">Missing/Unrealistic TX</div>
                              <div class="small">{{ row.tx_reason }}</div>
                              <div class="small text-muted mt-1">Raw value: {{ tx_raw }}</div>
                              {% if row.device_url %}
                                <a class="btn btn-sm btn-primary mt-2" target="_blank" rel="noopener" href="{{ row.device_url }}">Open Device</a>
                              {% endif %}
                            </div>
                          </div>
                        {% else %}
                          {{ "%.2f"|format(row.tx) if row.tx is not none else 'n/a' }}
                        {% endif %}
                      </td>
                      <td>{{ row.samples }}</td>
                      <td>{{ row.last_check or 'n/a' }}</td>
	                      <td>
	                        {% if row.spark_points_window %}
	                          <button type="button"
	                                  class="btn btn-link p-0 optical-spark-btn"
	                                  data-name="{{ row.name }}"
	                                  data-device-id="{{ row.device_id }}"
	                                  data-status="{{ row.status }}"
	                                  data-points="{{ row.spark_points_window_large }}"
	                                  data-width="640"
	                                  data-height="200"
	                                  data-bs-toggle="modal"
	                                  data-bs-target="#optical-spark-modal">
	                            <svg class="rto-sparkline" width="120" height="30" viewBox="0 0 120 30" preserveAspectRatio="none">
	                              <polyline points="{{ row.spark_points_window }}" fill="none" stroke="{% if row.status == 'stable' %}#2fb344{% else %}#f59f00{% endif %}" stroke-width="2"></polyline>
	                            </svg>
	                          </button>
	                        {% else %}
	                          <span class="text-muted small">n/a</span>
	                        {% endif %}
	                      </td>
                      <td class="text-end">
                        <span data-surveillance-slot>
                          {% if surv_status == 'under' %}
                            <a class="badge bg-yellow-lt text-yellow header-icon-badge" href="/surveillance?tab=under&focus={{ row.name|urlencode }}" title="Under Surveillance" aria-label="Under Surveillance">
                              <i class="ti ti-eye"></i>
                            </a>
                          {% elif surv_status == 'level2' %}
                            <a class="badge bg-red-lt text-red header-icon-badge" href="/surveillance?tab=level2&focus={{ row.name|urlencode }}" title="LEVEL II SUSPECT" aria-label="LEVEL II SUSPECT">
                              <i class="ti ti-eye"></i>
                            </a>
                          {% else %}
                            <button type="button"
                                    class="badge bg-blue-lt text-blue header-icon-badge border-0 surveillance-add-btn"
                                    title="For Surveillance"
                                    data-pppoe="{{ row.name }}"
                                    data-name="{{ row.name }}"
                                    data-ip="{{ row.ip }}"
                                    data-source="optical">
                              <i class="ti ti-eye"></i>
                            </button>
                          {% endif %}
                        </span>
                      </td>
                    </tr>
                  {% else %}
                    <tr>
                      <td colspan="9" class="text-muted">No stable connections listed yet.</td>
                    </tr>
                  {% endfor %}
                </tbody>
	              </table>
	              </div>
	              <div class="rto-resize-handle" data-target="optical-stable-table"></div>
	            </div>
              {% set meta = optical_status.pagination.stable %}
              <div class="d-flex flex-wrap align-items-center justify-content-between mt-2 gap-2">
                <div class="text-muted small">Showing {{ meta.start }}–{{ meta.end }} of {{ meta.total }}</div>
                {% if meta.pages > 1 %}
                  {% set prev_page = meta.page - 1 if meta.page > 1 else 1 %}
                  {% set next_page = meta.page + 1 if meta.page < meta.pages else meta.pages %}
                  <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">Page {{ meta.page }} of {{ meta.pages }}</span>
                    <ul class="pagination pagination-sm mb-0">
                      <li class="page-item {% if not meta.has_prev %}disabled{% endif %}">
	                        <a class="page-link" href="/settings/optical?window={{ optical_status.window_hours }}&limit={{ optical_limit_param }}&issues_page={{ optical_status.pagination.issues.page }}&stable_page={{ prev_page }}&issues_sort={{ optical_status.sort.issues.key }}&issues_dir={{ optical_status.sort.issues.dir }}&stable_sort={{ optical_status.sort.stable.key }}&stable_dir={{ optical_status.sort.stable.dir }}&q={{ optical_status.query|urlencode }}#optical-stable">Prev</a>
                      </li>
                      <li class="page-item {% if not meta.has_next %}disabled{% endif %}">
	                        <a class="page-link" href="/settings/optical?window={{ optical_status.window_hours }}&limit={{ optical_limit_param }}&issues_page={{ optical_status.pagination.issues.page }}&stable_page={{ next_page }}&issues_sort={{ optical_status.sort.issues.key }}&issues_dir={{ optical_status.sort.issues.dir }}&stable_sort={{ optical_status.sort.stable.key }}&stable_dir={{ optical_status.sort.stable.dir }}&q={{ optical_status.query|urlencode }}#optical-stable">Next</a>
                      </li>
                    </ul>
                  </div>
                {% endif %}
              </div>
	          </div>
	        </div>
	      </div>

      <div class="tab-pane {% if active_tab != 'status' %}active{% endif %}" id="optical-settings">
        <form method="post">
          <input type="hidden" name="active_tab" value="settings" />
          <input type="hidden" name="settings_tab" id="optical-settings-tab" value="{{ settings_tab or 'general' }}" />

          <div class="d-flex flex-wrap align-items-center justify-content-between mb-2 gap-2">
            <h4 class="mb-0">Optical Settings</h4>
            <span class="text-muted small">Configure GenieACS sources, thresholds, notifications, and storage.</span>
          </div>

          <ul class="nav nav-tabs" data-bs-toggle="tabs">
            <li class="nav-item">
              <a href="#optical-general" class="nav-link {% if settings_tab == 'general' %}active{% endif %}" data-bs-toggle="tab">General</a>
            </li>
            <li class="nav-item">
              <a href="#optical-data" class="nav-link {% if settings_tab == 'data' %}active{% endif %}" data-bs-toggle="tab">Data Source</a>
            </li>
            <li class="nav-item">
              <a href="#optical-notifications" class="nav-link {% if settings_tab == 'notifications' %}active{% endif %}" data-bs-toggle="tab">Telegram</a>
            </li>
            <li class="nav-item">
              <a href="#optical-thresholds" class="nav-link {% if settings_tab == 'thresholds' %}active{% endif %}" data-bs-toggle="tab">Alerts</a>
            </li>
            <li class="nav-item">
              <a href="#optical-classification" class="nav-link {% if settings_tab == 'classification' %}active{% endif %}" data-bs-toggle="tab">Classification</a>
            </li>
            <li class="nav-item">
              <a href="#optical-storage" class="nav-link {% if settings_tab == 'storage' %}active{% endif %}" data-bs-toggle="tab">Storage</a>
            </li>
            <li class="nav-item">
              <a href="#optical-danger" class="nav-link {% if settings_tab == 'danger' %}active{% endif %}" data-bs-toggle="tab">Danger</a>
            </li>
          </ul>

          <div class="tab-content pt-4">
            <div class="tab-pane {% if settings_tab == 'general' %}active{% endif %}" id="optical-general">
              <div class="card mb-3">
                <div class="card-body">
                  <div class="alert alert-info">
                    <div class="d-flex align-items-start">
                      <span class="me-2"><i class="ti ti-info-circle"></i></span>
                      <div>Optical checks run on the interval below for status history. Telegram alerts follow the schedule in the Telegram tab.</div>
                    </div>
                  </div>
	                  <label class="form-label">Enable Optical Monitoring <span class="info" data-tip="Turns on the optical monitoring job.">i</span></label>
                  <label class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" name="enabled" {% if settings.enabled %}checked{% endif %} />
                    <span class="form-check-label">Active</span>
                  </label>
                  <div class="row g-3 mt-2">
                    <div class="col-md-4">
                      <label class="form-label">Check Interval (minutes) <span class="info" data-tip="How often optical readings are collected for the status tables.">i</span></label>
                      <input class="form-control" type="number" name="check_interval_minutes" value="{{ settings.general.check_interval_minutes }}" />
                    </div>
                  </div>
                </div>
              </div>
              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary" name="settings_tab" value="general">Save Optical Settings</button>
              </div>
            </div>

            <div class="tab-pane {% if settings_tab == 'data' %}active{% endif %}" id="optical-data">
              <div class="card mb-3">
                <div class="card-body">
                  <h4 class="mb-3">GenieACS</h4>
	                  <div class="row g-3">
	                    <div class="col-md-6">
	                      <label class="form-label">Base URL <span class="info" data-tip="GenieACS server base address (example: http://genieacs:7557)."><i class="ti ti-info-circle"></i></span></label>
	                      <input class="form-control" type="text" name="genieacs_base_url" value="{{ settings.genieacs.base_url }}" />
	                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Username <span class="info" data-tip="GenieACS API username used for authentication."><i class="ti ti-info-circle"></i></span></label>
                      <input class="form-control" type="text" name="genieacs_username" value="{{ settings.genieacs.username }}" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Password <span class="info" data-tip="GenieACS API password used for authentication."><i class="ti ti-info-circle"></i></span></label>
                      <input class="form-control" type="password" name="genieacs_password" value="{{ settings.genieacs.password }}" />
                    </div>
	                    <div class="col-md-6">
	                      <label class="form-label">Page Size <span class="info" data-tip="How many devices per GenieACS page request."><i class="ti ti-info-circle"></i></span></label>
	                      <input class="form-control" type="number" name="genieacs_page_size" value="{{ settings.genieacs.page_size }}" />
	                    </div>
	                  </div>
	                  <div class="d-flex gap-2 mt-3">
	                    <a class="btn btn-secondary" href="/settings/optical/test_genieacs">Test GenieACS API</a>
	                  </div>
	                </div>
	              </div>

              <div class="card mb-3">
                <div class="card-body">
                  <h4 class="mb-3">Signal Paths</h4>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">RX Paths <span class="info" data-tip="GenieACS parameter paths for RX power. One per line.">i</span></label>
                      <textarea class="form-control" name="rx_paths" rows="5">{{ settings.optical.rx_paths | join('\n') }}</textarea>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">TX Paths <span class="info" data-tip="GenieACS parameter paths for TX power. One per line.">i</span></label>
                      <textarea class="form-control" name="tx_paths" rows="5">{{ settings.optical.tx_paths | join('\n') }}</textarea>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">PPPoE Paths <span class="info" data-tip="Paths used to locate the subscriber username.">i</span></label>
                      <textarea class="form-control" name="pppoe_paths" rows="5">{{ settings.optical.pppoe_paths | join('\n') }}</textarea>
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">IP Paths <span class="info" data-tip="Paths used to locate the subscriber IP address.">i</span></label>
                      <textarea class="form-control" name="ip_paths" rows="5">{{ settings.optical.ip_paths | join('\n') }}</textarea>
                    </div>
                  </div>
                </div>
              </div>
              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary" name="settings_tab" value="data">Save Data Source Settings</button>
              </div>
            </div>

            <div class="tab-pane {% if settings_tab == 'notifications' %}active{% endif %}" id="optical-notifications">
              <div class="card mb-3">
                <div class="card-body">
                  <h4 class="mb-3">Telegram Alerts</h4>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Bot Token <span class="info" data-tip="Telegram bot token from BotFather.">i</span></label>
                      <input class="form-control" type="text" name="telegram_bot_token" value="{{ settings.telegram.bot_token }}" />
                    </div>
                    <div class="col-md-6">
                      <label class="form-label">Chat ID <span class="info" data-tip="Target Telegram chat ID where alerts should be sent.">i</span></label>
                      <input class="form-control" type="text" name="telegram_chat_id" value="{{ settings.telegram.chat_id }}" />
                    </div>
                  </div>
                  <div class="row g-3 mt-1">
                    <div class="col-md-4">
                      <label class="form-label">Send Time (HH:MM) <span class="info" data-tip="Daily time to send Telegram alerts (Asia/Manila).">i</span></label>
                      <input class="form-control" type="text" name="schedule_time_ph" value="{{ settings.general.schedule_time_ph }}" />
                    </div>
                  </div>
                </div>
              </div>

              <div class="card mb-3">
                <div class="card-body">
                  <h4 class="mb-3">Message Format</h4>
                  <div class="row g-3">
                    <div class="col-md-6">
                      <label class="form-label">Message Title <span class="info" data-tip="Title shown at the top of each Telegram message.">i</span></label>
                      <input class="form-control" type="text" name="message_title" value="{{ settings.general.message_title }}" />
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Include Header <span class="info" data-tip="Adds a column header row to the message.">i</span></label>
                      <label class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="include_header" {% if settings.general.include_header %}checked{% endif %} />
                        <span class="form-check-label">Enabled</span>
                      </label>
                    </div>
                    <div class="col-md-3">
                      <label class="form-label">Max Characters <span class="info" data-tip="Split messages when they exceed this length.">i</span></label>
                      <input class="form-control" type="number" name="max_chars" value="{{ settings.general.max_chars }}" />
                    </div>
                  </div>
                </div>
              </div>
              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary" name="settings_tab" value="notifications">Save Telegram Settings</button>
              </div>
            </div>

            <div class="tab-pane {% if settings_tab == 'thresholds' %}active{% endif %}" id="optical-thresholds">
              <div class="card mb-3">
                <div class="card-body">
                  <h4 class="mb-3">Alert Thresholds</h4>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">RX Threshold (dBm) <span class="info" data-tip="Alert if RX power is below this value.">i</span></label>
                      <input class="form-control" type="number" step="0.1" name="rx_threshold_dbm" value="{{ settings.optical.rx_threshold_dbm }}" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">TX Low Threshold (dBm) <span class="info" data-tip="Alert if TX power is below this value.">i</span></label>
                      <input class="form-control" type="number" step="0.1" name="tx_low_threshold_dbm" value="{{ settings.optical.tx_low_threshold_dbm }}" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Priority RX Threshold (dBm) <span class="info" data-tip="RX power below this becomes priority in alerts.">i</span></label>
                      <input class="form-control" type="number" step="0.1" name="priority_rx_threshold_dbm" value="{{ settings.optical.priority_rx_threshold_dbm }}" />
                    </div>
                  </div>
                </div>
              </div>
              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary" name="settings_tab" value="thresholds">Save Alerts Settings</button>
              </div>
            </div>

            <div class="tab-pane {% if settings_tab == 'classification' %}active{% endif %}" id="optical-classification">
              <div class="card mb-3">
                <div class="card-body">
                  <h4 class="mb-3">Classification Rules</h4>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">Issue RX (dBm) <span class="info" data-tip="Flag connection issues when RX is at or below this value.">i</span></label>
                      <input class="form-control" type="number" step="0.1" name="optical_issue_rx_dbm" value="{{ settings.classification.issue_rx_dbm }}" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Issue TX (dBm) <span class="info" data-tip="Flag connection issues when TX is at or below this value.">i</span></label>
                      <input class="form-control" type="number" step="0.1" name="optical_issue_tx_dbm" value="{{ settings.classification.issue_tx_dbm }}" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Stable RX (dBm) <span class="info" data-tip="Stable connections must be at or above this RX value.">i</span></label>
                      <input class="form-control" type="number" step="0.1" name="optical_stable_rx_dbm" value="{{ settings.classification.stable_rx_dbm }}" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Stable TX (dBm) <span class="info" data-tip="Stable connections must be at or above this TX value.">i</span></label>
                      <input class="form-control" type="number" step="0.1" name="optical_stable_tx_dbm" value="{{ settings.classification.stable_tx_dbm }}" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Chart Min (dBm) <span class="info" data-tip="Lower bound for RX trend charts.">i</span></label>
                      <input class="form-control" type="number" step="0.1" name="optical_chart_min_dbm" value="{{ settings.classification.chart_min_dbm }}" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Chart Max (dBm) <span class="info" data-tip="Upper bound for RX trend charts.">i</span></label>
                      <input class="form-control" type="number" step="0.1" name="optical_chart_max_dbm" value="{{ settings.classification.chart_max_dbm }}" />
                    </div>
                  </div>
                </div>
              </div>
              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary" name="settings_tab" value="classification">Save Classification Settings</button>
              </div>
            </div>

            <div class="tab-pane {% if settings_tab == 'storage' %}active{% endif %}" id="optical-storage">
              <div class="card mb-3">
                <div class="card-body">
                  <h4 class="mb-3">Storage</h4>
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">Raw Retention Days <span class="info" data-tip="Delete optical history older than this many days.">i</span></label>
                      <input class="form-control" type="number" name="optical_raw_retention_days" value="{{ settings.storage.raw_retention_days }}" />
                    </div>
                  </div>
                </div>
              </div>
              <div class="d-flex gap-2">
                <button type="submit" class="btn btn-primary" name="settings_tab" value="storage">Save Storage Settings</button>
              </div>
            </div>

            <div class="tab-pane {% if settings_tab == 'danger' %}active{% endif %}" id="optical-danger">
              <div class="card mb-3 border-danger">
                <div class="card-body">
                  <h4 class="text-danger mb-3">Format Optical Database</h4>
                  <div class="alert alert-warning">
                    Formatting clears all stored optical history. Settings will be preserved.
                  </div>
                  <div class="d-flex align-items-center gap-3">
                    <label class="form-check">
                      <input class="form-check-input" type="checkbox" name="confirm_format" form="optical-format-form" />
                      <span class="form-check-label">Confirm format</span>
                    </label>
                    <button type="submit" class="btn btn-danger" form="optical-format-form">Format Optical Database</button>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </form>
        <form id="optical-format-form" method="post" action="/settings/optical/format?window={{ optical_status.window_hours }}"></form>
      </div>
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="optical-spark-modal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="optical-spark-title">Optical Trend</h5>
        <div class="dropdown ms-auto">
          <button class="btn btn-sm btn-outline-secondary dropdown-toggle" data-bs-toggle="dropdown" id="optical-modal-window-button">Filter</button>
          <div class="dropdown-menu dropdown-menu-end" id="optical-modal-window-menu">
            {% for label, hours in optical_window_options %}
              <button class="dropdown-item optical-modal-window-option" data-hours="{{ hours }}" data-label="{{ label }}">{{ label }}</button>
            {% endfor %}
          </div>
        </div>
        <button type="button" class="btn-close ms-2" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div id="optical-spark-modal-chart" class="rto-spark-modal-chart"></div>
        <div class="text-muted small mt-2">RX/TX history for the selected window.</div>
      </div>
    </div>
  </div>
</div>

<script>
	  document.addEventListener("DOMContentLoaded", () => {
    const tabLinks = document.querySelectorAll('a[data-bs-toggle="tab"]');
    const tabKey = "optical_status_active_tab";
    const storedTab = localStorage.getItem(tabKey);
    if (window.location.hash) {
      const target = document.querySelector(`a[href="${window.location.hash}"]`);
      if (target && window.bootstrap?.Tab) {
        new window.bootstrap.Tab(target).show();
      }
    } else if (storedTab) {
      const target = document.querySelector(`a[href="${storedTab}"]`);
      if (target && window.bootstrap?.Tab) {
        new window.bootstrap.Tab(target).show();
      }
    }
    tabLinks.forEach((link) => {
      link.addEventListener("shown.bs.tab", (event) => {
        const href = event.target.getAttribute("href");
        if (href) {
          localStorage.setItem(tabKey, href);
          history.replaceState(null, "", href);
        }
      });
    });

	    const windowBadge = document.getElementById("optical-status-window");
	    const windowButton = document.getElementById("optical-window-button");
	    const windowOptions = document.querySelectorAll(".optical-window-row");
	    const windowStars = document.querySelectorAll(".optical-window-star-btn");
      const limitButton = document.getElementById("optical-limit-button");
      const limitRows = document.querySelectorAll(".optical-limit-row");
		    const windowParam = new URLSearchParams(window.location.search).get("window");
		    let defaultWindow = localStorage.getItem("optical_status_default_window");
		    if (!defaultWindow) {
		      defaultWindow = "24";
	      localStorage.setItem("optical_status_default_window", defaultWindow);
	    }
	    const currentWindow = windowParam || "24";
	    const updateStars = () => {
	      windowStars.forEach((btn) => {
	        const icon = btn.querySelector("i");
        if (!icon) return;
        if (btn.dataset.hours === defaultWindow) {
          icon.classList.remove("ti-star");
          icon.classList.add("ti-star-filled", "text-warning");
        } else {
          icon.classList.remove("ti-star-filled", "text-warning");
          icon.classList.add("ti-star");
        }
      });
    };
	    const updateButtonLabel = () => {
	      const label = windowBadge ? windowBadge.textContent.trim() : "1D";
	      const isDefault = Boolean(windowParam) && currentWindow === defaultWindow;
	      if (windowButton) {
	        windowButton.textContent = isDefault ? `Filter: ${label} ⭐` : `Filter: ${label}`;
	      }
      document.querySelectorAll(".rto-trend-header").forEach((el) => {
        el.textContent = `${label} Trend`;
      });
    };
    updateStars();
    updateButtonLabel();
		    windowOptions.forEach((row) => {
		      row.addEventListener("click", () => {
		        currentWindow = row.dataset.hours;
		        updateStars();
		        updateButtonLabel();
		        const url = new URL(window.location.href);
		        url.searchParams.set("window", currentWindow);
            url.searchParams.set("issues_page", "1");
            url.searchParams.set("stable_page", "1");
		        const tabHash = localStorage.getItem(tabKey) || window.location.hash;
		        if (tabHash) {
		          url.hash = tabHash;
		        }
		        window.location.href = url.toString();
		      });
		    });
	    windowStars.forEach((btn) => {
	      btn.addEventListener("click", (event) => {
	        event.preventDefault();
	        event.stopPropagation();
	        defaultWindow = btn.dataset.hours;
	        localStorage.setItem("optical_status_default_window", defaultWindow);
	        updateStars();
	        updateButtonLabel();
	      });
	    });

      limitRows.forEach((row) => {
        row.addEventListener("click", () => {
          const limit = row.dataset.limit || "50";
          const url = new URL(window.location.href);
          url.searchParams.set("limit", limit);
          url.searchParams.set("issues_page", "1");
          url.searchParams.set("stable_page", "1");
          const tabHash = localStorage.getItem(tabKey) || window.location.hash;
          if (tabHash) {
            url.hash = tabHash;
          }
          window.location.href = url.toString();
        });
      });

      const setupServerSort = (wrapId, prefix, hash) => {
        const wrap = document.getElementById(wrapId);
        const table = wrap ? wrap.querySelector("table") : null;
        if (!table) return;
        const headers = Array.from(table.querySelectorAll("th.rto-sort"));
        if (!headers.length) return;
        const url = new URL(window.location.href);
        const activeKey = (url.searchParams.get(`${prefix}_sort`) || "").trim();
        const activeDir = ((url.searchParams.get(`${prefix}_dir`) || "desc").trim().toLowerCase() === "asc") ? "asc" : "desc";
        headers.forEach((th) => {
          const key = (th.dataset.sortKey || "").trim();
          const indicator = th.querySelector(".rto-sort-indicator");
          th.classList.remove("rto-sorted-asc", "rto-sorted-desc");
          th.setAttribute("aria-sort", "none");
          if (indicator) indicator.textContent = "";
          if (key && key === activeKey) {
            th.classList.add(activeDir === "asc" ? "rto-sorted-asc" : "rto-sorted-desc");
            th.setAttribute("aria-sort", activeDir === "asc" ? "ascending" : "descending");
            if (indicator) indicator.textContent = activeDir === "asc" ? "▲" : "▼";
          }
        });
        table.addEventListener("click", (event) => {
          const header = event.target.closest("th.rto-sort");
          if (!header || !table.contains(header)) return;
          const sortKey = (header.dataset.sortKey || "").trim();
          if (!sortKey) return;
          const nextDir = (sortKey === activeKey && activeDir === "asc") ? "desc" : "asc";
          const nextUrl = new URL(window.location.href);
          nextUrl.searchParams.set(`${prefix}_sort`, sortKey);
          nextUrl.searchParams.set(`${prefix}_dir`, nextDir);
          nextUrl.searchParams.set(`${prefix}_page`, "1");
          nextUrl.hash = hash;
          window.location.href = nextUrl.toString();
        });
      };

      setupServerSort("optical-issues-table", "issues", "#optical-issues");
      setupServerSort("optical-stable-table", "stable", "#optical-stable");

		    const opticalSearch = document.getElementById("optical-status-search");
		    if (opticalSearch) {
          let lastValue = (opticalSearch.value || "").trim();
          let timer = null;
		      const submit = () => {
            const q = (opticalSearch.value || "").trim();
            if (q === lastValue) return;
            lastValue = q;
            if (q && q.length < 2) return;
            const url = new URL(window.location.href);
            if (q) url.searchParams.set("q", q);
            else url.searchParams.delete("q");
            url.searchParams.set("issues_page", "1");
            url.searchParams.set("stable_page", "1");
            const tabHash = localStorage.getItem(tabKey) || window.location.hash;
            if (tabHash) url.hash = tabHash;
            window.location.href = url.toString();
		      };
          opticalSearch.addEventListener("input", () => {
            if (timer) clearTimeout(timer);
            timer = setTimeout(submit, 350);
          });
          opticalSearch.addEventListener("keydown", (event) => {
            if (event.key === "Enter") {
              event.preventDefault();
              if (timer) clearTimeout(timer);
              submit();
            }
          });
		    }

	    const modalTitle = document.getElementById("optical-spark-title");
    const modalChart = document.getElementById("optical-spark-modal-chart");
	    const modalWindowButton = document.getElementById("optical-modal-window-button");
	    const modalWindowOptions = document.querySelectorAll(".optical-modal-window-option");
	    let modalChartInstance = null;
	    let modalTooltipCleanup = null;
	    const modalEl = document.getElementById("optical-spark-modal");
	    let modalDeviceId = "";
	    let modalStatus = "stable";
	    let modalName = "Optical";
	    let modalHours = 24;
	    if (modalEl && modalEl.parentElement !== document.body) {
	      document.body.appendChild(modalEl);
	    }
	    const chartMin = {{ optical_status.chart.min_dbm }};
	    const chartMax = {{ optical_status.chart.max_dbm }};
	    const txRealisticMin = {{ settings.get("classification", {}).get("tx_realistic_min_dbm", -10.0) }};
	    const txRealisticMax = {{ settings.get("classification", {}).get("tx_realistic_max_dbm", 10.0) }};

	    const renderModalWhenVisible = () => {
	      if (!modalDeviceId) return;
	      const doRender = () => renderModalChart(modalName, modalDeviceId, modalStatus, modalHours);
	      if (modalEl && modalEl.classList.contains("show")) {
	        doRender();
	        return;
	      }
	      if (modalEl) {
	        modalEl.addEventListener("shown.bs.modal", doRender, { once: true });
	        return;
	      }
	      doRender();
	    };

	    const renderModalChart = async (name, deviceId, status, hours) => {
	      const colorMap = { stable: "#2fb344", issue: "#d63939", monitor: "#f59f00" };
	      const stroke = colorMap[status] || "#2fb344";
	      const label = hours >= 24 ? `${Math.floor(hours / 24)}D` : `${hours}H`;
      modalTitle.textContent = `${name} · ${label} Trend`;
      if (modalWindowButton) {
        modalWindowButton.textContent = `Filter: ${label}`;
      }
	      if (modalChartInstance) {
	        modalChartInstance.destroy();
	        modalChartInstance = null;
	      }
	      if (modalTooltipCleanup) {
	        modalTooltipCleanup();
	        modalTooltipCleanup = null;
	      }
	      modalChart.innerHTML = "<div class='text-muted'>Loading chart...</div>";
	      try {
	        const params = new URLSearchParams({ device_id: deviceId, window: String(hours) });
	        const res = await fetch(`/optical/series?${params.toString()}`, { headers: { "Accept": "application/json" } });
        if (!res.ok) {
          modalChart.innerHTML = "<div class='text-muted'>No data available.</div>";
          return;
        }
	        const payload = await res.json();
	        const toNumberOrNull = (value) => {
	          if (value === null || value === undefined) return null;
	          const parsed = Number(value);
	          return Number.isFinite(parsed) ? parsed : null;
	        };
	        const points = (payload.series || [])
	          .map((item) => {
	            const ts = item.ts ?? item.timestamp ?? null;
	            const parsedTs = ts ? Date.parse(String(ts)) : NaN;
	            if (!Number.isFinite(parsedTs)) return null;
	            const txRaw = toNumberOrNull(item.tx);
	            const txPlot =
	              txRaw === null || txRaw === undefined
	                ? null
	                : Number(txRaw) < txRealisticMin || Number(txRaw) > txRealisticMax
	                  ? null
	                  : txRaw;
	            return {
	              x: parsedTs,
	              rx: toNumberOrNull(item.rx),
	              tx: txPlot,
	              tx_raw: txRaw,
	            };
	          })
	          .filter((item) => item !== null);
	        if (!points.length) {
	          modalChart.innerHTML = "<div class='text-muted'>No data available.</div>";
	          return;
	        }
	        const rxSeries = points.map((item) => ({ x: item.x, y: item.rx }));
	        const txSeries = points.map((item) => ({ x: item.x, y: item.tx }));
	        modalChart.innerHTML = "";
	        const formatTime = (value) => {
	          const dt = new Date(value);
	          if (Number.isNaN(dt.getTime())) return "";
	          return dt.toLocaleTimeString("en-US", { hour: "2-digit", minute: "2-digit" });
	        };
	        const formatDate = (value) => {
	          const dt = new Date(value);
	          if (Number.isNaN(dt.getTime())) return "";
	          return dt.toLocaleDateString("en-US", { month: "short", day: "2-digit" });
	        };
	        const formatDbm = (value) => {
	          if (value === null || value === undefined || Number.isNaN(Number(value))) return "n/a";
	          return `${Number(value).toFixed(2)} dBm`;
	        };
	        const formatDbmTooltip = (value) => {
	          if (value === null || value === undefined || Number.isNaN(Number(value))) return "n/a";
	          return `${Number(value).toFixed(1)} dBm`;
	        };
	        modalChartInstance = new window.ApexCharts(modalChart, {
	          chart: {
	            type: "line",
	            height: 260,
	            toolbar: { show: false },
	            animations: { enabled: false },
	            zoom: { enabled: false },
	          },
	          colors: [stroke, "#206bc4"],
	          series: [
	            { name: "RX (dBm)", data: rxSeries },
	            { name: "TX (dBm)", data: txSeries },
	          ],
	          stroke: { width: 2 },
	          markers: { size: 0, hover: { size: 4 } },
	          xaxis: {
	            type: "datetime",
	            labels: { formatter: formatTime },
	            tooltip: { enabled: false },
	          },
	          yaxis: {
	            min: chartMin,
	            max: chartMax,
	            tickAmount: 5,
	            labels: { formatter: (value) => `${value.toFixed(1)} dBm` },
	          },
		          tooltip: {
		            shared: true,
		            intersect: false,
		            followCursor: true,
		            x: { formatter: (value) => `${formatDate(value)} ${formatTime(value)}` },
		            y: {
		              formatter: (value, { seriesIndex, dataPointIndex }) => {
		                const point = points?.[dataPointIndex] || null;
		                if (!point) {
		                  return value === null || value === undefined || Number.isNaN(Number(value)) ? "n/a" : formatDbmTooltip(value);
		                }
		                if (seriesIndex === 1) {
		                  const txValue = point.tx_raw;
		                  if (txValue === null || txValue === undefined || Number.isNaN(Number(txValue))) return "Missing";
		                  if (Number(txValue) < txRealisticMin || Number(txValue) > txRealisticMax) {
		                    return `${formatDbmTooltip(txValue)} (unrealistic)`;
		                  }
		                  return formatDbmTooltip(txValue);
		                }
		                const rxValue = point.rx;
		                return rxValue === null || rxValue === undefined ? "n/a" : formatDbmTooltip(rxValue);
		              },
		            },
		          },
	          legend: { position: "top" },
	          grid: { borderColor: "#e9ecef" },
	        });
	        modalChartInstance.render();
	        window.dispatchEvent(new Event("resize"));
	        setTimeout(() => window.dispatchEvent(new Event("resize")), 50);
	        modalTooltipCleanup = null;
	      } catch (err) {
	        modalChart.innerHTML = "<div class='text-muted'>No data available.</div>";
	      }
	    };

	    document.querySelectorAll(".optical-spark-btn").forEach((btn) => {
	      btn.addEventListener("click", () => {
	        modalDeviceId = btn.dataset.deviceId || "";
	        modalStatus = btn.dataset.status || "stable";
	        modalName = btn.dataset.name || "Optical";
	        modalHours = Number(currentWindow || "24");
	        renderModalWhenVisible();
	      });
	    });

    modalWindowOptions.forEach((btn) => {
      btn.addEventListener("click", () => {
        const hours = Number(btn.dataset.hours || "24");
        if (!modalDeviceId) return;
        renderModalChart(modalTitle.textContent.split(" · ")[0], modalDeviceId, modalStatus, hours);
      });
    });



    const settingsInput = document.getElementById("optical-settings-tab");
    if (settingsInput) {
      const settingsTabs = document.querySelectorAll('#optical-settings [data-bs-toggle="tabs"] .nav-link');
      settingsTabs.forEach((tab) => {
        tab.addEventListener("shown.bs.tab", (event) => {
          const target = event.target.getAttribute("href");
          if (target && target.startsWith("#optical-")) {
            settingsInput.value = target.replace("#optical-", "");
          }
        });
      });
    }

	    const wraps = document.querySelectorAll(".rto-table-wrap");
	    wraps.forEach((wrap) => {
	      const stored = localStorage.getItem(`optical_${wrap.id}_height`);
	      if (stored) {
	        wrap.style.height = `${stored}px`;
	      }
	    });
	    const handles = document.querySelectorAll(".rto-resize-handle");
	    handles.forEach((handle) => {
	      let startY = 0;
	      let startHeight = 0;
	      const targetId = handle.dataset.target;
	      const target = targetId ? document.getElementById(targetId) : null;
	      if (!target) return;
	      const onMouseMove = (event) => {
	        const delta = event.clientY - startY;
	        const height = Math.max(startHeight + delta, 260);
	        target.style.height = `${height}px`;
	      };
	      const onMouseUp = () => {
	        document.removeEventListener("mousemove", onMouseMove);
	        document.removeEventListener("mouseup", onMouseUp);
	        localStorage.setItem(`optical_${targetId}_height`, parseInt(target.style.height || "0", 10));
	      };
	      handle.addEventListener("mousedown", (event) => {
	        startY = event.clientY;
	        startHeight = target.getBoundingClientRect().height;
	        document.addEventListener("mousemove", onMouseMove);
	        document.addEventListener("mouseup", onMouseUp);
	      });
	    });
	  });
	</script>
{% endblock %}
