{% extends "base.html" %}
{% block content %}
{% if message %}
  <div class="alert">{{ message }}</div>
{% endif %}
<div class="grid">
  <div class="card">
    <h2>Optical Monitor</h2>
    {% set status = job_status.get('optical') %}
    <div class="status">
      <div><span class="badge {{ 'warn' if status and status.last_error else 'ok' }}">{{ 'attention' if status and status.last_error else 'ok' }}</span></div>
      <div>Last run: {{ status.last_run_at if status else 'never' }}</div>
      <div>Last success: {{ status.last_success_at if status else 'never' }}</div>
      <div>Last error: {{ status.last_error if status and status.last_error else 'none' }}</div>
    </div>
  </div>
  <div class="card">
    <h2>RTO Monitor</h2>
    {% set status = job_status.get('rto') %}
    <div class="status">
      <div><span class="badge {{ 'warn' if status and status.last_error else 'ok' }}">{{ 'attention' if status and status.last_error else 'ok' }}</span></div>
      <div>Last run: {{ status.last_run_at if status else 'never' }}</div>
      <div>Last success: {{ status.last_success_at if status else 'never' }}</div>
      <div>Last error: {{ status.last_error if status and status.last_error else 'none' }}</div>
    </div>
  </div>
  <div class="card">
    <h2>ISP Ping Monitor</h2>
    {% set status = job_status.get('isp_ping') %}
    <div class="status">
      <div><span class="badge {{ 'warn' if status and status.last_error else 'ok' }}">{{ 'attention' if status and status.last_error else 'ok' }}</span></div>
      <div>Last run: {{ status.last_run_at if status else 'never' }}</div>
      <div>Last success: {{ status.last_success_at if status else 'never' }}</div>
      <div>Last error: {{ status.last_error if status and status.last_error else 'none' }}</div>
    </div>
  </div>
  <div class="card">
    <h2>ISP Pulsewatch</h2>
    {% set pulse_state = isp_state.get('pulsewatch', {}) %}
    {% set isp_state_map = pulse_state.get('isps', {}) %}
    <div class="status">
      <div>Enabled: {{ 'yes' if isp_settings.pulsewatch.enabled else 'no' }}</div>
      <div>Address-list sync: {{ 'on' if isp_settings.pulsewatch.manage_address_lists else 'off' }}</div>
    </div>
    {% for isp in isp_settings.pulsewatch.isps %}
      {% set isp_summary = isp_state_map.get(isp.id, {}).get('last_summary', {}) %}
      {% set speed = speedtests.get(isp.id) %}
      <div style="margin-top: 14px; padding-top: 12px; border-top: 1px solid #d6d6cf;">
        <div style="font-weight: 700;">{{ isp.label }}</div>
        <div class="status">
          <div>Last ping check: {{ isp_summary.get('last_check') or 'n/a' }}</div>
          <div>Loss max: {{ isp_summary.get('loss_max') if isp_summary.get('loss_max') is not none else 'n/a' }}%</div>
          <div>Avg max: {{ isp_summary.get('avg_max') if isp_summary.get('avg_max') is not none else 'n/a' }}ms</div>
          <div>Last speedtest: {% if speed %}{{ speed.download_mbps if speed.download_mbps is not none else 'n/a' }} / {{ speed.upload_mbps if speed.upload_mbps is not none else 'n/a' }} Mbps, {{ speed.latency_ms if speed.latency_ms is not none else 'n/a' }} ms{% else %}n/a{% endif %}</div>
        </div>
        <div style="margin-top: 8px;">
          <form method="post" action="/isp/pulsewatch/ping/{{ isp.id }}" style="display: inline-block; margin-right: 6px;">
            <button type="submit" class="button-blue">Run Ping</button>
          </form>
          <form method="post" action="/isp/pulsewatch/speedtest/{{ isp.id }}" style="display: inline-block;">
            <button type="submit">Run Speedtest</button>
          </form>
        </div>
      </div>
    {% endfor %}
  </div>
</div>
{% endblock %}
