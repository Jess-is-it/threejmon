{% extends "base.html" %}
{% block content %}
<div class="page-header d-print-none">
  <div class="row align-items-center">
    <div class="col">
      <h2 class="page-title">WAN Ping</h2>
    </div>
  </div>
</div>

{% if message %}
  <div class="alert alert-info">{{ message }}</div>
{% endif %}

<div class="card">
  <div class="card-body">
    <ul class="nav nav-tabs" data-bs-toggle="tabs">
      <li class="nav-item">
        <a href="#wan-status" class="nav-link {% if active_tab == 'status' %}active{% endif %}" data-bs-toggle="tab">WAN Status</a>
      </li>
      <li class="nav-item">
        <a href="#wan-settings" class="nav-link {% if active_tab != 'status' %}active{% endif %}" data-bs-toggle="tab">WAN Settings</a>
      </li>
    </ul>
    <div class="tab-content pt-4">
      <div class="tab-pane {% if active_tab == 'status' %}active{% endif %}" id="wan-status">
        <div class="card mb-3">
          <div class="card-header d-flex align-items-center">
            <h4 class="card-title mb-0">Pulsewatch Stability Overview</h4>
            <div class="ms-auto">
              <select class="form-select form-select-sm" id="pulsewatch-stability-days" style="min-width: 140px;">
                {% set pie_days = pulsewatch_settings.pulsewatch.dashboard.pie_default_days %}
                <option value="1h">Last 1h</option>
                <option value="6h">Last 6h</option>
                <option value="12h">Last 12h</option>
                <option value="1d" {% if pie_days == 1 %}selected{% endif %}>Last 1 day</option>
                <option value="7d" {% if pie_days == 7 %}selected{% endif %}>Last 7 days</option>
                <option value="15d" {% if pie_days == 15 %}selected{% endif %}>Last 15 days</option>
                <option value="30d" {% if pie_days == 30 %}selected{% endif %}>Last 30 days</option>
              </select>
            </div>
          </div>
          <div class="card-body">
            <div id="pulsewatch-stability-grid" class="d-grid" style="gap: 6px; grid-template-columns: repeat(auto-fit, minmax(120px, 1fr)); justify-items: start;"></div>
            <div class="pulsewatch-stability-legend mt-3 justify-content-end">
              <div class="d-flex align-items-center gap-2 small text-muted">
                <span style="width:10px;height:10px;border-radius:50%;background:#2fb344;display:inline-block;"></span>
                <span>Stable</span>
              </div>
              <div class="d-flex align-items-center gap-2 small text-muted">
                <span style="width:10px;height:10px;border-radius:50%;background:#f59f00;display:inline-block;"></span>
                <span>Unstable</span>
              </div>
              <div class="d-flex align-items-center gap-2 small text-muted">
                <span style="width:10px;height:10px;border-radius:50%;background:#e03131;display:inline-block;"></span>
                <span>Critical</span>
              </div>
              <div class="d-flex align-items-center gap-2 small text-muted">
                <span style="width:10px;height:10px;border-radius:50%;background:#f76707;display:inline-block;"></span>
                <span>Down</span>
              </div>
            </div>
          </div>
        </div>
        <div class="card mb-3">
          <div class="card-header">
            <div class="row g-2 align-items-center w-100">
              <div class="col-12 col-lg-4">
                <h4 class="mb-0">WAN Status Overview</h4>
              </div>
              <div class="col-12 col-lg-8">
                <div class="d-flex align-items-center gap-2 flex-nowrap justify-content-lg-end">
                  <span class="text-muted small">Filter core</span>
                  <select class="form-select form-select-sm" id="wan-core-filter" style="min-width: 160px;">
                    <option value="all">All cores</option>
                    {% for core in pulsewatch_settings.pulsewatch.mikrotik.cores %}
                      <option value="{{ core.id }}">{{ core.label }}</option>
                    {% endfor %}
                  </select>
                  <span class="text-muted small">Range</span>
                  <select class="form-select form-select-sm" id="wan-range-filter" style="min-width: 120px;">
                    <option value="6">Last 6h</option>
                    <option value="12">Last 12h</option>
                    <option value="24" selected>Last 24h</option>
                  </select>
                  <span class="text-muted small">Target</span>
                  <select class="form-select form-select-sm" id="wan-target-filter" style="min-width: 140px;">
                    <option value="all">All targets</option>
                    {% for target in wan_targets %}
                      <option value="{{ target }}">{{ target }}</option>
                    {% endfor %}
                  </select>
                  <span class="text-muted small">From</span>
                  <input class="form-control form-control-sm" id="wan-from-filter" type="datetime-local" style="min-width: 190px;">
                  <span class="text-muted small">To</span>
                  <input class="form-control form-control-sm" id="wan-to-filter" type="datetime-local" style="min-width: 190px;">
                </div>
              </div>
            </div>
          </div>
          <div class="card-body">
            <div class="text-muted small mb-2">Vertical: up-time percentage (0-100%) Â· Horizontal: time (PHT)</div>
            <div id="wan-latency-chart" style="width: 100%; height: 120px; position: relative;"></div>
            <div id="wan-latency-legend" class="mt-1 d-flex flex-wrap gap-3"></div>
          </div>
        </div>
        <div class="card">
          <div class="card-body">
            <div class="d-flex flex-wrap align-items-center justify-content-between mb-3 gap-2">
              <div>
                <h4 class="mb-1">WAN Status</h4>
                <div class="text-muted small">Latest check results from WAN Ping.</div>
              </div>
              <div class="d-flex align-items-center gap-2 flex-wrap">
                <span class="badge bg-blue-lt">Total: {{ wan_status.total }}</span>
                <span class="badge bg-green-lt">Up: {{ wan_status.up_total }}</span>
                <span class="badge bg-red-lt">Down: {{ wan_status.down_total }}</span>
                <div class="dropdown">
                  <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">Window: {{ wan_status.window_label }}</button>
                  <div class="dropdown-menu dropdown-menu-end">
                    {% for label, hours in wan_window_options %}
                      <a class="dropdown-item" href="?wan_window={{ hours }}#wan-status">Filter {{ label }}</a>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
            <div class="d-flex align-items-center gap-2 flex-wrap mb-2">
              <label class="form-label mb-0">Status</label>
              <select class="form-select form-select-sm" id="wan-status-filter" style="max-width: 160px;">
                <option value="all">All</option>
                <option value="up">Up</option>
                <option value="down">Down</option>
              </select>
              <label class="form-label mb-0">Search</label>
              <input class="form-control form-control-sm" id="wan-status-search" type="text" placeholder="Search WAN" style="max-width: 200px;">
            </div>
            <div style="overflow-x: auto;">
              <table class="table table-vcenter">
                <thead>
                  <tr>
                    <th>WAN</th>
                    <th>Status</th>
                    <th>Target</th>
                    <th>Uptime %</th>
                    <th>Trend</th>
                    <th>Last Check</th>
                    <th>Last RTT (ms)</th>
                    <th>Error</th>
                  </tr>
                </thead>
                <tbody id="wan-status-body">
                  {% for row in wan_status.rows %}
                    {% set status_lower = row.status|lower %}
                    <tr data-status="{{ status_lower }}" data-label="{{ row.label|lower }}">
                      <td>{{ row.label }}</td>
                      <td>
                        {% if status_lower == 'up' %}
                          <span class="badge bg-green-lt text-uppercase">Up</span>
                        {% elif status_lower == 'down' %}
                          <span class="badge bg-red-lt text-uppercase">Down</span>
                        {% else %}
                          <span class="badge bg-secondary-lt text-uppercase">{{ row.status or 'n/a' }}</span>
                        {% endif %}
                      </td>
                      <td>{{ row.target or "n/a" }}</td>
                      <td>{{ row.uptime_pct is not none and ("%.1f"|format(row.uptime_pct)) or "n/a" }}</td>
                      <td>
                        <svg width="120" height="28">
                          <polyline points="{{ row.spark_points }}" fill="none" stroke="#2fb344" stroke-width="2" />
                        </svg>
                      </td>
                      <td>{{ row.last_check or "n/a" }}</td>
                      <td>{{ row.last_rtt_ms or "n/a" }}</td>
                      <td>{{ row.last_error or "" }}</td>
                    </tr>
                  {% endfor %}
                </tbody>
              </table>
            </div>
            {% if not wan_rows %}
              <div class="text-muted">No WAN entries detected yet.</div>
            {% endif %}
          </div>
        </div>
      </div>

      <div class="tab-pane {% if active_tab != 'status' %}active{% endif %}" id="wan-settings">
        <ul class="nav nav-tabs" data-bs-toggle="tabs">
          <li class="nav-item">
            <a href="#wan-add" class="nav-link {% if active_tab == 'add' or active_tab == 'status' %}active{% endif %}" data-bs-toggle="tab">Add WAN</a>
          </li>
          <li class="nav-item">
            <a href="#wan-routers" class="nav-link {% if active_tab == 'routers' %}active{% endif %}" data-bs-toggle="tab">Add PPPoE MikroTik (Bridge)</a>
          </li>
          <li class="nav-item">
            <a href="#wan-settings-tab" class="nav-link {% if active_tab == 'settings' %}active{% endif %}" data-bs-toggle="tab">Settings</a>
          </li>
          <li class="nav-item">
            <a href="#wan-messages" class="nav-link {% if active_tab == 'messages' %}active{% endif %}" data-bs-toggle="tab">Messages</a>
          </li>
        </ul>
        <div class="tab-content pt-4">
          <div class="tab-pane {% if active_tab == 'add' or active_tab == 'status' %}active{% endif %}" id="wan-add">
        <form method="post" action="/settings/wan/wans">
          <div class="card mb-3">
            <div class="card-body">
              <h4 class="mb-3">Detected WAN Entries</h4>
              <div class="alert alert-info">
                <div class="d-flex align-items-start">
                  <span class="me-2"><i class="ti ti-info-circle"></i></span>
                  <div>
                    WANs are prepopulated from each MikroTik core using TO-ISP lists. Add the missing fields below.
                    <div class="mt-2">Note: WAN checks use the Local IP as the target. If blank, the first target from Pulsewatch Presets is used.</div>
                  </div>
                </div>
              </div>
              <input type="hidden" name="wan_count" value="{{ wan_rows|length }}" />
              <div style="overflow-x: auto;">
                <table class="table table-vcenter">
                  <thead>
                    <tr>
                      <th title="MikroTik core where this TO-ISP list is found.">Core</th>
                      <th title="Address-list name pulled from MikroTik.">TO-ISP List</th>
                      <th title="Auto from Pulsewatch identifier; update it in Pulsewatch Presets.">Identifier</th>
                      <th title="Routed = ping via core router; Bridged = ping via PPPoE router.">Mode</th>
                      <th title="Source IP to bind for server ping checks.">Local IP</th>
                      <th title="Select PPPoE router for Bridged mode.">PPPoE Router</th>
                      <th title="Disable to skip checks for this WAN.">Enabled</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for row in wan_rows %}
                      <tr>
                        <td>
                          {{ row.core_label }}
                          <input type="hidden" name="wan_{{ loop.index0 }}_core_id" value="{{ row.core_id }}" />
                        </td>
                        <td>
                          {{ row.list_name }}
                          <input type="hidden" name="wan_{{ loop.index0 }}_list" value="{{ row.list_name }}" />
                        </td>
                        <td>
                          {% if row.identifier_missing %}
                            <span class="text-muted">add identifier name in pulsewatch</span>
                          {% else %}
                            {{ row.identifier }}
                          {% endif %}
                        </td>
                        <td>
                          <select name="wan_{{ loop.index0 }}_mode" class="form-select wan-mode" data-row="{{ loop.index0 }}">
                            <option value="routed" {% if row.mode == 'routed' %}selected{% endif %}>Routed</option>
                            <option value="bridged" {% if row.mode == 'bridged' %}selected{% endif %}>Bridged</option>
                          </select>
                        </td>
                        <td>
                          <input type="text" class="form-control wan-local-ip" name="wan_{{ loop.index0 }}_local_ip" value="{{ row.local_ip }}" data-row="{{ loop.index0 }}" />
                        </td>
                        <td>
                          <select name="wan_{{ loop.index0 }}_pppoe_router_id" class="form-select wan-router" data-row="{{ loop.index0 }}">
                            <option value="">Select router</option>
                            {% for router in settings.pppoe_routers %}
                              <option value="{{ router.id }}" {% if row.pppoe_router_id == router.id %}selected{% endif %}>{{ router.name or router.id }}</option>
                            {% endfor %}
                          </select>
                        </td>
                        <td>
                          <label class="form-check form-switch">
                            <input class="form-check-input wan-enabled" type="checkbox" name="wan_{{ loop.index0 }}_enabled" data-row="{{ loop.index0 }}" {% if row.enabled %}checked{% endif %} {% if not row.local_ip %}disabled{% endif %} />
                          </label>
                        </td>
                      </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              {% if not wan_rows %}
                <div class="text-muted">No TO-ISP lists detected. Check System Settings or MikroTik API connectivity.</div>
              {% endif %}
            </div>
            <div class="card-footer d-flex justify-content-end">
              <button type="submit" class="btn btn-primary">Save WAN List</button>
            </div>
          </div>
        </form>
        <div class="card">
          <div class="card-body">
            <div class="text-muted">Use this tab to manage WAN list settings.</div>
          </div>
        </div>
          </div>

          <div class="tab-pane {% if active_tab == 'routers' %}active{% endif %}" id="wan-routers">
        <div class="d-flex justify-content-between align-items-center mb-2">
          <h4 class="mb-0">PPPoE MikroTik Routers</h4>
          <form method="post" action="/settings/wan/routers/add">
            <button type="submit" class="btn btn-outline-primary">Add Router</button>
          </form>
        </div>
        <form method="post" action="/settings/wan/routers">
          <input type="hidden" name="router_count" value="{{ settings.pppoe_routers|length }}" />
          <div style="overflow-x: auto;">
            <table class="table table-vcenter">
              <thead>
                <tr>
                  <th title="Friendly label for the PPPoE router.">Name</th>
                  <th title="Router IP or hostname for RouterOS API.">Host</th>
                  <th title="API port (8728) or API-SSL port (8729).">Port</th>
                  <th title="RouterOS API username.">Username</th>
                  <th title="RouterOS API password.">Password</th>
                  <th title="Enable only if api-ssl is configured on the router.">TLS</th>
                  <th title="Try connecting to the RouterOS API.">Test</th>
                  <th title="Mark for removal on save.">Remove</th>
                </tr>
              </thead>
              <tbody>
                {% for router in settings.pppoe_routers %}
                  <tr>
                    <td>
                      <input type="hidden" name="router_{{ loop.index0 }}_id" value="{{ router.id }}" />
                      <input class="form-control" type="text" name="router_{{ loop.index0 }}_name" value="{{ router.name }}" />
                    </td>
                    <td><input class="form-control" type="text" name="router_{{ loop.index0 }}_host" value="{{ router.host }}" /></td>
                    <td><input class="form-control" type="number" name="router_{{ loop.index0 }}_port" value="{{ router.port or 8728 }}" /></td>
                    <td><input class="form-control" type="text" name="router_{{ loop.index0 }}_username" value="{{ router.username }}" /></td>
                    <td><input class="form-control" type="password" name="router_{{ loop.index0 }}_password" value="{{ router.password }}" /></td>
                    <td>
                      <label class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" name="router_{{ loop.index0 }}_use_tls" {% if router.use_tls %}checked{% endif %} />
                      </label>
                    </td>
                    <td>
                      <button type="submit" class="btn btn-outline-primary btn-sm" formaction="/settings/wan/routers/test/{{ router.id }}" formmethod="post">Test</button>
                    </td>
                    <td>
                      <label class="form-check">
                        <input class="form-check-input" type="checkbox" name="router_{{ loop.index0 }}_remove" />
                        <span class="form-check-label text-muted">Remove</span>
                      </label>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
          {% if not settings.pppoe_routers %}
            <div class="text-muted">No PPPoE routers added.</div>
          {% endif %}
          <div class="d-flex justify-content-end mt-3">
            <button type="submit" class="btn btn-primary">Save PPPoE Routers</button>
          </div>
        </form>
          </div>

          <div class="tab-pane {% if active_tab == 'settings' %}active{% endif %}" id="wan-settings-tab">
        <ul class="nav nav-tabs" data-bs-toggle="tabs">
          <li class="nav-item">
            <a href="#wan-settings-telegram" class="nav-link active" data-bs-toggle="tab">Telegram</a>
          </li>
          <li class="nav-item">
            <a href="#wan-settings-interval" class="nav-link" data-bs-toggle="tab">Interval</a>
          </li>
          <li class="nav-item">
            <a href="#wan-settings-database" class="nav-link" data-bs-toggle="tab">Database</a>
          </li>
          <li class="nav-item">
            <a href="#wan-settings-danger" class="nav-link" data-bs-toggle="tab">Danger</a>
          </li>
        </ul>
        <div class="tab-content pt-4">
          <div class="tab-pane active" id="wan-settings-telegram">
        <form method="post" action="/settings/wan/telegram">
          <div class="card mb-3">
            <div class="card-body">
              <h4 class="mb-3">Telegram</h4>
              <div class="row g-3">
                <div class="col-md-6">
                  <label class="form-label">Bot Token <span class="info" data-tip="Telegram bot token from BotFather.">i</span></label>
                  <input class="form-control" type="text" name="telegram_bot_token" value="{{ settings.telegram.bot_token }}" />
                </div>
                <div class="col-md-6">
                  <label class="form-label">Chat ID <span class="info" data-tip="Target Telegram chat ID where alerts should be sent.">i</span></label>
                  <input class="form-control" type="text" name="telegram_chat_id" value="{{ settings.telegram.chat_id }}" />
                </div>
              </div>
            </div>
            <div class="card-footer d-flex justify-content-end">
              <button type="submit" class="btn btn-primary">Save Telegram Settings</button>
            </div>
          </div>
        </form>
          </div>

          <div class="tab-pane" id="wan-settings-interval">
        <div class="card mb-3">
          <div class="card-body">
            <h4 class="mb-3">WAN Ping Interval</h4>
            <div class="row g-3">
              <div class="col-md-4">
                <label class="form-label">Interval (seconds)</label>
                <input class="form-control" type="number" name="wan_interval_seconds" value="{{ settings.general.interval_seconds }}" form="wan-interval-form" />
                <div class="help">How often to poll WAN status and refresh Netwatch entries.</div>
              </div>
            </div>
          </div>
          <div class="card-footer d-flex justify-content-end">
            <form id="wan-interval-form" method="post" action="/settings/wan/interval">
              <button type="submit" class="btn btn-primary">Save Interval</button>
            </form>
          </div>
        </div>
          </div>

          <div class="tab-pane" id="wan-settings-database">
        <form method="post" action="/settings/wan/database">
          <div class="card mb-3">
            <div class="card-body">
              <h4 class="mb-3">WAN History Database</h4>
              <div class="row g-3">
                <div class="col-md-4">
                  <label class="form-label">Retention (days)</label>
                  <input class="form-control" type="number" name="wan_history_retention_days" value="{{ settings.general.history_retention_days }}" min="1" max="1460" />
                  <div class="help">Older WAN status samples auto-delete when they exceed this retention.</div>
                </div>
              </div>
            </div>
            <div class="card-footer d-flex justify-content-end">
              <button type="submit" class="btn btn-primary">Save Database Settings</button>
            </div>
          </div>
        </form>
          </div>

          <div class="tab-pane" id="wan-settings-danger">
        <div class="card">
          <div class="card-body">
            <h4 class="mb-2">Format WAN Status Database</h4>
            <div class="alert alert-warning">
              <div class="d-flex align-items-center">
                <span class="me-2"><i class="ti ti-alert-triangle"></i></span>
                <div>Formatting removes WAN status history. Settings are preserved.</div>
              </div>
            </div>
            <form method="post" action="/settings/wan/format">
              <label class="form-check">
                <input class="form-check-input" type="checkbox" name="confirm_format" />
                <span class="form-check-label">I understand this will erase WAN status data.</span>
              </label>
              <div class="mt-3">
                <button type="submit" class="btn btn-danger">Format WAN Status Database</button>
              </div>
            </form>
          </div>
        </div>
          </div>
        </div>
          </div>
<div class="tab-pane {% if active_tab == 'messages' %}active{% endif %}" id="wan-messages">
        <form method="post" action="/settings/wan/messages">
          <div class="card mb-3">
            <div class="card-body">
              <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
                <h4 class="mb-0">Daily Summary Message</h4>
                <button type="button" class="stamp-note btn btn-sm btn-azure-lt" data-bs-toggle="modal" data-bs-target="#wan-stamps-modal">
                  <i class="ti ti-notes"></i>Stamps
                </button>
              </div>
              <div class="row g-3 mb-3">
                <div class="col-md-3">
                  <label class="form-label">Enable Daily Summary</label>
                  <label class="form-check form-switch">
                    <input class="form-check-input" type="checkbox" name="summary_enabled" {% if settings.summary.enabled %}checked{% endif %} />
                    <span class="form-check-label">Enabled</span>
                  </label>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Daily Time (HH:MM)</label>
                  <input class="form-control" type="text" name="summary_daily_time" value="{{ settings.summary.daily_time }}" />
                </div>
                <div class="col-md-3">
                  <label class="form-label">All Up Message</label>
                  <textarea class="form-control" name="summary_all_up_msg" rows="2">{{ settings.summary.all_up_msg or wan_summary_defaults.all_up_msg }}</textarea>
                </div>
                <div class="col-md-3">
                  <label class="form-label">Partial Down Message</label>
                  <textarea class="form-control" name="summary_partial_msg" rows="2">{{ settings.summary.partial_msg or wan_summary_defaults.partial_msg }}</textarea>
                </div>
                <div class="col-12">
                  <label class="form-label">Per-ISP Line Template</label>
                  <textarea class="form-control" name="summary_line_template" rows="2">{{ settings.summary.line_template or wan_summary_defaults.line_template }}</textarea>
                  <div class="help">Example line: {label} Status {status}!</div>
                </div>
              </div>
              <hr class="my-3" />
              <div class="d-flex flex-wrap align-items-center justify-content-between gap-2 mb-3">
                <h4 class="mb-0">Per-ISP Messages</h4>
              </div>
              <div class="alert alert-info">
                <div class="d-flex align-items-start">
                  <span class="me-2"><i class="ti ti-info-circle"></i></span>
                  <div>Use emojis or Telegram icon codes in the messages. Multi-line text is supported.</div>
                </div>
              </div>
              <input type="hidden" name="message_count" value="{{ wan_rows|length }}" />
              {% for row in wan_rows %}
                {% set msg = settings.messages.get(row.wan_id, {}) %}
                <div class="border rounded p-3 mb-3">
                  <div class="fw-semibold mb-2">
                    {{ row.core_label }} - {{ row.identifier or row.list_name }}
                    {% if row.identifier_missing %}
                      <span class="text-muted">(add identifier name in pulsewatch)</span>
                    {% endif %}
                  </div>
                  <input type="hidden" name="message_{{ loop.index0 }}_id" value="{{ row.wan_id }}" />
                  <div class="row g-3">
                    <div class="col-md-4">
                      <label class="form-label">Down Message <span class="info" data-tip="Sent when the WAN goes DOWN. Supports {label}.">i</span></label>
                      <textarea class="form-control" name="message_{{ loop.index0 }}_down_msg" rows="3">{{ msg.down_msg or wan_message_defaults.down_msg }}</textarea>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Up Message <span class="info" data-tip="Sent when the WAN comes UP again. Supports {label}.">i</span></label>
                      <textarea class="form-control" name="message_{{ loop.index0 }}_up_msg" rows="3">{{ msg.up_msg or wan_message_defaults.up_msg }}</textarea>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Still Down Message <span class="info" data-tip="Sent on a repeating interval while still down. Supports {label}.">i</span></label>
                      <textarea class="form-control" name="message_{{ loop.index0 }}_still_down_msg" rows="3">{{ msg.still_down_msg or wan_message_defaults.still_down_msg }}</textarea>
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Send Down Message Once <span class="info" data-tip="If disabled, DOWN messages repeat every N minutes.">i</span></label>
                      <label class="form-check form-switch">
                        <input class="form-check-input wan-send-once" type="checkbox" name="message_{{ loop.index0 }}_send_down_once" data-row="{{ loop.index0 }}" {% if msg.send_down_once is not defined or msg.send_down_once %}checked{% endif %} />
                        <span class="form-check-label">Enabled</span>
                      </label>
                    </div>
                    <div class="col-md-4 wan-repeat-field" data-row="{{ loop.index0 }}">
                      <label class="form-label">Repeat Down Message (minutes) <span class="info" data-tip="How often to resend DOWN messages when Send Once is disabled.">i</span></label>
                      <input class="form-control" type="number" name="message_{{ loop.index0 }}_repeat_minutes" value="{{ msg.repeat_down_interval_minutes or 30 }}" />
                    </div>
                    <div class="col-md-4">
                      <label class="form-label">Still Down Interval (hours) <span class="info" data-tip="How often to send the Still Down message.">i</span></label>
                      <input class="form-control" type="number" name="message_{{ loop.index0 }}_still_hours" value="{{ msg.still_down_interval_hours or 8 }}" />
                    </div>
                  </div>
                </div>
              {% endfor %}
              {% if not wan_rows %}
                <div class="text-muted">No WAN entries detected yet.</div>
              {% endif %}
            </div>
            <div class="card-footer d-flex justify-content-end">
              <button type="submit" class="btn btn-primary">Save Messages</button>
            </div>
          </div>
        </form>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="modal modal-blur fade" id="wan-stamps-modal" tabindex="-1" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">WAN Message Stamps</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body">
        <div class="text-muted mb-3">Use these placeholders in your WAN Telegram messages.</div>
        <div class="row g-3">
          <div class="col-md-6">
            <div class="fw-semibold mb-1">Identity</div>
            {% raw %}
            <div class="small text-muted">{{label}} - WAN name</div>
            <div class="small text-muted">{{target}} - ping target</div>
            <div class="small text-muted">{{core}} - core label</div>
            <div class="small text-muted">{{list}} - TO-ISP list</div>
            <div class="small text-muted">{{mode}} - routed or bridged</div>
            <div class="small text-muted">{{status}} - current status</div>
            {% endraw %}
          </div>
          <div class="col-md-6">
            <div class="fw-semibold mb-1">Time</div>
            {% raw %}
            <div class="small text-muted">{{date}} - 2025-01-20</div>
            <div class="small text-muted">{{time}} - 08:15 PM</div>
            <div class="small text-muted">{{datetime}} - 2025-01-20 08:15 PM</div>
            <div class="small text-muted">{{down-sincedatetime}} - 2025-01-20 06:10 PM</div>
            {% endraw %}
          </div>
          <div class="col-md-6">
            <div class="fw-semibold mb-1">Network</div>
            {% raw %}
            <div class="small text-muted">{{local-ip}} - source IP</div>
            {% endraw %}
          </div>
          <div class="col-md-6">
            <div class="fw-semibold mb-1">Ping</div>
            {% raw %}
            <div class="small text-muted">{{ping5}} - 5 ping lines</div>
            {% endraw %}
            <div class="small text-muted">Target uses the Local IP when set; otherwise the first Pulsewatch preset target.</div>
          </div>
        </div>
        <div class="mt-3 p-3 bg-light rounded">
          <div class="fw-semibold mb-1">Example</div>
          {% raw %}
          <pre class="mb-0 small">ðŸ”´3J SME 500 PLDT (58.71.97.1) is still DOWN since {{down-sincedatetime}}
{{ping5}}</pre>
          {% endraw %}
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Close</button>
      </div>
    </div>
  </div>
</div>

<script>
  const toggleWanFields = (rowId) => {
    const mode = document.querySelector(`.wan-mode[data-row="${rowId}"]`);
    const localInput = document.querySelector(`.wan-local-ip[data-row="${rowId}"]`);
    const routerSelect = document.querySelector(`.wan-router[data-row="${rowId}"]`);
    const enabledToggle = document.querySelector(`.wan-enabled[data-row="${rowId}"]`);
    if (!mode || !localInput || !routerSelect || !enabledToggle) return;
    const isBridged = mode.value === "bridged";
    localInput.disabled = false;
    routerSelect.disabled = !isBridged;
    localInput.style.opacity = "1";
    routerSelect.style.opacity = isBridged ? "1" : "0.6";
    const hasLocal = Boolean(localInput.value.trim());
    enabledToggle.disabled = !hasLocal;
    if (!hasLocal) {
      enabledToggle.checked = false;
    }
  };

  document.querySelectorAll(".wan-mode").forEach((select) => {
    toggleWanFields(select.dataset.row);
    select.addEventListener("change", () => toggleWanFields(select.dataset.row));
  });

  document.querySelectorAll(".wan-local-ip").forEach((input) => {
    toggleWanFields(input.dataset.row);
    input.addEventListener("input", () => toggleWanFields(input.dataset.row));
  });

  const toggleRepeatField = (rowId) => {
    const checkbox = document.querySelector(`.wan-send-once[data-row="${rowId}"]`);
    const repeatField = document.querySelector(`.wan-repeat-field[data-row="${rowId}"]`);
    if (!checkbox || !repeatField) return;
    const hidden = checkbox.checked;
    repeatField.style.opacity = hidden ? "0.5" : "1";
    repeatField.querySelector("input").disabled = hidden;
  };

  document.querySelectorAll(".wan-send-once").forEach((checkbox) => {
    toggleRepeatField(checkbox.dataset.row);
    checkbox.addEventListener("change", () => toggleRepeatField(checkbox.dataset.row));
  });

  let wanLatencySeries = {{ wan_latency_series | tojson }};
  const chartEl = document.getElementById("wan-latency-chart");
  const legendEl = document.getElementById("wan-latency-legend");
  const filterEl = document.getElementById("wan-core-filter");
  const rangeEl = document.getElementById("wan-range-filter");
  const targetEl = document.getElementById("wan-target-filter");
  const fromEl = document.getElementById("wan-from-filter");
  const toEl = document.getElementById("wan-to-filter");
  const statusBody = document.getElementById("wan-status-body");
  const wanRefreshSeconds = 2;

  const escapeHtml = (value) => String(value ?? "")
    .replace(/&/g, "&amp;")
    .replace(/</g, "&lt;")
    .replace(/>/g, "&gt;")
    .replace(/\"/g, "&quot;")
    .replace(/'/g, "&#39;");

  const tooltip = document.createElement("div");
  tooltip.style.position = "absolute";
  tooltip.style.background = "transparent";
  tooltip.style.color = "#111827";
  tooltip.style.padding = "6px 8px";
  tooltip.style.borderRadius = "6px";
  tooltip.style.fontSize = "12px";
  tooltip.style.textShadow = "0 0 2px #fff, 0 0 4px #fff";
  tooltip.style.pointerEvents = "none";
  tooltip.style.display = "none";
  tooltip.style.zIndex = "10";
  if (chartEl) {
    chartEl.appendChild(tooltip);
  }

  const toEpoch = (value) => {
    if (!value) return null;
    const rawValue = String(value).trim();
    if (!rawValue) return null;
    const direct = Date.parse(rawValue);
    if (!Number.isNaN(direct)) return direct;
    const hasTimezone = /Z$|[+-]\\d{2}:?\\d{2}$/.test(rawValue);
    if (hasTimezone) return null;
    const withUtc = Date.parse(`${rawValue}Z`);
    return Number.isNaN(withUtc) ? null : withUtc;
  };

  const toLocalEpoch = (value) => {
    if (!value) return null;
    const parsed = new Date(value).getTime();
    if (!Number.isNaN(parsed)) return parsed;
    const fallback = Date.parse(value);
    return Number.isNaN(fallback) ? null : fallback;
  };

  const resolveWindow = (series, hours, fromTs, toTs) => {
    const allTimes = series.flatMap((item) => item.points.map((point) => toEpoch(point.ts))).filter(Boolean);
    if (!allTimes.length) return null;
    const minAll = Math.min(...allTimes);
    const maxAll = Math.max(...allTimes);
    let start;
    let end;
    if (fromTs || toTs) {
      start = fromTs ?? minAll;
      end = toTs ?? maxAll;
    } else {
      end = maxAll;
      start = end - hours * 60 * 60 * 1000;
    }
    if (start > end) {
      const temp = start;
      start = end;
      end = temp;
    }
    return { start, end };
  };

  const activeIds = new Set();

  const renderChart = (coreId, hours, target, fromTs, toTs) => {
    if (!chartEl) return;
    const filtered = wanLatencySeries.filter((item) => {
      if (coreId !== "all" && item.core_id !== coreId) return false;
      if (target !== "all" && item.target !== target) return false;
      return true;
    });
    const window = resolveWindow(filtered, hours, fromTs, toTs);
    if (!window) {
      chartEl.innerHTML = "<div class='text-muted'>No latency data available.</div>";
      return;
    }
    const series = filtered.map((item) => ({
      ...item,
      points: item.points.filter((point) => {
        const ts = toEpoch(point.ts);
        return ts !== null && ts >= window.start && ts <= window.end;
      }),
    }));
    chartEl.innerHTML = "";
    legendEl.innerHTML = "";
    chartEl.appendChild(tooltip);
    if (!series.length) {
      chartEl.innerHTML = "<div class='text-muted'>No data for selected core.</div>";
      return;
    }

    const minX = window.start;
    const maxX = window.end;

    const formatDuration = (seconds) => {
      const total = Math.max(Math.round(seconds), 0);
      const hrs = Math.floor(total / 3600);
      const mins = Math.floor((total % 3600) / 60);
      const secs = total % 60;
      const pad = (n) => String(n).padStart(2, "0");
      return `${pad(hrs)}:${pad(mins)}:${pad(secs)}s`;
    };

    const renderSeries = series.map((item) => {
      const points = item.points
        .map((point) => ({
          x: toEpoch(point.ts),
          y: point.value,
          downtime: formatDuration(point.downtime_seconds || 0),
        }))
        .filter((point) => point.x !== null && point.y !== null)
        .sort((a, b) => a.x - b.x);
      if (!points.length) return { ...item, renderPoints: [], rawPoints: [] };
      const stepPoints = [];
      for (let i = 0; i < points.length; i += 1) {
        stepPoints.push(points[i]);
        if (i < points.length - 1) {
          stepPoints.push({ x: points[i + 1].x, y: points[i].y, downtime: points[i].downtime });
        }
      }
      return { ...item, renderPoints: stepPoints, rawPoints: points };
    });

    const rawPoints = renderSeries.flatMap((item) =>
      item.renderPoints.map((point) => ({ x: point.x, y: point.y }))
    ).filter((point) => point.x !== null && point.y !== null);
    if (!rawPoints.length) {
      chartEl.innerHTML = "<div class='text-muted'>No latency data available.</div>";
      return;
    }

    const allPoints = renderSeries.flatMap((item) => item.renderPoints);
    const minY = 0;
    const maxY = 100;
    const width = chartEl.clientWidth || 600;
    const height = 80;
    const pad = 24;
    const spanX = Math.max(maxX - minX, 1);
    const spanY = Math.max(maxY - minY, 1);

    const svg = document.createElementNS("http://www.w3.org/2000/svg", "svg");
    svg.setAttribute("width", "100%");
    svg.setAttribute("height", height + pad * 1.5);
    svg.setAttribute("viewBox", `0 0 ${width} ${height + pad * 1.5}`);

    const axis = document.createElementNS("http://www.w3.org/2000/svg", "line");
    axis.setAttribute("x1", pad);
    axis.setAttribute("x2", width - pad);
    axis.setAttribute("y1", height);
    axis.setAttribute("y2", height);
    axis.setAttribute("stroke", "#e5e7eb");
    axis.setAttribute("stroke-width", "1");
    svg.appendChild(axis);

    const yTicks = [
      { value: 100, label: "UP", color: "#2fb344" },
      { value: 0, label: "DOWN", color: "#e03131" },
    ];
    yTicks.forEach(({ value, label, color }) => {
      const yPos = height - ((value - minY) / spanY) * (height - pad);
      const grid = document.createElementNS("http://www.w3.org/2000/svg", "line");
      grid.setAttribute("x1", pad);
      grid.setAttribute("x2", width - pad);
      grid.setAttribute("y1", yPos.toFixed(1));
      grid.setAttribute("y2", yPos.toFixed(1));
      grid.setAttribute("stroke", "#f3f4f6");
      grid.setAttribute("stroke-width", "1");
      svg.appendChild(grid);

      const labelEl = document.createElementNS("http://www.w3.org/2000/svg", "text");
      labelEl.setAttribute("x", 4);
      labelEl.setAttribute("y", yPos + 4);
      labelEl.setAttribute("fill", color);
      labelEl.setAttribute("font-size", "11");
      labelEl.setAttribute("font-weight", "600");
      labelEl.textContent = label;
      svg.appendChild(labelEl);
    });

    const formatTimeLabel = (ts, mode) => {
      const date = new Date(ts);
      if (mode === "date") {
        return date.toLocaleDateString("en-PH", { month: "numeric", day: "numeric", year: "2-digit" });
      }
      return date.toLocaleTimeString("en-PH", { hour: "numeric", minute: "2-digit", hour12: true });
    };

    const rangeHours = Math.max((maxX - minX) / (1000 * 60 * 60), 1);
    const timeMode = rangeHours >= 24 ? "date" : "time";
    const xTicks = [];
    if (timeMode === "date") {
      const start = new Date(minX);
      start.setHours(0, 0, 0, 0);
      for (let t = start.getTime(); t <= maxX; t += 24 * 60 * 60 * 1000) {
        if (t >= minX) xTicks.push(t);
      }
      if (!xTicks.length) {
        xTicks.push(minX, maxX);
      }
    } else {
      const tickStep = rangeHours <= 6 ? 1 : 2;
      const start = new Date(minX);
      start.setMinutes(0, 0, 0);
      const startTs = start.getTime();
      for (let t = startTs; t <= maxX; t += tickStep * 60 * 60 * 1000) {
        if (t >= minX) xTicks.push(t);
      }
    }
    if (!xTicks.length) {
      xTicks.push(minX);
      if (maxX !== minX) xTicks.push(maxX);
    }
    xTicks.forEach((t) => {
      const xPos = pad + ((t - minX) / spanX) * (width - pad * 2);
      const tick = document.createElementNS("http://www.w3.org/2000/svg", "line");
      tick.setAttribute("x1", xPos.toFixed(1));
      tick.setAttribute("x2", xPos.toFixed(1));
      tick.setAttribute("y1", height);
      tick.setAttribute("y2", height + 4);
      tick.setAttribute("stroke", "#e5e7eb");
      tick.setAttribute("stroke-width", "1");
      svg.appendChild(tick);

      const label = document.createElementNS("http://www.w3.org/2000/svg", "text");
      label.setAttribute("x", xPos.toFixed(1));
      label.setAttribute("y", height + 18);
      label.setAttribute("text-anchor", "middle");
      label.setAttribute("fill", "#9ca3af");
      label.setAttribute("font-size", "10");
      label.textContent = formatTimeLabel(t, timeMode);
      svg.appendChild(label);
    });

    const gapThresholdMs = 2 * 60 * 1000;
    renderSeries.forEach((item) => {
      if (!item.renderPoints.length) return;
      const sorted = item.renderPoints.slice().sort((a, b) => a.x - b.x);
      let segment = [];
      const flushSegment = () => {
        if (segment.length < 2) {
          segment = [];
          return;
        }
        const path = segment
          .map((point) => {
            const x = pad + ((point.x - minX) / spanX) * (width - pad * 2);
            const y = height - ((point.y - minY) / spanY) * (height - pad);
            return `${x.toFixed(1)},${y.toFixed(1)}`;
          })
          .join(" ");
        const polyline = document.createElementNS("http://www.w3.org/2000/svg", "polyline");
        polyline.setAttribute("points", path);
        polyline.setAttribute("fill", "none");
        polyline.setAttribute("stroke", item.color);
        polyline.setAttribute("stroke-width", "2");
        polyline.setAttribute("opacity", "0.9");
        polyline.setAttribute("data-series-id", item.id);
        svg.appendChild(polyline);
        segment = [];
      };
      let lastPoint = null;
      sorted.forEach((point) => {
        if (lastPoint && point.x - lastPoint.x > gapThresholdMs) {
          flushSegment();
        }
        segment.push(point);
        lastPoint = point;
      });
      flushSegment();

      const legend = document.createElement("div");
      legend.className = "d-flex align-items-center gap-2";
      legend.setAttribute("data-series-id", item.id);
      legend.innerHTML = `<span style="width:12px;height:12px;border-radius:50%;background:${item.color};display:inline-block;"></span><span class="small text-muted">${item.name}</span>`;
      legendEl.appendChild(legend);
    });

    const overlay = document.createElementNS("http://www.w3.org/2000/svg", "rect");
    overlay.setAttribute("x", pad);
    overlay.setAttribute("y", 0);
    overlay.setAttribute("width", width - pad * 2);
    overlay.setAttribute("height", height);
    overlay.setAttribute("fill", "transparent");
    overlay.style.cursor = "default";
    svg.appendChild(overlay);

    overlay.addEventListener("mousemove", (event) => {
      const rect = svg.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const rel = Math.min(Math.max(x - pad, 0), width - pad * 2);
      const targetTs = minX + (rel / (width - pad * 2)) * spanX;
      const details = [];
      const maxGapMs = Math.max(spanX * 0.03, 10 * 60 * 1000);
      const activeList = activeIds.size ? Array.from(activeIds) : null;
      renderSeries.forEach((item) => {
        if (activeList && !activeIds.has(item.id)) {
          return;
        }
        const points = item.renderPoints
          .map((point) => ({ x: point.x, y: point.y, downtime: point.downtime }))
          .filter((point) => point.x !== null && point.y !== null);
        if (!points.length) return;
        let nearest = points[0];
        let best = Math.abs(points[0].x - targetTs);
        for (const point of points) {
          const diff = Math.abs(point.x - targetTs);
          if (diff < best) {
            best = diff;
            nearest = point;
          }
        }
        if (Math.abs(nearest.x - targetTs) <= maxGapMs) {
          details.push({ name: item.name, color: item.color, value: nearest.y, downtime: nearest.downtime || "00:00:00s" });
        }
      });
      if (!details.length) {
        tooltip.style.display = "none";
        return;
      }
      const timeLabel = new Date(targetTs).toLocaleString("en-PH", { hour12: true });
      tooltip.innerHTML = `<div class="fw-semibold mb-1">${timeLabel}</div>` +
        details.map((item) => `<div style="display:flex;gap:6px;align-items:center;"><span style="width:8px;height:8px;border-radius:50%;background:${item.color};display:inline-block;"></span><span>${item.name}: ${item.value.toFixed(0)}% uptime Â· ${item.downtime} downtime</span></div>`).join("");
      tooltip.style.left = `${Math.min(x + 12, rect.width - 220)}px`;
      tooltip.style.top = `${Math.max(8, event.clientY - rect.top - 60)}px`;
      tooltip.style.display = "block";
    });

    overlay.addEventListener("mouseleave", () => {
      tooltip.style.display = "none";
    });

    overlay.addEventListener("wheel", (event) => {
      if (!event.ctrlKey) return;
      event.preventDefault();
      const rect = svg.getBoundingClientRect();
      const x = Math.min(Math.max(event.clientX - rect.left, pad), width - pad);
      const rel = Math.min(Math.max(x - pad, 0), width - pad * 2);
      const anchorTs = minX + (rel / (width - pad * 2)) * spanX;
      const { fromTs, toTs } = syncRangeState();
      const window = resolveZoomWindow(getRangeHours(), fromTs, toTs);
      const currentStart = window.start;
      const currentEnd = window.end;
      const scale = event.deltaY < 0 ? 0.8 : 1.25;
      const newStart = anchorTs - (anchorTs - currentStart) * scale;
      const newEnd = anchorTs + (currentEnd - anchorTs) * scale;
      setWindow(newStart, newEnd);
      updateChart();
    }, { passive: false });

    chartEl.appendChild(svg);

    const validIds = new Set(renderSeries.map((item) => item.id));
    Array.from(activeIds).forEach((id) => {
      if (!validIds.has(id)) {
        activeIds.delete(id);
      }
    });
    const setOpacity = () => {
      const lines = svg.querySelectorAll("polyline[data-series-id]");
      const hasSelection = activeIds.size > 0;
      lines.forEach((line) => {
        const id = line.getAttribute("data-series-id");
        line.setAttribute("opacity", hasSelection && !activeIds.has(id) ? "0.2" : "0.95");
      });
      const labels = legendEl.querySelectorAll("[data-series-id]");
      labels.forEach((label) => {
        const id = label.getAttribute("data-series-id");
        label.style.opacity = hasSelection && !activeIds.has(id) ? "0.4" : "1";
        label.style.fontWeight = activeIds.has(id) ? "600" : "400";
      });
    };

    legendEl.querySelectorAll("[data-series-id]").forEach((label) => {
      const seriesId = label.getAttribute("data-series-id");
      label.style.cursor = "pointer";
      label.addEventListener("click", () => {
        if (activeIds.has(seriesId)) {
          activeIds.delete(seriesId);
        } else {
          activeIds.add(seriesId);
        }
        setOpacity();
      });
    });
    setOpacity();
  };

  const getRangeHours = () => {
    const parsed = parseInt(rangeEl.value, 10);
    return Number.isNaN(parsed) ? 24 : parsed;
  };

  const formatLocalInput = (ts) => {
    const dt = new Date(ts);
    if (Number.isNaN(dt.getTime())) return "";
    const pad = (n) => String(n).padStart(2, "0");
    const yyyy = dt.getFullYear();
    const mm = pad(dt.getMonth() + 1);
    const dd = pad(dt.getDate());
    const hh = pad(dt.getHours());
    const min = pad(dt.getMinutes());
    return `${yyyy}-${mm}-${dd}T${hh}:${min}`;
  };

  const resolveZoomWindow = (hours, fromTs, toTs) => {
    let start;
    let end;
    if (fromTs || toTs) {
      start = fromTs ?? toTs;
      end = toTs ?? fromTs;
    } else {
      end = Date.now();
      start = end - hours * 60 * 60 * 1000;
    }
    if (start > end) {
      const temp = start;
      start = end;
      end = temp;
    }
    return { start, end };
  };

  const toIsoString = (value) => {
    if (!value) return null;
    const dt = new Date(value);
    if (Number.isNaN(dt.getTime())) return null;
    return dt.toISOString();
  };

  const syncRangeState = () => {
    const fromTs = toLocalEpoch(fromEl.value);
    const toTs = toLocalEpoch(toEl.value);
    const hasWindow = Boolean(fromTs || toTs);
    rangeEl.disabled = hasWindow;
    return { fromTs, toTs };
  };

  const fetchSeries = async (hours, fromIso, toIso) => {
    const params = new URLSearchParams();
    params.set("core_id", filterEl.value);
    params.set("target", targetEl.value);
    params.set("hours", String(hours));
    if (fromIso) params.set("start", fromIso);
    if (toIso) params.set("end", toIso);
    const response = await fetch(`/wan/latency-series?${params.toString()}`, {
      headers: { "Accept": "application/json" },
      cache: "no-store",
    });
    if (!response.ok) {
      throw new Error("Failed to load WAN latency series");
    }
    const payload = await response.json();
    wanLatencySeries = payload.series || [];
    if (legendEl) {
      legendEl.style.display = wanLatencySeries.length ? "flex" : "none";
    }
  };

  const updateChart = async () => {
    const { fromTs, toTs } = syncRangeState();
    const hours = getRangeHours();
    const fromIso = toIsoString(fromEl.value);
    const toIso = toIsoString(toEl.value);
    try {
      await fetchSeries(hours, fromIso, toIso);
    } catch (err) {
      console.error(err);
    }
    renderChart(filterEl.value, hours, targetEl.value, fromTs, toTs);
  };

  const applyWanStatusFilters = () => {
    if (!statusBody) return;
    const statusFilter = document.getElementById("wan-status-filter");
    const searchEl = document.getElementById("wan-status-search");
    const statusValue = statusFilter ? statusFilter.value : "all";
    const searchValue = (searchEl ? searchEl.value : "").toLowerCase();
    Array.from(statusBody.querySelectorAll("tr")).forEach((row) => {
      const rowStatus = (row.getAttribute("data-status") || "").toLowerCase();
      const label = (row.getAttribute("data-label") || row.textContent || "").toLowerCase();
      const statusMatch = statusValue === "all" || rowStatus === statusValue;
      const searchMatch = !searchValue || label.includes(searchValue);
      row.style.display = statusMatch && searchMatch ? "" : "none";
    });
  };

  const fetchStatus = async () => {};

  if (filterEl) {
    filterEl.addEventListener("change", () => {
      updateChart();
    });
  }
  if (rangeEl) {
    rangeEl.addEventListener("change", () => {
      if (fromEl) fromEl.value = "";
      if (toEl) toEl.value = "";
      rangeEl.disabled = false;
      updateChart();
    });
  }
  if (targetEl) {
    targetEl.addEventListener("change", () => {
      updateChart();
    });
  }
  if (fromEl) {
    fromEl.addEventListener("change", () => {
      updateChart();
    });
  }
  if (toEl) {
    toEl.addEventListener("change", () => {
      updateChart();
    });
  }
  const setWindow = (start, end) => {
    fromEl.value = formatLocalInput(start);
    toEl.value = formatLocalInput(end);
  };

  window.addEventListener("resize", () => {
    const { fromTs, toTs } = syncRangeState();
    renderChart(filterEl ? filterEl.value : "all", getRangeHours(), targetEl.value, fromTs, toTs);
  });

  updateChart();
  fetchStatus();
  setInterval(() => {
    fetchStatus();
    updateChart();
  }, wanRefreshSeconds * 1000);

  setTimeout(() => {
    updateChart();
  }, 500);

  const stabilityGridEl = document.getElementById("pulsewatch-stability-grid");
  const stabilityDaysEl = document.getElementById("pulsewatch-stability-days");
  const stabilityColors = ["#2fb344", "#f59f00", "#e03131", "#f76707"];
  const stabilityCharts = new Map();

  const renderStabilityGrid = (rows) => {
    if (!stabilityGridEl) return;
    stabilityCharts.forEach((chart) => chart.destroy());
    stabilityCharts.clear();
    if (!rows.length) {
      stabilityGridEl.innerHTML = "<div class='text-muted'>No Pulsewatch presets with IPs.</div>";
      return;
    }
    stabilityGridEl.innerHTML = rows.map((row) => {
      const chartId = `pulsewatch-stability-${row.id}`;
      return `
        <div class="pulsewatch-stability-item">
          <div class="pulsewatch-stability-chart-wrap">
            <div id="${chartId}" class="pulsewatch-stability-chart"></div>
            <div class="pulsewatch-stability-label">${escapeHtml(row.label || "Unnamed ISP")}</div>
          </div>
        </div>
      `;
    }).join("");

    rows.forEach((row) => {
      const chartId = `pulsewatch-stability-${row.id}`;
      const el = document.getElementById(chartId);
      if (!el || !window.ApexCharts) return;
      const series = [row.healthy || 0, row.degraded || 0, row.poor || 0, row.outage || 0];
      const total = series.reduce((sum, value) => sum + value, 0);
      if (!total) {
        el.innerHTML = "<div class='text-muted'>No data in range.</div>";
        return;
      }
      const rangeLabel = (stabilityDaysEl ? stabilityDaysEl.selectedOptions[0]?.textContent : "Last 7 days") || "Last 7 days";
      const fullLabel = row.full_label || row.label || "Unnamed ISP";
      const chart = new ApexCharts(el, {
        chart: {
          type: "donut",
          height: 90,
          sparkline: { enabled: true },
        },
        labels: ["Stable", "Unstable", "Critical", "Down"],
        colors: stabilityColors,
        series,
        dataLabels: { enabled: false },
        legend: { show: false },
        stroke: { width: 1 },
        tooltip: {
          enabled: true,
          custom: ({ series, seriesIndex, w }) => {
            const legendRows = w.globals.labels.map((label, idx) => {
              const value = series[idx] || 0;
              const percent = total ? Math.round((value / total) * 100) : 0;
              const color = stabilityColors[idx];
              return `<div class="d-flex align-items-center gap-2">
                <span style="width:8px;height:8px;border-radius:50%;background:${color};display:inline-block;"></span>
                <span>${label} ${percent}%</span>
              </div>`;
            }).join("");
            return `
              <div class="apexcharts-tooltip-title small text-muted ms-1">${rangeLabel}</div>
              <div class="fw-semibold mb-2 ms-1">${escapeHtml(fullLabel)}</div>
              <div class="d-flex flex-column gap-1 small ms-1">${legendRows}</div>
            `;
          },
        },
        plotOptions: {
          pie: {
            donut: {
              size: "70%",
              labels: { show: false },
            },
          },
        },
      });
      chart.render();
      stabilityCharts.set(row.id, chart);
    });
  };

  const fetchStability = async () => {
    if (!stabilityGridEl) return;
    const window = (() => {
      const raw = stabilityDaysEl ? stabilityDaysEl.value : "7d";
      if (raw.endsWith("h")) {
        const hours = parseInt(raw.slice(0, -1), 10);
        return { hours: Number.isNaN(hours) ? 1 : hours };
      }
      if (raw.endsWith("d")) {
        const days = parseInt(raw.slice(0, -1), 10);
        return { days: Number.isNaN(days) ? 7 : days };
      }
      const days = parseInt(raw, 10);
      return { days: Number.isNaN(days) ? 7 : days };
    })();
    const params = new URLSearchParams();
    if (window.hours) {
      params.set("hours", String(window.hours));
    } else {
      params.set("days", String(window.days || 7));
    }
    try {
      const res = await fetch(`/pulsewatch/stability?${params.toString()}`, {
        headers: { "Accept": "application/json" },
        cache: "no-store",
      });
      if (!res.ok) {
        throw new Error("Failed to load stability data");
      }
      const data = await res.json();
      renderStabilityGrid(data.rows || []);
    } catch (err) {
      if (stabilityGridEl) {
        stabilityGridEl.innerHTML = "<div class='text-muted'>Unable to load stability overview.</div>";
      }
    }
  };

  if (stabilityDaysEl) {
    stabilityDaysEl.addEventListener("change", fetchStability);
  }
  fetchStability();

  const statusTab = document.querySelector('a[href="#wan-status"]');
  if (statusTab) {
    statusTab.addEventListener("shown.bs.tab", () => {
      updateChart();
      fetchStatus();
    });
  }

  document.addEventListener("visibilitychange", () => {
    if (document.visibilityState === "visible") {
      fetchStatus();
      updateChart();
    }
  });

  const statusFilterEl = document.getElementById("wan-status-filter");
  const statusSearchEl = document.getElementById("wan-status-search");
  if (statusFilterEl) statusFilterEl.addEventListener("change", applyWanStatusFilters);
  if (statusSearchEl) statusSearchEl.addEventListener("input", applyWanStatusFilters);
  applyWanStatusFilters();
</script>
{% endblock %}
